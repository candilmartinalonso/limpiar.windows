
<#
.SYNOPSIS
  OptiClean-Xtreme v6.0: Script de Optimización y Reparación Extrema.
.DESCRIPTION
  Versión "pegar y ejecutar" inspirada en la minuciosidad de Tron Script.
  Realiza una secuencia de preparación, limpieza profunda, eliminación de bloatware,
  reparación del sistema, ajustes de privacidad y optimización final.
  - MODO AUTOMÁTICO: No requiere intervención.
  - LOG DETALLADO: Informa de cada paso ejecutado.
  - REPARACIÓN INTEGRAL: Ejecuta DISM, SFC, reseteo de red y más.
  - PRIVACIDAD: Aplica ajustes para reducir la telemetría.
.NOTES
  Ejecutar siempre en una terminal de PowerShell como Administrador.
  Se recomienda cerrar todas las aplicaciones antes de ejecutar.
  Versión: 6.0
#>

#region -------------------- [0] Configuración Inicial y Helpers --------------------
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force -ErrorAction SilentlyContinue
$global:totalFreedSpace = 0
$startTime = Get-Date

function Write-Log {
    param([string]$Message, [string]$Color = "White", [int]$Indent = 0)
    $indentation = " " * $Indent
    Write-Host "$indentation[$(Get-Date -f 'HH:mm:ss')] $Message" -ForegroundColor $Color
}

function Write-Section {
    param([string]$Title)
    Write-Host "`n" + ("-"*80)
    Write-Log $Title "Magenta"
    Write-Host ("-"*80)
}

function Require-Admin {
    $identity = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($identity)
    if (-not $principal.IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator)) {
        Write-Error "Este script requiere privilegios de Administrador. Por favor, ejecútalo en una terminal de PowerShell como Administrador." -ErrorAction Stop
    }
}

function Remove-Path-Safe {
    param([string]$Path)
    if (Test-Path -LiteralPath $Path) {
        try {
            Get-ChildItem -LiteralPath $Path -Recurse -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
            Remove-Item -LiteralPath $Path -Recurse -Force -ErrorAction SilentlyContinue
        } catch { Write-Log "No se pudo eliminar completamente: $Path" "DarkYellow" 4 }
    }
}

function Stop-Conflicting-Processes {
    $processes = @("chrome", "msedge", "firefox", "brave", "opera", "winword", "excel", "powerpnt", "outlook", "steam", "epicgameslauncher", "discord", "spotify")
    Write-Log "Cerrando procesos conflictivos para una limpieza efectiva..." "Yellow" 2
    foreach ($proc in $processes) {
        if (Get-Process $proc -ErrorAction SilentlyContinue) {
            Stop-Process -Name $proc -Force -ErrorAction SilentlyContinue
            Write-Log "Proceso cerrado: $proc" "DarkGray" 4
        }
    }
}
#endregion

#region -------------------- [1] Fase de Preparación --------------------
function Stage-Preparation {
    Write-Section "[1] FASE DE PREPARACIÓN"
    
    Write-Log "Verificando privilegios de administrador..." "Cyan" 2
    Require-Admin
    Write-Log "Verificación exitosa." "Green" 4

    Write-Log "Creando punto de restauración del sistema..." "Cyan" 2
    $restorePoint = Checkpoint-Computer -Description "OptiClean-Xtreme v6.0 (Pre-Ejecución)" -RestorePointType "MODIFY_SETTINGS" -ErrorAction SilentlyContinue
    if ($restorePoint) { Write-Log "Punto de restauración creado con éxito." "Green" 4 }
    else { Write-Log "No se pudo crear el punto de restauración (puede estar deshabilitado)." "Yellow" 4 }

    Stop-Conflicting-Processes
}
#endregion

#region -------------------- [2] Fase de Limpieza de Temporales --------------------
function Run-Cleaning-Task {
    param([string]$Name, [scriptblock]$Action, [int]$Indent = 2)
    Write-Log $Name "Cyan" $Indent
    $drive = Get-PSDrive $env:SystemDrive.Substring(0, 1)
    $sizeBefore = $drive.Free
    try { Invoke-Command -ScriptBlock $Action -ErrorAction Stop }
    catch { Write-Log "Error durante la limpieza de '$Name': $_" "Red" ($Indent + 2) }
    $sizeAfter = $drive.Free
    $freed = $sizeAfter - $sizeBefore
    if ($freed -gt 1MB) {
        $freedMB = [math]::Round($freed / 1MB, 2)
        $global:totalFreedSpace += $freed
        Write-Log "-> Liberado: $freedMB MB" "Green" ($Indent + 2)
    }
}

function Stage-Clean {
    Write-Section "[2] FASE DE LIMPIEZA DE TEMPORALES"

    Run-Cleaning-Task "Temporales de Sistema y Usuarios" {
        Remove-Path-Safe "$env:windir\Temp\*"
        Remove-Path-Safe "$env:TEMP\*"
        Get-ChildItem -Path "$env:SystemDrive\Users" -Directory -ErrorAction SilentlyContinue | ForEach-Object {
            Remove-Path-Safe (Join-Path $_.FullName "AppData\Local\Temp\*")
        }
    }
    
    Run-Cleaning-Task "Papelera de Reciclaje" { Clear-RecycleBin -Force -ErrorAction SilentlyContinue }
    
    Run-Cleaning-Task "Cachés de Navegadores (Todos los perfiles)" {
        $browserPaths = @{
            "Edge" = "AppData\Local\Microsoft\Edge\User Data"; "Chrome" = "AppData\Local\Google\Chrome\User Data"
            "Firefox" = "AppData\Roaming\Mozilla\Firefox\Profiles"; "Brave" = "AppData\Local\BraveSoftware\Brave-Browser\User Data"
        }
        Get-ChildItem -Path "$env:SystemDrive\Users" -Directory -ErrorAction SilentlyContinue | ForEach-Object {
            $userProfile = $_.FullName
            foreach ($browser in $browserPaths.Keys) {
                $path = Join-Path $userProfile $browserPaths[$browser]
                if (Test-Path $path) {
                    Get-ChildItem -Path $path -Directory -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.Name -in @('Cache', 'Code Cache', 'GPUCache', 'cache2', 'startupCache') } | ForEach-Object {
                        Remove-Path-Safe $_.FullName
                    }
                }
            }
        }
    }

    Run-Cleaning-Task "Cachés de Aplicaciones (Discord, Steam, etc.)" {
        $appPaths = @(
            "$env:LOCALAPPDATA\Discord", "$env:LOCALAPPDATA\Spotify\Browser", "$env:LOCALAPPDATA\EpicGamesLauncher\Saved\webcache",
            "$env:ProgramFiles (x86)\Steam\appcache", "$env:ProgramFiles (x86)\Steam\config\htmlcache"
        )
        foreach ($path in $appPaths) {
            Get-ChildItem -Path $path -Directory -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.Name -in @('Cache', 'Code Cache', 'GPUCache') } | ForEach-Object {
                Remove-Path-Safe $_.FullName
            }
        }
    }

    Run-Cleaning-Task "Cachés de Shaders (NVIDIA/AMD/DX)" {
        Remove-Path-Safe "$env:LOCALAPPDATA\NVIDIA\GLCache"
        Remove-Path-Safe "$env:ProgramData\NVIDIA Corporation\NV_Cache"
        Remove-Path-Safe "$env:LOCALAPPDATA\D3DShaderCache"
        Remove-Path-Safe "$env:LOCALAPPDATA\AMD\DxCache"
    }
    
    Run-Cleaning-Task "Restos de Windows Update" {
        Stop-Service -Name "wuauserv", "bits" -Force -ErrorAction SilentlyContinue
        Remove-Path-Safe "$env:windir\SoftwareDistribution\Download\*"
        Start-Service -Name "wuauserv", "bits" -ErrorAction SilentlyContinue
    }

    Run-Cleaning-Task "Informes de Errores y Dumps" {
        Remove-Path-Safe "$env:windir\Minidump\*"
        Remove-Path-Safe "$env:ProgramData\Microsoft\Windows\WER\*"
        Remove-Item "$env:SystemDrive\MEMORY.DMP" -Force -ErrorAction SilentlyContinue
    }
    
    Run-Cleaning-Task "Logs Obsoletos y Diagnósticos" {
        Remove-Item "$env:windir\Logs\CBS\*.log", "$env:windir\Logs\CBS\*.cab" -Force -ErrorAction SilentlyContinue
        wevtutil cl "Windows PowerShell" | Out-Null
        wevtutil cl "Application" | Out-Null
        wevtutil cl "System" | Out-Null
    }
    
    Run-Cleaning-Task "Caché de Miniaturas e Iconos" {
        Stop-Process -Name explorer -Force -ErrorAction SilentlyContinue
        Remove-Item "$env:LOCALAPPDATA\Microsoft\Windows\Explorer\thumbcache_*.db" -Force -ErrorAction SilentlyContinue
        Remove-Item "$env:LOCALAPPDATA\IconCache.db" -Force -ErrorAction SilentlyContinue
        Start-Process explorer
    }
}
#endregion

#region -------------------- [3] Fase de Eliminación de Bloatware --------------------
function Stage-Debloat {
    Write-Section "[3] FASE DE ELIMINACIÓN DE BLOATWARE"
    
    $bloatware = @(
        # Communication & Social
        "Microsoft.Messaging", "Microsoft.People", "Microsoft.SkypeApp", "Microsoft.YourPhone",
        # Media & Entertainment
        "Microsoft.MicrosoftSolitaireCollection", "Microsoft.MixedReality.Portal", "Microsoft.ZuneMusic", "Microsoft.ZuneVideo",
        "Microsoft.WindowsSoundRecorder", "Microsoft.WindowsCamera",
        # News & Info
        "Microsoft.BingNews", "Microsoft.BingWeather", "Microsoft.GetHelp", "Microsoft.Getstarted", "Microsoft.WindowsFeedbackHub",
        # 3D & Office
        "Microsoft.Microsoft3DViewer", "Microsoft.Office.OneNote", "Microsoft.MicrosoftOfficeHub", "Microsoft.Print3D",
        # Other
        "Microsoft.549981C3F5F10", "Microsoft.Wallet", "Microsoft.WindowsAlarms", "Microsoft.WindowsMaps"
    )
    
    Write-Log "Buscando Bloatware (aplicaciones preinstaladas)..." "Cyan" 2
    $appsToRemove = Get-AppxPackage -AllUsers | Where-Object { $bloatware -contains $_.Name }
    $provisionedToRemove = Get-AppxProvisionedPackage -Online | Where-Object { $bloatware -contains $_.DisplayName }

    if ($appsToRemove.Count -eq 0 -and $provisionedToRemove.Count -eq 0) {
        Write-Log "No se encontró bloatware de la lista para eliminar." "Green" 4
        return
    }

    Write-Log "Eliminando Bloatware (Apps de Usuario):" "Yellow" 2
    $appsToRemove | ForEach-Object {
        Write-Log "Quitando: $($_.Name)" "DarkGray" 4
        $_ | Remove-AppxPackage -AllUsers -ErrorAction SilentlyContinue
    }
    
    Write-Log "Eliminando Bloatware (Apps Preinstaladas para nuevos usuarios):" "Yellow" 2
    $provisionedToRemove | ForEach-Object {
        Write-Log "Quitando provisión: $($_.DisplayName)" "DarkGray" 4
        $_ | Remove-AppxProvisionedPackage -Online -ErrorAction SilentlyContinue
    }
    
    Write-Log "Desinstalación de bloatware completada." "Green" 2
}
#endregion

#region -------------------- [4] Fase de Reparaciones y Ajustes --------------------
function Stage-Repair {
    Write-Section "[4] FASE DE REPARACIONES Y AJUSTES"

    Write-Log "Reparando integridad de archivos del sistema (SFC)..." "Cyan" 2
    try { sfc.exe /scannow | Out-Null } catch {}
    Write-Log "SFC completado." "Green" 4

    Write-Log "Reparando imagen del sistema (DISM)... Esto puede tardar." "Cyan" 2
    try { Dism.exe /Online /Cleanup-Image /RestoreHealth | Out-Null } catch {}
    Write-Log "DISM completado." "Green" 4
    
    Write-Log "Reparando la Pila de Red (TCP/IP, Winsock, DNS)..." "Cyan" 2
    netsh winsock reset | Out-Null
    netsh int ip reset | Out-Null
    ipconfig /flushdns | Out-Null
    Write-Log "Pila de red reseteada." "Green" 4

    Write-Log "Reparando componentes de Windows Update..." "Cyan" 2
    Stop-Service -Name "wuauserv", "bits", "cryptSvc", "msiserver" -Force -ErrorAction SilentlyContinue
    try {
        Rename-Item -Path "$env:windir\SoftwareDistribution" -NewName "SoftwareDistribution.old" -Force -ErrorAction Stop
        Rename-Item -Path "$env:windir\System32\catroot2" -NewName "catroot2.old" -Force -ErrorAction Stop
        Write-Log "Cachés de Windows Update renombradas." "Green" 4
    } catch {
        Write-Log "No se pudieron renombrar las cachés de WU (puede que no existan o estén en uso)." "Yellow" 4
    }
    Start-Service -Name "wuauserv", "bits", "cryptSvc", "msiserver" -ErrorAction SilentlyContinue
    
    Write-Log "Reparando asociaciones de archivos críticas (.exe, .lnk)..." "Cyan" 2
    $regContent = @"
Windows Registry Editor Version 5.00

[-HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.exe]
[HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.exe]
[HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.exe\OpenWithProgids]
"exefile"=hex(0):

[HKEY_CLASSES_ROOT\exefile\shell\open\command]
@="\"%1\" %*"
"@
    $regContent | Set-Content -Path "$env:TEMP\fixexe.reg" -Force
    reg import "$env:TEMP\fixexe.reg" | Out-Null
    Remove-Item "$env:TEMP\fixexe.reg" -Force
    Write-Log "Asociaciones reparadas." "Green" 4
    
    Write-Log "Restaurando archivo HOSTS a su estado por defecto..." "Cyan" 2
    $hostsContent = @"
# Copyright (c) 1993-2009 Microsoft Corp.
#
# This is a sample HOSTS file used by Microsoft TCP/IP for Windows.
#
# This file contains the mappings of IP addresses to host names. Each
# entry should be kept on an individual line. The IP address should
# be placed in the first column followed by the corresponding host name.
# The IP address and the host name should be separated by at least one
# space.
#
# Additionally, comments (such as these) may be inserted on individual
# lines or following the machine name denoted by a '#' symbol.
#
# For example:
#
#      102.54.94.97     rhino.acme.com          # source server
#       38.25.63.10     x.acme.com              # x client host

# localhost name resolution is handle within DNS itself.
#       127.0.0.1       localhost
#       ::1             localhost
"@
    try {
        Set-Content -Path "$env:windir\System32\drivers\etc\hosts" -Value $hostsContent -Force -Encoding ASCII
        Write-Log "Archivo HOSTS restaurado." "Green" 4
    } catch {
        Write-Log "No se pudo restaurar el archivo HOSTS." "Red" 4
    }
}
#endregion

#region -------------------- [5] Fase de Privacidad y Telemetría --------------------
function Stage-Privacy {
    Write-Section "[5] FASE DE PRIVACIDAD Y TELEMETRÍA"

    Write-Log "Deshabilitando servicios de telemetría..." "Cyan" 2
    $telemetryServices = @("DiagTrack", "dmwappushservice", "diagsvc")
    foreach ($svc in $telemetryServices) {
        try {
            Set-Service -Name $svc -StartupType Disabled -ErrorAction Stop
            Stop-Service -Name $svc -Force -ErrorAction SilentlyContinue
            Write-Log "Servicio deshabilitado: $svc" "DarkGray" 4
        } catch {}
    }

    Write-Log "Deshabilitando tareas programadas de telemetría..." "Cyan" 2
    $telemetryTasks = @(
        "\Microsoft\Windows\Application Experience\Microsoft Compatibility Appraiser",
        "\Microsoft\Windows\Application Experience\ProgramDataUpdater",
        "\Microsoft\Windows\Customer Experience Improvement Program\Consolidator",
        "\Microsoft\Windows\Customer Experience Improvement Program\KernelCeipTask",
        "\Microsoft\Windows\Autochk\Proxy",
        "\Microsoft\Windows\PI\Sqm-Tasks"
    )
    foreach ($taskPath in $telemetryTasks) {
        try {
            Get-ScheduledTask -TaskPath ($taskPath.Substring(0, $taskPath.LastIndexOf('\'))) -TaskName ($taskPath.Split('\')[-1]) -ErrorAction Stop | Disable-ScheduledTask -ErrorAction Stop
            Write-Log "Tarea deshabilitada: $taskPath" "DarkGray" 4
        } catch {}
    }

    Write-Log "Aplicando ajustes de registro para reducir telemetría..." "Cyan" 2
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection" -Name "AllowTelemetry" -Value 0 -Type DWord -Force -ErrorAction SilentlyContinue
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\DataCollection" -Name "AllowTelemetry" -Value 0 -Type DWord -Force -ErrorAction SilentlyContinue
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\WMI\AutoLogger\AutoLogger-Diagtrack-Listener" -Name "Start" -Value 0 -Type DWord -Force -ErrorAction SilentlyContinue
    Write-Log "Ajustes de registro aplicados." "Green" 4
}
#endregion

#region -------------------- [6] Fase de Optimización --------------------
function Stage-Optimize {
    Write-Section "[6] FASE DE OPTIMIZACIÓN"

    Write-Log "Aplicando plan de energía de 'Máximo Rendimiento'..." "Cyan" 2
    try {
        powercfg -duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61 | Out-Null
        powercfg -setactive e9a42b02-d5df-448d-aa00-03f14749eb61
        Write-Log "Plan de energía establecido." "Green" 4
    } catch { Write-Log "No se pudo establecer el plan de energía." "Yellow" 4 }
    
    Write-Log "Deshabilitando hibernación para liberar espacio..." "Cyan" 2
    powercfg -h off
    
    Write-Log "Ajustando efectos visuales para máximo rendimiento..." "Cyan" 2
    Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" -Name "VisualFXSetting" -Value 2 -Type DWord -Force
    
    Write-Log "Deshabilitando SysMain (Superfetch)..." "Cyan" 2
    try { Set-Service -Name "SysMain" -StartupType Disabled -ErrorAction Stop; Stop-Service -Name "SysMain" -Force -ErrorAction SilentlyContinue } catch {}

    Write-Log "Optimizando unidades (TRIM/Defrag)..." "Cyan" 2
    Get-Volume | Where-Object { $_.DriveType -eq 'Fixed' -and $_.FileSystem -in @('NTFS', 'ReFS') } | ForEach-Object {
        $driveLetter = $_.DriveLetter
        $mediaType = (Get-PhysicalDisk | Where-Object { $_.DeviceID -eq (Get-Partition | Where-Object { $_.DriveLetter -eq $driveLetter }).DiskNumber.ToString() }).MediaType
        if ($mediaType -eq 'SSD') {
            Write-Log "Optimizando (TRIM) unidad $driveLetter`:..." "DarkGray" 4
            Optimize-Volume -DriveLetter $driveLetter -ReTrim -Verbose -ErrorAction SilentlyContinue
        } else {
            Write-Log "Optimizando (Defrag) unidad $driveLetter`:..." "DarkGray" 4
            Optimize-Volume -DriveLetter $driveLetter -Defrag -Verbose -ErrorAction SilentlyContinue
        }
    }
    Write-Log "Optimización de unidades completada." "Green" 2
}
#endregion

#region -------------------- [7] Lógica Principal de Ejecución --------------------
function Main {
    Write-Host "`n"
    Write-Host "================================================================================" -ForegroundColor "White"
    Write-Host "                INICIANDO OPTICLEAN-XTREME v6.0 (MODO AUTOMÁTICO)               " -ForegroundColor "White"
    Write-Host "================================================================================" -ForegroundColor "White"
    
    # Ejecutar todas las fases en orden
    Stage-Preparation
    Stage-Clean
    Stage-Debloat
    Stage-Repair
    Stage-Privacy
    Stage-Optimize

    # --- Finalización ---
    Write-Section "[7] REPORTE FINAL"
    $totalGB = [math]::Round($global:totalFreedSpace / 1GB, 3)
    $elapsed = [math]::Round((New-TimeSpan -Start $startTime).TotalMinutes, 1)
    Write-Log "Espacio total liberado en esta sesión: $totalGB GB (aprox.)" "Green" 2
    Write-Log "Tiempo total de ejecución: $elapsed minutos." "Green" 2
    Write-Host "--------------------------------------------------------------------------------" -ForegroundColor "White"
    Write-Log "OptiClean-Xtreme v6.0 ha finalizado. Se recomienda reiniciar el sistema." "Green"
    Write-Host "================================================================================" -ForegroundColor "White"
}

# Iniciar la ejecución
Main
#endregion
                
