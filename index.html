<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptiClean-Ultra v5.5 - Script Automático</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        pre code {
            font-family: 'Fira Code', monospace;
        }
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300 antialiased">

    <div class="container mx-auto max-w-4xl px-4 py-8 md:py-12">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">OptiClean-Ultra v5.5</h1>
            <p class="text-slate-400">Script Totalmente Automático: Copiar, Pegar y Ejecutar</p>
        </header>

        <!-- Main Content -->
        <main class="bg-slate-800 rounded-xl shadow-2xl overflow-hidden">
            <div class="flex justify-between items-center p-4 bg-slate-900/50 border-b border-slate-700">
                <h2 class="text-lg font-semibold text-white">PowerShell Script</h2>
                <button id="copyButton" class="flex items-center gap-2 bg-sky-600 hover:bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-opacity-75">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
                        <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                    </svg>
                    <span id="copyButtonText">Copiar Script</span>
                </button>
            </div>

            <!-- Code Block -->
            <div class="max-h-[60vh] overflow-y-auto">
                <pre><code id="scriptContent" class="language-powershell block text-sm p-4 md:p-6 text-slate-300">
&lt;#
.SYNOPSIS
  OptiClean-Ultra v5.5: Script Totalmente Automático.
.DESCRIPTION
  Versión "pegar y ejecutar". Realiza todas las optimizaciones y limpiezas de forma automática sin necesidad de parámetros.
  - Aplica el perfil de MÁXIMO RENDIMIENTO.
  - Ejecuta TODAS las limpiezas (sistema, apps, navegadores, drivers, restos, bloatware).
  - Realiza mantenimiento profundo (DISM & SFC).
  - Optimiza red, deshabilita tareas de telemetría y optimiza discos.
  - Muestra un reporte final del espacio liberado.
.NOTES
  Ejecutar siempre como Administrador.
  Versión: 5.5
#&gt;

#region -------------------- Configuración Inicial y Helpers --------------------
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force -ErrorAction SilentlyContinue

function Require-Admin {
    $identity = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($identity)
    if (-not $principal.IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator)) {
        Write-Error "Este script requiere privilegios de Administrador. Por favor, ejecútalo en una terminal de PowerShell como Administrador." -ErrorAction Stop
    }
}

function Write-Log {
    param([string]$Message, [string]$Color = "White")
    Write-Host "[$(Get-Date -f 'HH:mm:ss')] $Message" -ForegroundColor $Color
}

function Now-Tag { return ("{0:yyyyMMdd-HHmmss}" -f (Get-Date)) }
function Remove-Path-Safe {
    param([string]$Path)
    if (Test-Path -LiteralPath $Path) {
        try {
            # Grant Administrators full control
            Icacls.exe "$Path" /grant *S-1-5-32-544:F /T /C /Q | Out-Null
        } catch {}
        try {
            Remove-Item -LiteralPath $Path -Recurse -Force -ErrorAction SilentlyContinue
        } catch {}
    }
}
function Empty-Folder {
    param([string]$Path)
    if (Test-Path -LiteralPath $Path) {
        try { Get-ChildItem -LiteralPath $Path -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue } catch {}
    }
}
function Manage-Service {
    param([string[]]$Names, [ValidateSet("Stop", "Start")] [string]$Action)
    foreach ($name in $Names) {
        try {
            if ($Action -eq "Stop") { Stop-Service -Name $name -Force -ErrorAction SilentlyContinue }
            if ($Action -eq "Start") { Start-Service -Name $name -ErrorAction SilentlyContinue }
        } catch {}
    }
}
#endregion

#region -------------------- Sistema de Backup y Reversión --------------------
$stateDir = Join-Path $env:ProgramData "OptiCleanUltra"
$backupFile = Join-Path $stateDir "backup_v5.5.json"
$totalFreedSpace = 0

function Load-Backup {
    if (-not (Test-Path $stateDir)) { New-Item -ItemType Directory -Force -Path $stateDir | Out-Null }
    if (Test-Path $backupFile) {
        try { return Get-Content $backupFile -Encoding UTF8 | ConvertFrom-Json } catch { }
    }
    return [pscustomobject]@{
        PowerPlanGUID = $null; Registry = @{}; Services = @{}; Tasks = @{};
        HibernateWasOn= $null; Timestamp = (Get-Date); Version = "5.5"
    }
}

function Save-Backup($backup) {
    $backup | ConvertTo-Json -Depth 8 | Set-Content -Path $backupFile -Encoding UTF8
}

function Set-Registry-Backup {
    param([string]$Path, [string]$Name, $Value, [string]$Type = "DWord", [ref]$BackupObj)
    try {
        if (-not (Test-Path $Path)) { New-Item -Path $Path -Force | Out-Null }
        $bk = $BackupObj.Value
        if (-not $bk.Registry.ContainsKey($Path)) { $bk.Registry[$Path] = @{} }
        if (-not $bk.Registry[$Path].ContainsKey($Name)) {
            try {
                $bk.Registry[$Path][$Name] = @{
                    Value = (Get-ItemProperty -Path $Path -Name $Name -ErrorAction Stop).$Name
                    Type  = (Get-Item -Path $Path).GetValueKind($Name)
                }
            } catch { $bk.Registry[$Path][$Name] = $null }
        }
        Set-ItemProperty -Path $Path -Name $Name -Value $Value -Type $Type -Force -ErrorAction Stop
    } catch { Write-Warning "No se pudo ajustar el registro: $Path\$Name" }
}

function Set-Service-Backup {
    param([string]$Name, [string]$StartupType, [switch]$StopNow, [ref]$BackupObj)
    try {
        $svc = Get-Service -Name $Name -ErrorAction Stop
        $bk = $BackupObj.Value
        if (-not $bk.Services.ContainsKey($Name)) {
            $bk.Services[$Name] = @{
                StartType  = (Get-CimInstance -ClassName Win32_Service -Filter "Name='$Name'").StartMode
                WasRunning = ($svc.Status -eq 'Running')
            }
        }
        if ($StartupType) { Set-Service -Name $Name -StartupType $StartupType -ErrorAction Stop }
        if ($StopNow -and $svc.Status -eq 'Running') { Stop-Service -Name $Name -Force -ErrorAction SilentlyContinue }
    } catch { Write-Warning "No se pudo ajustar el servicio: $Name" }
}

function Set-Task-Backup {
    param([string]$Path, [ref]$BackupObj)
    try {
        $task = Get-ScheduledTask -TaskPath $Path -ErrorAction Stop
        $bk = $BackupObj.Value
        if (-not $bk.Tasks.ContainsKey($Path)) {
            $bk.Tasks[$Path] = ($task.State -eq 'Ready' -or $task.State -eq 'Running')
        }
        if ($task.State -ne 'Disabled') {
            Disable-ScheduledTask -TaskPath $Path -ErrorAction Stop
        }
    } catch { # Silently fail if task cannot be disabled
    }
}
#endregion

#region -------------------- Funciones de Optimización --------------------
function Apply-Performance-Visuals {
    param([ref]$BackupObj)
    Write-Log "Ajustando efectos visuales para máximo rendimiento..." "Cyan"
    Set-Registry-Backup "HKCU:\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" "EnableTransparency" 0 "DWord" $BackupObj
    Set-Registry-Backup "HKCU:\Control Panel\Desktop\WindowMetrics" "MinAnimate" "0" "String" $BackupObj
    Set-Registry-Backup "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" "VisualFXSetting" 3 "DWord" $BackupObj
    Set-Registry-Backup "HKCU:\Software\Microsoft\Windows\DWM" "EnableAeroPeek" 0 "DWord" $BackupObj
}

function Apply-Aggressive-Tweaks {
    param([ref]$BackupObj)
    Write-Log "Aplicando optimizaciones agresivas (SysMain, Prefetch, Hibernación)..." "Yellow"
    Set-Service-Backup "SysMain" "Disabled" -StopNow $BackupObj
    Set-Registry-Backup "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management\PrefetchParameters" "EnablePrefetcher" 0 "DWord" $BackupObj
    Set-Registry-Backup "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" "NtfsDisableLastAccessUpdate" 1 "DWord" $BackupObj
    if ($BackupObj.Value.HibernateWasOn -eq $null) { $BackupObj.Value.HibernateWasOn = (powercfg -a | Select-String "La hibernación no se ha habilitado").Length -eq 0 }
    powercfg -h off
}

function Apply-Gamer-Tweaks {
    param([ref]$BackupObj)
    Write-Log "Aplicando optimizaciones para Gaming..." "Cyan"
    Set-Registry-Backup "HKCU:\Software\Microsoft\GameBar" "AutoGameModeEnabled" 1 "DWord" $BackupObj
    Set-Registry-Backup "HKCU:\Software\Microsoft\GameBar" "ShowStartupPanel" 0 "DWord" $BackupObj
    Set-Registry-Backup "HKCU:\Software\Microsoft\Windows\CurrentVersion\GameDVR" "AppCaptureEnabled" 0 "DWord" $BackupObj
    Set-Registry-Backup "HKCU:\System\GameConfigStore" "GameDVR_Enabled" 0 "DWord" $BackupObj
    Set-Registry-Backup "HKLM:\SYSTEM\CurrentControlSet\Control\GraphicsDrivers" "HwSchMode" 2 "DWord" $BackupObj
    Set-Registry-Backup "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile\Tasks\Games" "GPU Priority" 8 "DWord" $BackupObj
    Set-Registry-Backup "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile\Tasks\Games" "Priority" 6 "DWord" $BackupObj
}

function Apply-Network-Tweaks {
    param([ref]$BackupObj)
    Write-Log "Optimizando configuración de red para baja latencia..." "Yellow"
    $interfaces = Get-NetAdapter | ForEach-Object { $_.InterfaceIndex }
    foreach ($iface in $interfaces) {
        $path = "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces\$(Get-NetIPInterface -InterfaceIndex $iface | Select-Object -ExpandProperty InterfaceAlias)"
        Set-Registry-Backup $path "TcpAckFrequency" 1 "DWord" $BackupObj
        Set-Registry-Backup $path "TCPNoDelay" 1 "DWord" $BackupObj
    }
    Set-Registry-Backup "HKLM:\SOFTWARE\Microsoft\MSMQ\Parameters" "TCPNoDelay" 1 "DWord" $BackupObj
    netsh int tcp set global congestionprovider=ctcp | Out-Null
    netsh int tcp set global autotuninglevel=normal | Out-Null
}

function Apply-Disable-Scheduled-Tasks {
    param([ref]$BackupObj)
    Write-Log "Deshabilitando tareas programadas de telemetría y mantenimiento no esencial..." "Yellow"
    $tasksToDisable = @(
        "\Microsoft\Windows\Application Experience\Microsoft Compatibility Appraiser",
        "\Microsoft\Windows\Application Experience\ProgramDataUpdater",
        "\Microsoft\Windows\Customer Experience Improvement Program\Consolidator",
        "\Microsoft\Windows\Customer Experience Improvement Program\KernelCeipTask",
        "\Microsoft\Windows\DiskDiagnostic\Microsoft-Windows-DiskDiagnosticDataCollector",
        "\Microsoft\Windows\Windows Error Reporting\QueueReporting"
    )
    foreach ($task in $tasksToDisable) {
        Set-Task-Backup $task $BackupObj
    }
}
#endregion

#region -------------------- Funciones de Limpieza --------------------
function Run-Cleaning-Task {
    param([string]$Name, [scriptblock]$Action)
    Write-Log "Ejecutando limpieza: $Name..." "Cyan"
    $drive = Get-PSDrive $env:SystemDrive.Substring(0, 1)
    $sizeBefore = $drive.Free
    try {
        Invoke-Command -ScriptBlock $Action
    } catch {
        Write-Warning "Error durante la limpieza de '$Name': $_"
    }
    $sizeAfter = $drive.Free
    $freed = $sizeAfter - $sizeBefore
    if ($freed -gt 512) { # Report only if more than 512 bytes freed
        $freedGB = [math]::Round($freed / 1GB, 3)
        $script:totalFreedSpace += $freed
        Write-Log " -> Liberado en '$Name': $freedGB GB" "Green"
    }
}

function Clean-System {
    Run-Cleaning-Task "Archivos Temporales del Sistema y Usuarios" {
        Get-ChildItem -Path $env:windir\temp, $env:temp -Recurse -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        Get-ChildItem -Path "$env:SystemDrive\Users" -Directory -ErrorAction SilentlyContinue | ForEach-Object {
            $userTemp = Join-Path $_.FullName "AppData\Local\Temp"
            if (Test-Path $userTemp) { Empty-Folder $userTemp }
        }
    }
    Run-Cleaning-Task "Papelera de Reciclaje" { Clear-RecycleBin -Force -ErrorAction SilentlyContinue }
    Run-Cleaning-Task "Caché de Delivery Optimization" { Manage-Service "DoSvc" "Stop"; Empty-Folder "$env:ProgramData\Microsoft\Windows\DeliveryOptimization\Cache"; Manage-Service "DoSvc" "Start" }
    Run-Cleaning-Task "Descargas de Windows Update" { Manage-Service @("wuauserv", "bits") "Stop"; Empty-Folder "$env:windir\SoftwareDistribution\Download"; Manage-Service @("wuauserv", "bits") "Start" }
    Run-Cleaning-Task "Cachés de Iconos y Miniaturas" {
        $thumbDir = "$env:LOCALAPPDATA\Microsoft\Windows\Explorer"
        Get-ChildItem -Path $thumbDir -Filter "thumbcache*.db" -Force -ErrorAction SilentlyContinue | Remove-Item -Force
        Stop-Process -Name explorer -Force -ErrorAction SilentlyContinue
        Remove-Item "$env:LOCALAPPDATA\IconCache.db" -Force -ErrorAction SilentlyContinue
        Start-Process explorer
    }
    Run-Cleaning-Task "Informes de Errores y Dumps" {
        Remove-Path-Safe "$env:windir\Minidump"; Remove-Path-Safe "$env:ProgramData\Microsoft\Windows\WER"
        Remove-Item "$env:SystemDrive\MEMORY.DMP" -Force -ErrorAction SilentlyContinue
    }
    Run-Cleaning-Task "Logs de CBS" { Remove-Item "$env:windir\Logs\CBS\*.log", "$env:windir\Logs\CBS\*.cab" -Force -ErrorAction SilentlyContinue }
    Run-Cleaning-Task "Caché de DNS" { ipconfig /flushdns | Out-Null }
    Run-Cleaning-Task "Caché de Fuentes" { Manage-Service "FontCache" "Stop"; Remove-Item "$env:windir\ServiceProfiles\LocalService\AppData\Local\FontCache\*" -Recurse -Force -ErrorAction SilentlyContinue; Manage-Service "FontCache" "Start" }
    Run-Cleaning-Task "Caché de Microsoft Store" { try { Start-Process "wsreset.exe" -ArgumentList "-s" -Wait -WindowStyle Hidden -ErrorAction Stop } catch {} }
    Run-Cleaning-Task "Archivos de Prefetch" { Empty-Folder "$env:windir\Prefetch" }
}

function Clean-Browsers-All {
    Run-Cleaning-Task "Cachés de Navegadores (Todos los perfiles)" {
        $browserPaths = @{
            "Edge" = "AppData\Local\Microsoft\Edge\User Data"; "Chrome" = "AppData\Local\Google\Chrome\User Data"
            "Firefox" = "AppData\Roaming\Mozilla\Firefox\Profiles"; "Brave" = "AppData\Local\BraveSoftware\Brave-Browser\User Data"
            "Opera" = "AppData\Roaming\Opera Software\Opera Stable"
        }
        Get-ChildItem -Path "$env:SystemDrive\Users" -Directory -ErrorAction SilentlyContinue | ForEach-Object {
            $userProfile = $_.FullName
            foreach ($browser in $browserPaths.Keys) {
                $path = Join-Path $userProfile $browserPaths[$browser]
                if (Test-Path $path) {
                    if ($browser -eq "Firefox") {
                        Get-ChildItem -Path $path -Directory -ErrorAction SilentlyContinue | ForEach-Object {
                            Remove-Path-Safe (Join-Path $_.FullName "cache2"); Remove-Path-Safe (Join-Path $_.FullName "startupCache")
                        }
                    } else {
                        Get-ChildItem -Path $path -Directory -ErrorAction SilentlyContinue | Where-Object { $_.Name -eq 'Default' -or $_.Name -like 'Profile *' } | ForEach-Object {
                            $profileDir = Join-Path $path $_.Name
                            Remove-Path-Safe (Join-Path $profileDir "Cache"); Remove-Path-Safe (Join-Path $profileDir "Code Cache"); Remove-Path-Safe (Join-Path $profileDir "GPUCache")
                        }
                    }
                }
            }
        }
    }
}

function Clean-Apps-All {
    Run-Cleaning-Task "Cachés de Aplicaciones" {
        $appPaths = @(
            "$env:LOCALAPPDATA\Discord\Cache", "$env:LOCALAPPDATA\Discord\Code Cache", "$env:LOCALAPPDATA\Discord\GPUCache",
            "$env:LOCALAPPDATA\Spotify\Browser\Cache", "$env:LOCALAPPDATA\Spotify\Browser\Code Cache", "$env:LOCALAPPDATA\Spotify\Browser\GPUCache",
            "$env:LOCALAPPDATA\EpicGamesLauncher\Saved\webcache", "$env:ProgramFiles (x86)\Steam\appcache",
            "$env:ProgramFiles (x86)\Steam\config\htmlcache", "$env:ProgramFiles (x86)\Steam\config\steamui\css", "$env:ProgramFiles (x86)\Steam\config\steamui\js"
        )
        foreach ($path in $appPaths) { if (Test-Path $path) { Remove-Path-Safe $path } }
    }
}

function Clean-Gpu-Caches {
    Run-Cleaning-Task "Cachés de Shaders (NVIDIA/DX/GL)" {
        Remove-Path-Safe "$env:LOCALAPPDATA\NVIDIA\GLCache"; Remove-Path-Safe "$env:ProgramData\NVIDIA Corporation\Drs"
        Remove-Path-Safe "$env:LOCALAPPDATA\D3DShaderCache"; Remove-Path-Safe "$env:LOCALAPPDATA\AMD\DxCache"
    }
}

function Clean-Application-Leftovers {
    Run-Cleaning-Task "Restos de Aplicaciones Desinstaladas" {
        $excludedFolders = @(
            'Archivos comunes', 'Common Files', 'Internet Explorer', 'ModifiableWindowsApps', 'Uninstall Information',
            'Datos de programa', 'Documentos', 'Escritorio', 'Menú Inicio', 'Plantillas', 'Application Data',
            'Documents', 'Desktop', 'Start Menu', 'Templates'
        )
        $pathsToClean = @("$env:ProgramFiles", "$env:ProgramFiles (x86)", "$env:ProgramData", "$env:LOCALAPPDATA", "$env:APPDATA")
        foreach ($path in $pathsToClean) {
            Get-ChildItem -Path $path -Directory -Force -ErrorAction SilentlyContinue | ForEach-Object {
                if ($_.Name -in $excludedFolders) { return }
                if (-not @(Get-ChildItem -Path $_.FullName -Recurse -Force -ErrorAction SilentlyContinue)) {
                    Write-Log " -> Eliminando carpeta vacía: $($_.FullName)" "Yellow"
                    Remove-Path-Safe $_.FullName
                }
            }
        }
    }
}

function Remove-Safe-Bloatware {
    Write-Log "Buscando Bloatware (aplicaciones preinstaladas)..." "Cyan"
    $bloatware = @(
        "Microsoft.549981C3F5F10", "Microsoft.BingNews", "Microsoft.BingWeather", "Microsoft.GetHelp", "Microsoft.Getstarted",
        "Microsoft.Messaging", "Microsoft.Microsoft3DViewer", "Microsoft.MicrosoftOfficeHub", "Microsoft.MicrosoftSolitaireCollection",
        "Microsoft.MixedReality.Portal", "Microsoft.Office.OneNote", "Microsoft.OneConnect", "Microsoft.People", "Microsoft.Print3D",
        "Microsoft.SkypeApp", "Microsoft.Wallet", "Microsoft.WindowsAlarms", "Microsoft.WindowsCamera", "Microsoft.WindowsFeedbackHub",
        "Microsoft.WindowsMaps", "Microsoft.YourPhone", "Microsoft.ZuneMusic", "Microsoft.ZuneVideo"
    )
    $appsToRemove = Get-AppxPackage | Where-Object { $bloatware -contains $_.Name }
    if ($appsToRemove.Count -eq 0) {
        Write-Log "No se encontró bloatware de la lista para eliminar." "Green"
        return
    }
    Write-Log "Eliminando automáticamente el siguiente bloatware:" "Red"
    $appsToRemove | ForEach-Object { Write-Host (" - " + $_.Name) }
    $appsToRemove | Remove-AppxPackage -ErrorAction SilentlyContinue
    Write-Log "Eliminación de bloatware completada." "Green"
}
#endregion

#region -------------------- Lógica Principal de Ejecución --------------------
Require-Admin
$bk = Load-Backup

Write-Log "--- INICIANDO OPTICLEAN-ULTRA v5.5 (MODO AUTOMÁTICO) ---" "White"

# --- Punto de restauración ---
Write-Log "Creando punto de restauración del sistema..." "Yellow"
Checkpoint-Computer -Description "OptiClean-Ultra v5.5 (Pre-Ejecución)" -RestorePointType "MODIFY_SETTINGS" -ErrorAction SilentlyContinue

# --- Optimización ---
Write-Log "Aplicando perfil de MÁXIMO RENDIMIENTO..." "Green"
if ($null -eq $bk.PowerPlanGUID) { $bk.PowerPlanGUID = (powercfg -getactivescheme).Split(' ')[3] }
try { powercfg -duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61 | Out-Null } catch {}
try { powercfg -setactive e9a42b02-d5df-448d-aa00-03f14749eb61 } catch {}
try { powercfg -setacvalueindex SCHEME_CURRENT SUB_PROCESSOR PROCTHROTTLEMIN 100 | Out-Null } catch {}
try { powercfg -setacvalueindex SCHEME_CURRENT SUB_PROCESSOR PROCTHROTTLEMAX 100 | Out-Null } catch {}
try { powercfg -setactive SCHEME_CURRENT | Out-Null } catch {}
Apply-Performance-Visuals -BackupObj ([ref]$bk)
Apply-Aggressive-Tweaks -BackupObj ([ref]$bk)
Apply-Gamer-Tweaks -BackupObj ([ref]$bk)
Apply-Network-Tweaks -BackupObj ([ref]$bk)
Apply-Disable-Scheduled-Tasks -BackupObj ([ref]$bk)

# --- Limpieza ---
Write-Log "Iniciando FASE DE LIMPIEZA COMPLETA..." "Green"
Clean-System
Clean-Browsers-All
Clean-Apps-All
Clean-Gpu-Caches
Clean-Application-Leftovers
Remove-Safe-Bloatware

# --- Mantenimiento Profundo ---
Write-Log "Iniciando MANTENIMIENTO PROFUNDO del sistema (DISM, SFC)... Esto puede tardar." "Yellow"
try { Dism.exe /Online /Cleanup-Image /RestoreHealth | Out-Null } catch {}
try { sfc.exe /scannow | Out-Null } catch {}
try { Dism.exe /online /Cleanup-Image /StartComponentCleanup | Out-Null } catch {}

# --- Optimización de Discos ---
Write-Log "Optimizando unidades (TRIM/Defrag)..." "Cyan"
Get-Volume | Where-Object { $_.DriveType -eq 'Fixed' -and $_.DriveLetter } | ForEach-Object {
    Optimize-Volume -DriveLetter $_.DriveLetter -Defrag -Verbose -ErrorAction SilentlyContinue
}

# --- Finalización ---
Save-Backup $bk
Write-Log "----------------- REPORTE FINAL -----------------" "White"
$totalGB = [math]::Round($totalFreedSpace / 1GB, 3)
Write-Log "Espacio total liberado en esta sesión: $totalGB GB (aprox.)" "Green"
Write-Log "-------------------------------------------------" "White"
Write-Log "OptiClean-Ultra v5.5 ha finalizado. Se recomienda reiniciar el sistema." "Green"
#endregion
                </code></pre>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-8">
            <p class="text-sm text-slate-500">Pega este script en una terminal de PowerShell (ejecutando como Administrador).</p>
        </footer>

    </div>

    <script>
        // --- Script para copiar el contenido al portapapeles ---
        const copyButton = document.getElementById('copyButton');
        const copyButtonText = document.getElementById('copyButtonText');
        const scriptContent = document.getElementById('scriptContent');

        copyButton.addEventListener('click', () => {
            const textArea = document.createElement('textarea');
            textArea.value = scriptContent.textContent.trim();
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    copyButtonText.textContent = '¡Copiado!';
                    copyButton.classList.remove('bg-sky-600', 'hover:bg-sky-500');
                    copyButton.classList.add('bg-green-600');

                    setTimeout(() => {
                        copyButtonText.textContent = 'Copiar Script';
                        copyButton.classList.remove('bg-green-600');
                        copyButton.classList.add('bg-sky-600', 'hover:bg-sky-500');
                    }, 2000);
                } else {
                    showCopyError();
                }
            } catch (err) {
                showCopyError();
            }

            document.body.removeChild(textArea);
        });
        
        function showCopyError() {
            copyButtonText.textContent = 'Error al copiar';
            copyButton.classList.remove('bg-sky-600', 'hover:bg-sky-500');
            copyButton.classList.add('bg-red-600');
            setTimeout(() => {
                copyButtonText.textContent = 'Copiar Script';
                copyButton.classList.remove('bg-red-600');
                copyButton.classList.add('bg-sky-600', 'hover:bg-sky-500');
            }, 2500);
        }
    </script>

</body>
</html>
