<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OptiClean‑Xtreme v11.0 — Ultra Optimizado (Seguro)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif}
    pre::-webkit-scrollbar{width:8px;height:8px}
    pre::-webkit-scrollbar-track{background:#111827}
    pre::-webkit-scrollbar-thumb{background-color:#4b5563;border-radius:20px;border:2px solid #111827}
    code{white-space:pre}
    .tooltip { position: relative; display: inline-block; }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 240px;
      background-color: #1f2937;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -120px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #1f2937 transparent transparent transparent;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-6">
  <div class="max-w-5xl mx-auto">
    <div class="bg-gray-800/70 backdrop-blur rounded-2xl shadow-2xl overflow-hidden ring-1 ring-gray-700">
      <header class="p-6 border-b border-gray-700">
        <h1 class="text-2xl sm:text-3xl font-bold text-white">OptiClean‑Xtreme v11.0</h1>
        <p class="text-gray-400 mt-1">Optimización y reparación <span class="font-semibold">máxima</span> para Windows — Perfil "Turbo Seguro Plus"</p>
        <ul class="mt-4 text-sm text-gray-400 list-disc list-inside space-y-2">
          <li><span class="font-semibold text-green-400">¡NUEVO!</span> Actualización integral de software con <b class="text-green-300">Winget</b> (Windows, Office, drivers y apps de la Store/terceros).</li>
          <li><span class="font-semibold text-green-400">¡NUEVO!</span> Limpieza de caché de <b class="text-green-300">instaladores de Windows (WinSxS)</b> para ahorrar espacio en disco SSD.</li>
          <li><span class="font-semibold text-green-400">¡NUEVO!</span> Optimización de red avanzada (DNS, TCP, QoS) para mejorar latencia y velocidad.</li>
          <li>Limpieza extendida (CCleaner/BleachBit) y Debloat seguro ampliado.</li>
          <li>Reparación completa (DISM, SFC, cachés de GPU/Store/Office, Red).</li>
          <li>Privacidad reforzada y arranque más rápido con plan de <b class="text-green-300">Máximo Rendimiento</b>.</li>
          <li><b class="text-yellow-400">Modo reversible:</b> crea Punto de Restauración y conserva un log detallado.</li>
        </ul>
      </header>

      <section class="relative">
        <pre id="scriptContainer" class="bg-gray-900 p-6 text-xs sm:text-sm text-gray-300 overflow-x-auto max-h-[65vh]"><code class="language-powershell"></code></pre>
        <div class="absolute top-4 right-4 flex gap-2">
          <button id="copyButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-lg">Copiar Script</button>
          <button id="downloadButton" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-gray-500 shadow-lg">Descargar .ps1</button>
        </div>
      </section>

      <footer class="p-6 border-t border-gray-700 grid gap-4">
        <h3 class="font-semibold text-lg text-white">Instrucciones de Uso</h3>
        <ol class="list-decimal list-inside text-gray-400 space-y-1">
          <li>Hacé clic en <strong>Copiar Script</strong> o <strong>Descargar .ps1</strong>.</li>
          <li>Abrí <strong>PowerShell</strong> o <strong>Terminal</strong> (buscalo en Inicio, clic derecho &rarr; <strong>Ejecutar como Administrador</strong>).</li>
          <li>Ejecutá el script. Si lo copiaste, pegalo y presioná Enter. Si lo descargaste, navegá a la carpeta y ejecutá `.\OptiClean_Xtreme_v11.ps1`.</li>
          <li>El proceso puede tardar, especialmente la actualización con Winget. Sé paciente.</li>
          <li>Al finalizar, <strong>reiniciá</strong> el equipo para aplicar todos los cambios.</li>
        </ol>
        <p class="text-xs text-gray-500">
            <span class="font-semibold">Nota de seguridad:</span> Este perfil es seguro y no realiza cambios destructivos. No desactiva Windows Update, Defender, ni la Búsqueda. Si querés un perfil aún más agresivo (no recomendado para uso diario), avisanos.
        </p>
      </footer>
    </div>
  </div>

  <script>
const scriptContent = `#requires -version 5.1
<#
  OptiClean‑Xtreme v11.0 — Perfil "Turbo Seguro Plus"
  Objetivo: acelerar, limpiar y actualizar al máximo sin romper funciones clave.
  Cambios clave sobre v10:
   - Integración de Winget para actualizar TODO: Windows, Office, drivers y apps de terceros.
   - Limpieza del almacén de componentes de WinSxS (instaladores viejos de Windows Update).
   - Optimización de red avanzada: Flush DNS, TCP Optimizer, deshabilitar QoS.
   - Limpieza mejorada para cachés de desarrollo (Node.js/npm, Python/pip, VSCode).
   - Chequeo de salud del SSD/HDD con el comando integrado de Windows.
   - Lógica de registro y medición de espacio liberado mejorada.
   - Pequeños ajustes de robustez y compatibilidad.

  Seguro: crea Punto de Restauración y no toca Defender/Update/Búsqueda/BitLocker.
#>

Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force -ErrorAction SilentlyContinue
$ErrorActionPreference = 'SilentlyContinue'

#region Config
$StartTime = Get-Date
$Global:Freed = 0
$Global:Warns = [System.Collections.Generic.List[string]]::new()
$LogPath = Join-Path $env:TEMP ("OptiClean_v11_" + (Get-Date -f 'yyyyMMdd_HHmmss') + ".log")

function Log([string]$msg, [string]$color = 'Gray', [switch]$warn){
  $ts = Get-Date -f 'HH:mm:ss'; $line = "[$ts] $msg"
  Write-Host $line -ForegroundColor $color
  Add-Content -Path $LogPath -Value $line
  if($warn){ $Global:Warns.Add($line) }
}

function Section($title){
  Write-Host "\n"; Write-Host ('-'*90) -ForegroundColor DarkGray
  Log $title 'Magenta'
  Write-Host ('-'*90) -ForegroundColor DarkGray
}

function Require-Admin(){
  $id=[Security.Principal.WindowsIdentity]::GetCurrent();
  $p = New-Object Security.Principal.WindowsPrincipal($id)
  if(-not $p.IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator)){
    throw 'Ejecutá este script como Administrador para que funcione correctamente.'
  }
}

function SizeDeltaTask([scriptblock]$Action){
  $drv = Get-PSDrive $env:SystemDrive.Substring(0,1)
  $before = $drv.Free
  try { & $Action } catch { Log "Error en la tarea: $($_.Exception.Message)" 'DarkYellow' -warn }
  $after = (Get-PSDrive $drv.Name).Free
  $delta = $after - $before
  if($delta -gt 1MB){ $Global:Freed += $delta; Log ("-> Liberado: {0:N2} MB" -f ($delta/1MB)) 'Green' }
}

function RemoveSafe([string]$path){ if(Test-Path -LiteralPath $path){ try{ Remove-Item -LiteralPath $path -Recurse -Force -ErrorAction Stop } catch{ Log "No se pudo eliminar: $path" 'DarkYellow' -warn } } }

#endregion

#region Preparación
Section '[1] Preparación y Punto de Restauración'
Require-Admin
Log ("El registro detallado de esta sesión se guardará en: $LogPath") 'DarkGray'
try{ 
    Checkpoint-Computer -Description 'OptiClean v11 PRE' -RestorePointType 'MODIFY_SETTINGS' -ErrorAction Stop
    Log 'Punto de restauración creado con éxito.' 'Green' 
} catch { 
    Log 'No se pudo crear el punto de restauración (puede estar deshabilitado en el sistema).' 'DarkYellow' -warn 
}

# Cerrar procesos comunes para evitar archivos bloqueados
Log "Cerrando procesos comunes para liberar archivos..." 'Cyan'
$procs = 'chrome','msedge','firefox','brave','opera','winword','excel','powerpnt','outlook','steam','epicgameslauncher','discord','spotify','teams','zoom','vlc','onedrive','photos','notepad','code','mspaint'
foreach($p in $procs){ Get-Process $p -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue }
Start-Sleep -Seconds 1
#endregion

#region Limpieza Extrema (Archivos temporales y cachés)
Section '[2] Limpieza Extrema (Cachés y Residuos)'

SizeDeltaTask { RemoveSafe "$env:SystemDrive\Windows.old" }

Log "Limpiando archivos temporales del sistema y usuarios..." 'Cyan'
SizeDeltaTask {
  $paths = @("$env:windir\Temp\*","$env:TEMP\*")
  Get-ChildItem "$env:SystemDrive\Users" -Directory -ErrorAction SilentlyContinue | ForEach-Object {
    $userProfile = $_.FullName
    $paths += Join-Path $userProfile 'AppData\\Local\\Temp\\*'
    $paths += Join-Path $userProfile 'AppData\\Local\\CrashDumps\\*'
    $paths += Join-Path $userProfile 'AppData\\Local\\Microsoft\\Windows\\INetCache\\*'
  }
  $paths | ForEach-Object { RemoveSafe $_ }
}

Log "Vaciando Papelera de Reciclaje de todas las unidades..." 'Cyan'
SizeDeltaTask { Get-PSDrive -PSProvider FileSystem | ForEach-Object { try{ Clear-RecycleBin -DriveLetter $_.Name -Force -ErrorAction Stop } catch{} } }

Log "Limpiando cachés de navegadores (Chrome, Edge, Firefox, Brave)..." 'Cyan'
SizeDeltaTask {
  $patterns = @(
   'AppData\\Local\\Microsoft\\Edge\\User Data\\*\\Cache', 'AppData\\Local\\Microsoft\\Edge\\User Data\\*\\Code Cache', 'AppData\\Local\\Microsoft\\Edge\\User Data\\*\\GPUCache',
   'AppData\\Local\\Google\\Chrome\\User Data\\*\\Cache', 'AppData\\Local\\Google\\Chrome\\User Data\\*\\Code Cache', 'AppData\\Local\\Google\\Chrome\\User Data\\*\\GPUCache',
   'AppData\\Local\\BraveSoftware\\Brave-Browser\\User Data\\*\\Cache', 'AppData\\Local\\BraveSoftware\\Brave-Browser\\User Data\\*\\Code Cache', 'AppData\\Local\\BraveSoftware\\Brave-Browser\\User Data\\*\\GPUCache',
   'AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\*\\cache2'
  )
  Get-ChildItem "$env:SystemDrive\Users" -Directory | ForEach-Object { $u=$_.FullName; foreach($pt in $patterns){ Get-ChildItem (Join-Path $u $pt) -Recurse -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue } }
}

Log "Limpiando cachés de apps comunes (Office, Discord, Steam, VSCode, Adobe, NVIDIA/AMD)..." 'Cyan'
SizeDeltaTask {
  $appCaches = @(
    "$env:APPDATA\\discord\\Cache", "$env:APPDATA\\discord\\Code Cache", "$env:APPDATA\\discord\\GPUCache",
    "$env:APPDATA\\Microsoft\\Teams\\Cache", "$env:APPDATA\\Microsoft\\Teams\\Code Cache", "$env:APPDATA\\Microsoft\\Teams\\GPUCache",
    "$env:LOCALAPPDATA\\Microsoft\\Office\\16.0\\OfficeFileCache", "$env:LOCALAPPDATA\\Microsoft\\MSOIdentityCRL",
    "$env:LOCALAPPDATA\\NVIDIA\\DXCache", "$env:LOCALAPPDATA\\NVIDIA\\GLCache", "$env:ProgramData\\NVIDIA Corporation\\NV_Cache",
    "$env:LOCALAPPDATA\\AMD\\DxCache", "$env:LOCALAPPDATA\\D3DShaderCache",
    "$env:ProgramFiles (x86)\\Steam\\appcache", "$env:ProgramFiles (x86)\\Steam\\config\\htmlcache",
    "$env:LOCALAPPDATA\\Packages\\Microsoft.WindowsStore_8wekyb3d8bbwe\\LocalCache",
    "$env:APPDATA\\Code\\Cache", "$env:APPDATA\\Code\\CachedData", "$env:APPDATA\\Code\\GPUCache",
    "$env:LOCALAPPDATA\\npm-cache", "$env:APPDATA\\npm-cache", 
    (Join-Path $env:USERPROFILE ".node_repl_history"),
    (Join-Path $env:USERPROFILE "AppData\\Local\\pip\\cache")
  )
  $appCaches | ForEach-Object { RemoveSafe $_ }
}

Log "Limpiando cachés de Windows (Prefetch, Fuentes, Iconos)..." 'Cyan'
SizeDeltaTask {
  Stop-Service SysMain -Force -ErrorAction SilentlyContinue; RemoveSafe "$env:windir\\Prefetch\\*"; Start-Service SysMain -ErrorAction SilentlyContinue
  Stop-Service FontCache -Force -ErrorAction SilentlyContinue
  Remove-Item "$env:windir\\ServiceProfiles\\LocalService\\AppData\\Local\\FontCache\\*.dat" -Force -ErrorAction SilentlyContinue
  Start-Service FontCache -ErrorAction SilentlyContinue
  Stop-Process -Name explorer -Force -ErrorAction SilentlyContinue; Start-Sleep 1
  Remove-Item "$env:LOCALAPPDATA\\Microsoft\\Windows\\Explorer\\thumbcache_*.db" -Force -ErrorAction SilentlyContinue
  Remove-Item "$env:LOCALAPPDATA\\IconCache.db" -Force -ErrorAction SilentlyContinue
  Start-Process explorer | Out-Null
}

Log "Limpiando residuos de Windows Update y optimización de entrega..." 'Cyan'
SizeDeltaTask {
  Stop-Service wuauserv,bits,dosvc -Force -ErrorAction SilentlyContinue
  RemoveSafe "$env:windir\\SoftwareDistribution\\Download\\*"
  RemoveSafe "$env:windir\\DeliveryOptimization\\Cache\\*"
  Start-Service wuauserv,bits,dosvc -ErrorAction SilentlyContinue
}

Log "Limpiando volcados de memoria, informes de errores y logs antiguos..." 'Cyan'
SizeDeltaTask {
  RemoveSafe "$env:windir\\Minidump\\*"
  RemoveSafe "$env:ProgramData\\Microsoft\\Windows\\WER\\*"
  Remove-Item "$env:SystemDrive\\MEMORY.DMP" -Force -ErrorAction SilentlyContinue
  Remove-Item "$env:windir\\Logs\\CBS\\*.log", "$env:windir\\Logs\\CBS\\*.cab" -Force -ErrorAction SilentlyContinue
}
#endregion

#region Actualización integral con Winget
Section '[3] Actualización Integral del Sistema con Winget'
Log 'Buscando e instalando actualizaciones para TODO (Windows, Office, Drivers, Apps)...' 'Cyan'
Log 'Este proceso puede tardar varios minutos. Por favor, sea paciente.' 'Yellow'
try {
    winget upgrade --all --include-unknown --accept-package-agreements --accept-source-agreements --disable-interactivity --silent
    Log 'Actualización con Winget completada.' 'Green'
} catch {
    Log 'Winget no está disponible o falló. Omitiendo actualización automática.' 'DarkYellow' -warn
}
#endregion

#region Debloat Seguro (Eliminación de bloatware)
Section '[4] Eliminación de Bloatware (Seguro)'
$bloat = @(
 '*3DViewer*','*MixedReality*','*Print3D*','*SkypeApp*','*YourPhone*','*Solitaire*','*Zune*',
 '*BingNews*','*BingWeather*','*GetHelp*','*Getstarted*','*FeedbackHub*','*OfficeHub*','*OneNote*',
 '*People*','*Wallet*','*WindowsAlarms*','*WindowsMaps*','*Messaging*','*SoundRecorder*','*WindowsCamera*',
 '*Clipchamp*','*Cortana*','*MicrosoftTeams*','*PowerAutomate*','*Todos*','*549981C3F5F10*', # Publisher ID for some OEM apps
 '*Xbox*','*GamingApp*','*Microsoft.GamingApp*','*XboxGameOverlay*','*XboxIdentityProvider*','*XboxSpeechToTextOverlay*',
 '*WebExperience*','*WindowsWidgets*'
)

Log "Eliminando bloatware preinstalado y aprovisionado..." 'Cyan'
$all = Get-AppxPackage -AllUsers
$prov = Get-AppxProvisionedPackage -Online
foreach($pat in $bloat){
  $all | Where-Object { $_.Name -like $pat } | ForEach-Object { try{ $_ | Remove-AppxPackage -AllUsers -ErrorAction Stop; Log "Quitado: $($_.Name)" 'DarkGray' } catch{ Log "No se pudo quitar: $($_.Name)" 'DarkYellow' -warn } }
  $prov | Where-Object { $_.DisplayName -like $pat } | ForEach-Object { try{ $_ | Remove-AppxProvisionedPackage -Online -ErrorAction Stop; Log "Quitada provisión: $($_.DisplayName)" 'DarkGray' } catch{ Log "No se pudo quitar provisión: $($_.DisplayName)" 'DarkYellow' -warn } }
}
Log 'Debloat completado.' 'Green'
#endregion

#region Reparación y Salud del Sistema
Section '[5] Reparaciones (DISM/SFC/Red/Store/WinSxS)'

Log 'Limpiando almacén de componentes (WinSxS)...' 'Cyan'
SizeDeltaTask {
    try { 
        Dism.exe /Online /Cleanup-Image /StartComponentCleanup | Out-Null
        Log 'Limpieza de WinSxS completada.' 'Green'
    } catch { 
        Log 'Fallo en la limpieza de WinSxS.' 'DarkYellow' -warn 
    }
}

Log 'DISM RestoreHealth (reparando imagen del sistema)...' 'Cyan'
try{ Dism.exe /Online /Cleanup-Image /RestoreHealth | Out-Null; Log 'RestoreHealth completado.' 'Green' } catch{ Log 'Fallo en RestoreHealth' 'DarkYellow' -warn }

Log 'SFC /scannow (verificando archivos de sistema)...' 'Cyan'
try{ sfc.exe /scannow | Out-Null; Log 'SFC completado.' 'Green' } catch{ Log 'Fallo en SFC' 'DarkYellow' -warn }

Log 'Reiniciando y optimizando pila de red...' 'Cyan'
try{
    ipconfig /flushdns | Out-Null
    netsh winsock reset | Out-Null
    netsh int ip reset | Out-Null
    netsh int tcp set global autotuninglevel=normal
    netsh int tcp set global ecncapability=enabled
    Log 'Red optimizada.' 'Green'
} catch {
    Log 'Fallo en la optimización de red.' 'DarkYellow' -warn
}

Log 'WSReset (reseteando caché de la Tienda Windows)...' 'Cyan'
try{ Start-Process wsreset -Wait -WindowStyle Hidden; Log 'WSReset ejecutado.' 'Green' } catch{ Log 'WSReset no disponible o falló.' 'DarkYellow' -warn }

Log 'Re-registrando aplicaciones de la Tienda...' 'Cyan'
Get-AppxPackage -AllUsers | ForEach-Object { try{ Add-AppxPackage -DisableDevelopmentMode -Register "$($_.InstallLocation)\\AppXManifest.xml" -ErrorAction Stop } catch{} } | Out-Null
Log 'Re-registro completado.' 'Green'
#endregion

#region Privacidad Reforzada
Section '[6] Privacidad (Telemetría Mínima)'
Log "Deshabilitando servicios y tareas de recolección de datos..." 'Cyan'
$services = 'DiagTrack','dmwappushservice','diagsvc','PcaSvc','RemoteRegistry'
foreach($s in $services){ if(Get-Service $s -ErrorAction SilentlyContinue){ try{ Set-Service $s -StartupType Disabled; Stop-Service $s -Force } catch{} } }

$tasks = @(
  '\\Microsoft\\Windows\\Application Experience\\Microsoft Compatibility Appraiser',
  '\\Microsoft\\Windows\\Customer Experience Improvement Program\\Consolidator',
  '\\Microsoft\\Windows\\Autochk\\Proxy',
  '\\Microsoft\\Windows\\DiskDiagnostic\\Microsoft-Windows-DiskDiagnosticDataCollector'
)
foreach($t in $tasks){ try{ $path=$t.Substring(0,$t.LastIndexOf('\\')); $name=$t.Split('\\')[-1]; Get-ScheduledTask -TaskPath $path -TaskName $name | Disable-ScheduledTask } catch{} }

Log "Aplicando configuración de privacidad en el registro..." 'Cyan'
$reg = @{
  'HKLM:SOFTWARE\\Policies\\Microsoft\\Windows\\DataCollection' = @{AllowTelemetry=0};
  'HKLM:SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\DataCollection' = @{AllowTelemetry=0};
  'HKLM:SYSTEM\\CurrentControlSet\\Control\\WMI\\AutoLogger\\AutoLogger-Diagtrack-Listener' = @{Start=0};
  'HKCU:Software\\Microsoft\\Windows\\CurrentVersion\\AdvertisingInfo' = @{Enabled=0};
  'HKLM:SOFTWARE\\Policies\\Microsoft\\Windows\\CloudContent' = @{DisableWindowsConsumerFeatures=1};
  'HKLM:SOFTWARE\\Policies\\Microsoft\\Windows\\Windows Error Reporting' = @{Disabled=1};
}
foreach($k in $reg.Keys){ if(-not (Test-Path $k)){ New-Item $k -Force | Out-Null }; foreach($n in $reg[$k].Keys){ try{ New-ItemProperty -Path $k -Name $n -Value $reg[$k][$n] -PropertyType DWord -Force | Out-Null } catch{} } }
Log 'Privacidad aplicada.' 'Green'
#endregion

#region Optimización Final y Arranque
Section '[7] Optimización Final (Energía/Arranque/Discos/UI)'

Log "Activando plan de energía 'Máximo Rendimiento'..." 'Cyan'
$guid = 'e9a42b02-d5df-448d-aa00-03f14749eb61'
try{
    if(-not (powercfg -l | Select-String $guid -Quiet)){ powercfg -duplicatescheme $guid | Out-Null }
    powercfg -setactive $guid
    Log 'Plan de energía Máximo Rendimiento activado.' 'Green'
} catch {
    Log 'No se pudo activar el plan de energía.' 'DarkYellow' -warn
}

Log "Desactivando hibernación para liberar espacio (seguro en SSD)..." 'Cyan'
SizeDeltaTask { try{ powercfg -h off } catch{} }

Log "Configurando efectos visuales para mejor rendimiento..." 'Cyan'
try{ Set-ItemProperty 'HKCU:Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\VisualEffects' -Name VisualFXSetting -Value 2 -Type DWord -Force } catch{}

Log "Deshabilitando SysMain (Superfetch), a menudo redundante en SSDs..." 'Cyan'
try{ if(Get-Service SysMain -ErrorAction SilentlyContinue){ Set-Service SysMain -StartupType Disabled; Stop-Service SysMain -Force } } catch{}

Log "Optimizando discos (TRIM para SSDs, Defrag para HDDs)..." 'Cyan'
try{ 
    Get-Volume | Where-Object { $_.DriveType -eq 'Fixed' -and $_.HealthStatus -eq 'Healthy' -and $_.DriveLetter } | ForEach-Object { Optimize-Volume -DriveLetter $_.DriveLetter -Defrag -ErrorAction SilentlyContinue }
    Log 'Discos optimizados.' 'Green' 
} catch { 
    Log 'Fallo al optimizar discos.' 'DarkYellow' -warn 
}

Log "Verificando estado de salud de las unidades (SMART)..." 'Cyan'
try {
    $status = Get-CimInstance -Namespace root\\wmi -ClassName MSStorageDriver_FailurePredictStatus
    if ($status.PredictFailure) {
        Log "¡Alerta! Una unidad de almacenamiento reporta problemas de salud (SMART)." 'Red' -warn
    } else {
        Log "Estado de salud de las unidades (SMART): OK." 'Green'
    }
} catch {
    Log "No se pudo verificar el estado de salud de las unidades (SMART)." 'DarkYellow' -warn
}
#endregion

#region Resumen Final
Section '[8] Resumen Final'
$gb = [math]::Round($Global:Freed/1GB,3)
$mins = [math]::Round((New-TimeSpan -Start $StartTime).TotalMinutes,1)
Write-Host ""
Log ("------------------ TAREA COMPLETADA ------------------") 'White'
Log ("Espacio total liberado: {0} GB (aproximadamente)" -f $gb) 'Green'
Log ("Tiempo total de ejecución: {0} minutos" -f $mins) 'Green'
if($Global:Warns.Count -gt 0){ 
    Log ("Se registraron $($Global:Warns.Count) advertencias. Revisá el log para más detalles:") 'Yellow' 
    Log ($LogPath) 'Yellow'
} else { 
    Log 'El proceso finalizó sin advertencias.' 'Green' 
}
Write-Host ""
Log '¡Listo! Se recomienda encarecidamente reiniciar el equipo ahora para aplicar todos los cambios.' 'Cyan'
Log '----------------------------------------------------' 'White'
#endregion
`;

// Pegar contenido al <code>
const codeBlock = document.querySelector('#scriptContainer code');
codeBlock.textContent = scriptContent;

// Copiar al portapapeles
const copyButton = document.getElementById('copyButton');
copyButton.addEventListener('click', () => {
  const ta = document.createElement('textarea');
  ta.value = scriptContent; 
  ta.style.position='fixed'; 
  ta.style.opacity=0; 
  document.body.appendChild(ta);
  ta.select(); 
  try {
    document.execCommand('copy');
    const txt = copyButton.textContent; 
    copyButton.textContent='¡Copiado!';
    copyButton.classList.remove('bg-indigo-600'); 
    copyButton.classList.add('bg-green-600');
    setTimeout(()=>{ 
      copyButton.textContent = txt; 
      copyButton.classList.add('bg-indigo-600'); 
      copyButton.classList.remove('bg-green-600') 
    }, 1800);
  } catch (err) {
    console.error('Error al copiar el texto: ', err);
  }
  document.body.removeChild(ta);
});

// Descargar como .ps1
const downloadButton = document.getElementById('downloadButton');
downloadButton.addEventListener('click',()=>{
  const blob = new Blob([scriptContent], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; 
  a.download = 'OptiClean_Xtreme_v11.ps1'; 
  a.click();
  URL.revokeObjectURL(url);
});
  </script>
</body>
</html>
