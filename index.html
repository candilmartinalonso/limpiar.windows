<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptiClean-Xtreme v7.2 - Script de Optimización</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para la barra de desplazamiento */
        pre::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        pre::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        pre::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* bg-gray-600 */
            border-radius: 20px;
            border: 2px solid #1f2937; /* bg-gray-800 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <div class="bg-gray-800 rounded-xl shadow-2xl overflow-hidden">
            <!-- Encabezado -->
            <div class="p-6 border-b border-gray-700">
                <h1 class="text-2xl font-bold text-white">OptiClean-Xtreme v7.2</h1>
                <p class="text-gray-400 mt-1">Script de Optimización y Reparación para Windows</p>
            </div>

            <!-- Contenedor del Script -->
            <div class="relative">
                <pre id="scriptContainer" class="bg-gray-900 p-6 text-sm text-gray-300 overflow-x-auto max-h-[50vh]"><code class="language-powershell
                "><!--
                    El script de PowerShell se insertará aquí mediante JavaScript
                    para evitar problemas de renderizado con caracteres especiales de HTML.
                --></code></pre>
                
                <!-- Botón de Copiar -->
                <button id="copyButton" class="absolute top-4 right-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                    Copiar Script
                </button>
            </div>

            <!-- Pie de página con instrucciones -->
            <div class="p-6 bg-gray-800 border-t border-gray-700">
                <h3 class="font-semibold text-lg text-white">Instrucciones</h3>
                <ol class="list-decimal list-inside mt-2 text-gray-400 space-y-1">
                    <li>Haz clic en el botón <strong>"Copiar Script"</strong>.</li>
                    <li>Abre una ventana de <strong>Windows PowerShell</strong> como <strong>Administrador</strong>.</li>
                    <li>Pega el script en la terminal y presiona Enter para ejecutar.</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        const scriptContent = `<#
.SYNOPSIS
    OptiClean-Xtreme v7.2: Script de Optimización y Reparación Extrema.
.DESCRIPTION
    Versión "pegar y ejecutar" inspirada en la minuciosidad de Tron Script.
    Realiza una secuencia de preparación, limpieza profunda, eliminación de bloatware,
    reparación del sistema, ajustes de privacidad y optimización final.
    - MODO AUTOMÁTICO: No requiere intervención.
    - LOG DETALLADO: Informa de cada paso ejecutado y recolecta errores.
    - REPARACIÓN INTEGRAL: Ejecuta DISM (Cleanup y RestoreHealth), SFC, reseteo de red y más.
    - PRIVACIDAD: Aplica ajustes para reducir la telemetría.
    - OPTIMIZACIÓN AVANZADA: Incluye limpieza de cachés de apps modernas (Office, Zoom, Teams, Store).
.NOTES
    Ejecutar siempre en una terminal de PowerShell como Administrador.
    Se recomienda cerrar todas las aplicaciones antes de ejecutar.
    Versión: 7.2 - Añadida limpieza de Prefetch, Font Cache, Componentes de Windows (WinSxS) y más cachés de apps.
#>

#region -------------------- [0] Configuración Inicial y Helpers --------------------
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force -ErrorAction SilentlyContinue
$global:totalFreedSpace = 0
$global:errorLog = [System.Collections.Generic.List[string]]::new()
$startTime = Get-Date

function Write-Log {
    param([string]$Message, [string]$Color = "White", [int]$Indent = 0)
    $indentation = " " * $Indent
    $timestamp = Get-Date -f 'HH:mm:ss'
    $logMessage = "[$timestamp] $Message"
    Write-Host "$indentation$logMessage" -ForegroundColor $Color
    if ($Color -eq "Red" -or $Color -eq "Yellow" -or $Color -eq "DarkYellow") { 
        $global:errorLog.Add($logMessage) 
    }
}

function Write-Section {
    param([string]$Title)
    Write-Host "\`n" + ("-"*80)
    Write-Log $Title "Magenta"
    Write-Host ("-"*80)
}

function Require-Admin {
    $identity = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($identity)
    if (-not $principal.IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator)) {
        Write-Error "Este script requiere privilegios de Administrador. Por favor, ejecútalo en una terminal de PowerShell como Administrador." -ErrorAction Stop
    }
}

function Remove-Path-Safe {
    param([string]$Path)
    if (Test-Path -LiteralPath $Path) {
        try {
            Remove-Item -LiteralPath $Path -Recurse -Force -ErrorAction Stop
        } catch { Write-Log "Acceso denegado o archivo en uso: $Path" "DarkYellow" 4 }
    }
}

function Stop-Conflicting-Processes {
    $processes = @("chrome", "msedge", "firefox", "brave", "opera", "winword", "excel", "powerpnt", "outlook", "steam", "epicgameslauncher", "discord", "spotify", "teams", "zoom", "vlc")
    Write-Log "Cerrando procesos conflictivos para una limpieza efectiva..." "Yellow" 2
    foreach ($proc in $processes) {
        if (Get-Process $proc -ErrorAction SilentlyContinue) {
            Stop-Process -Name $proc -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 1
            if (-not (Get-Process $proc -ErrorAction SilentlyContinue)) {
                Write-Log "Proceso cerrado: $proc" "DarkGray" 4
            } else {
                Write-Log "No se pudo cerrar el proceso: $proc" "Yellow" 4
            }
        }
    }
}
#endregion

#region -------------------- [1] Fase de Preparación --------------------
function Stage-Preparation {
    Write-Section "[1] FASE DE PREPARACIÓN"

    Write-Log "Verificando privilegios de administrador..." "Cyan" 2
    Require-Admin
    Write-Log "Verificación exitosa." "Green" 4

    Write-Log "Creando punto de restauración del sistema..." "Cyan" 2
    try {
        Checkpoint-Computer -Description "OptiClean-Xtreme v7.2 (Pre-Ejecución)" -ErrorAction Stop
        Write-Log "Punto de restauración creado con éxito." "Green" 4
    } catch {
        Write-Log "No se pudo crear el punto de restauración (puede estar deshabilitado o falló)." "Yellow" 4
    }

    Stop-Conflicting-Processes
}
#endregion

#region -------------------- [2] Fase de Limpieza de Temporales --------------------
function Run-Cleaning-Task {
    param([string]$Name, [scriptblock]$Action, [int]$Indent = 2)
    Write-Log $Name "Cyan" $Indent
    $drive = Get-PSDrive $env:SystemDrive.Substring(0, 1)
    $sizeBefore = $drive.Free
    try { Invoke-Command -ScriptBlock $Action -ErrorAction Stop }
    catch { Write-Log "Error durante la limpieza de '$Name': $_" "Red" ($Indent + 2) }
    $sizeAfter = $drive.Free
    $freed = $sizeAfter - $sizeBefore
    if ($freed -gt 1MB) {
        $freedMB = [math]::Round($freed / 1MB, 2)
        $global:totalFreedSpace += $freed
        Write-Log "-> Liberado: $freedMB MB" "Green" ($Indent + 2)
    }
}

function Stage-Clean {
    Write-Section "[2] FASE DE LIMPIEZA PROFUNDA"

    Run-Cleaning-Task "Temporales de Sistema y Usuarios" {
        $tempPaths = @("$env:windir\\Temp\\*", "$env:TEMP\\*")
        Get-ChildItem -Path "$env:SystemDrive\\Users" -Directory -ErrorAction SilentlyContinue | ForEach-Object {
            $tempPaths += Join-Path $_.FullName "AppData\\Local\\Temp\\*"
        }
        $tempPaths | ForEach-Object { Remove-Path-Safe $_ }
    }

    Run-Cleaning-Task "Papelera de Reciclaje (Todas las unidades)" {
        Get-PSDrive -PSProvider FileSystem | ForEach-Object {
            Clear-RecycleBin -DriveLetter $_.Name -Force -ErrorAction SilentlyContinue
        }
    }

    Run-Cleaning-Task "Cachés de Navegadores (Todos los perfiles)" {
        $browserCaches = @(
            'AppData\\Local\\Microsoft\\Edge\\User Data\\*\\Cache', 'AppData\\Local\\Google\\Chrome\\User Data\\*\\Cache',
            'AppData\\Local\\BraveSoftware\\Brave-Browser\\User Data\\*\\Cache', 'AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\*\\cache2'
        )
        Get-ChildItem -Path "$env:SystemDrive\\Users" -Directory -ErrorAction SilentlyContinue | ForEach-Object {
            $userProfile = $_.FullName
            foreach ($cachePath in $browserCaches) {
                $fullPath = Join-Path $userProfile $cachePath
                Get-ChildItem -Path $fullPath -Recurse -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
            }
        }
    }

    Run-Cleaning-Task "Cachés de Aplicaciones (Office, Discord, Teams, Steam, etc.)" {
        $appPaths = @(
            "$env:APPDATA\\discord\\Cache", "$env:APPDATA\\discord\\Code Cache", "$env:APPDATA\\discord\\GPUCache",
            "$env:APPDATA\\Microsoft\\Teams\\Cache", "$env:APPDATA\\Microsoft\\Teams\\Code Cache", "$env:APPDATA\\Microsoft\\Teams\\GPUCache",
            "$env:LOCALAPPDATA\\Spotify\\Browser", "$env:LOCALAPPDATA\\EpicGamesLauncher\\Saved\\webcache",
            "$env:ProgramFiles (x86)\\Steam\\appcache", "$env:ProgramFiles (x86)\\Steam\\config\\htmlcache",
            "$env:APPDATA\\Zoom\\data\\Cache", "$env:APPDATA\\vlc\\art\\cache",
            "$env:LOCALAPPDATA\\Microsoft\\Office\\16.0\\OfficeFileCache", "$env:LOCALAPPDATA\\Microsoft\\MSOIdentityCRL"
        )
        $appPaths | ForEach-Object { Remove-Path-Safe $_ }
    }

    Run-Cleaning-Task "Cachés de Shaders (NVIDIA/AMD/DX) y Microsoft Store" {
        $shaderPaths = @(
            "$env:LOCALAPPDATA\\NVIDIA\\GLCache", "$env:ProgramData\\NVIDIA Corporation\\NV_Cache",
            "$env:LOCALAPPDATA\\D3DShaderCache", "$env:LOCALAPPDATA\\AMD\\DxCache",
            "$env:LOCALAPPDATA\\Packages\\Microsoft.WindowsStore_8wekyb3d8bbwe\\LocalCache"
        )
        $shaderPaths | ForEach-Object { Remove-Path-Safe $_ }
    }
    
    Run-Cleaning-Task "Archivos Prefetch" {
        Stop-Service -Name "SysMain" -Force -ErrorAction SilentlyContinue
        Remove-Path-Safe "$env:windir\\Prefetch\\*"
        Start-Service -Name "SysMain" -ErrorAction SilentlyContinue
    }
    
    Run-Cleaning-Task "Caché de Fuentes del Sistema" {
        Stop-Service -Name "FontCache" -Force -ErrorAction SilentlyContinue
        Remove-Item "$env:windir\\ServiceProfiles\\LocalService\\AppData\\Local\\FontCache\\*.dat" -Force -ErrorAction SilentlyContinue
        Start-Service -Name "FontCache" -ErrorAction SilentlyContinue
    }

    Run-Cleaning-Task "Restos de Windows Update y Delivery Optimization" {
        Stop-Service -Name "wuauserv", "bits", "dosvc" -Force -ErrorAction SilentlyContinue
        Remove-Path-Safe "$env:windir\\SoftwareDistribution\\Download\\*"
        Remove-Path-Safe "$env:windir\\DeliveryOptimization\\Cache\\*"
        Start-Service -Name "wuauserv", "bits", "dosvc" -ErrorAction SilentlyContinue
    }

    Run-Cleaning-Task "Informes de Errores, Dumps y Logs Obsoletos" {
        Remove-Path-Safe "$env:windir\\Minidump\\*"
        Remove-Path-Safe "$env:ProgramData\\Microsoft\\Windows\\WER\\*"
        Remove-Item "$env:SystemDrive\\MEMORY.DMP" -Force -ErrorAction SilentlyContinue
        Remove-Item "$env:windir\\Logs\\CBS\\*.log", "$env:windir\\Logs\\CBS\\*.cab" -Force -ErrorAction SilentlyContinue
        wevtutil cl "Application" | Out-Null
        wevtutil cl "Security" | Out-Null
        wevtutil cl "Setup" | Out-Null
        wevtutil cl "System" | Out-Null
        wevtutil cl "ForwardedEvents" | Out-Null
        wevtutil cl "Windows PowerShell" | Out-Null
    }

    Run-Cleaning-Task "Caché de Miniaturas, Iconos y Sistema de Archivos" {
        Stop-Process -Name explorer -Force -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 2
        Remove-Item "$env:LOCALAPPDATA\\Microsoft\\Windows\\Explorer\\thumbcache_*.db" -Force -ErrorAction SilentlyContinue
        Remove-Item "$env:LOCALAPPDATA\\IconCache.db" -Force -ErrorAction SilentlyContinue
        fsutil usn deletejournal /D /N C: | Out-Null
        Start-Process explorer
    }
}
#endregion

#region -------------------- [3] Fase de Eliminación de Bloatware --------------------
function Stage-Debloat {
    Write-Section "[3] FASE DE ELIMINACIÓN DE BLOATWARE"

    $bloatwarePatterns = @(
        "*3DViewer*", "*MixedReality*", "*Print3D*", "*SkypeApp*", "*YourPhone*", "*Solitaire*", "*Zune*",
        "*BingNews*", "*BingWeather*", "*GetHelp*", "*Getstarted*", "*FeedbackHub*", "*OfficeHub*", "*OneNote*",
        "*People*", "*Wallet*", "*WindowsAlarms*", "*WindowsMaps*", "*Messaging*", "*SoundRecorder*", "*WindowsCamera*", "*549981C3F5F10*"
    )

    Write-Log "Buscando y eliminando Bloatware (puede tardar)..." "Yellow" 2
    $allPackages = Get-AppxPackage -AllUsers
    $provisionedPackages = Get-AppxProvisionedPackage -Online

    foreach ($pattern in $bloatwarePatterns) {
        # Quitar paquetes de usuario actual
        $allPackages | Where-Object { $_.Name -like $pattern } | ForEach-Object {
            Write-Log "Intentando quitar: $($_.Name)" "DarkGray" 4
            try {
                $_ | Remove-AppxPackage -AllUsers -ErrorAction Stop
            } catch {
                Write-Log "No se pudo quitar (protegido por el sistema): $($_.Name)" "DarkYellow" 6
            }
        }
        # Quitar paquetes pre-instalados para nuevos usuarios
        $provisionedPackages | Where-Object { $_.DisplayName -like $pattern } | ForEach-Object {
            Write-Log "Quitando provisión: $($_.DisplayName)" "DarkGray" 4
            try {
                $_ | Remove-AppxProvisionedPackage -Online -ErrorAction Stop
            } catch {
                Write-Log "No se pudo quitar provisión: $($_.DisplayName)" "DarkYellow" 6
            }
        }
    }
    Write-Log "Desinstalación de bloatware completada." "Green" 2
}
#endregion

#region -------------------- [4] Fase de Reparaciones y Mantenimiento --------------------
function Stage-Repair {
    Write-Section "[4] FASE DE REPARACIONES Y MANTENIMIENTO"

    Write-Log "Limpiando componentes de Windows (DISM Cleanup)... Esto puede tardar." "Cyan" 2
    try { Dism.exe /Online /Cleanup-Image /StartComponentCleanup | Out-Null } catch { Write-Log "Fallo en DISM Cleanup." "Red" 4 }
    Write-Log "Limpieza de componentes completada." "Green" 4

    Write-Log "Reparando imagen del sistema (DISM RestoreHealth)... Esto puede tardar." "Cyan" 2
    try { Dism.exe /Online /Cleanup-Image /RestoreHealth | Out-Null } catch { Write-Log "Fallo en DISM RestoreHealth." "Red" 4 }
    Write-Log "DISM RestoreHealth completado." "Green" 4

    Write-Log "Reparando integridad de archivos del sistema (SFC)..." "Cyan" 2
    try { sfc.exe /scannow | Out-Null } catch { Write-Log "Fallo en SFC." "Red" 4 }
    Write-Log "SFC completado." "Green" 4

    Write-Log "Reparando la Pila de Red (TCP/IP, Winsock, DNS)..." "Cyan" 2
    netsh winsock reset | Out-Null
    netsh int ip reset | Out-Null
    ipconfig /release | Out-Null
    ipconfig /renew | Out-Null
    ipconfig /flushdns | Out-Null
    Write-Log "Pila de red reseteada." "Green" 4

    Write-Log "Re-registrando aplicaciones de la Tienda de Windows..." "Cyan" 2
    Get-AppxPackage -AllUsers | Foreach {Add-AppxPackage -DisableDevelopmentMode -Register "$($_.InstallLocation)\\AppXManifest.xml" -ErrorAction SilentlyContinue}
    Write-Log "Re-registro completado." "Green" 4

    Write-Log "Restaurando archivo HOSTS a su estado por defecto..." "Cyan" 2
    $hostsContent = @"
# Copyright (c) 1993-2009 Microsoft Corp.
# This is a sample HOSTS file used by Microsoft TCP/IP for Windows.
# 127.0.0.1       localhost
# ::1             localhost
"@
    try {
        Set-Content -Path "$env:windir\\System32\\drivers\\etc\\hosts" -Value $hostsContent -Force -Encoding ASCII
        Write-Log "Archivo HOSTS restaurado." "Green" 4
    } catch {
        Write-Log "No se pudo restaurar el archivo HOSTS." "Red" 4
    }
}
#endregion

#region -------------------- [5] Fase de Privacidad y Telemetría --------------------
function Stage-Privacy {
    Write-Section "[5] FASE DE PRIVACIDAD Y TELEMETRÍA"

    Write-Log "Deshabilitando servicios de telemetría..." "Cyan" 2
    $telemetryServices = @("DiagTrack", "dmwappushservice", "diagsvc", "PcaSvc")
    foreach ($svc in $telemetryServices) {
        if (Get-Service -Name $svc -ErrorAction SilentlyContinue) {
            Set-Service -Name $svc -StartupType Disabled -ErrorAction SilentlyContinue
            Stop-Service -Name $svc -Force -ErrorAction SilentlyContinue
        }
    }

    Write-Log "Deshabilitando tareas programadas de telemetría..." "Cyan" 2
    $telemetryTasks = @(
        "\\Microsoft\\Windows\\Application Experience\\Microsoft Compatibility Appraiser",
        "\\Microsoft\\Windows\\Customer Experience Improvement Program\\Consolidator"
    )
    $telemetryTasks | ForEach-Object { Get-ScheduledTask -TaskPath $_.Substring(0, $_.LastIndexOf('\\')) -TaskName $_.Split('\\')[-1] -ErrorAction SilentlyContinue | Disable-ScheduledTask -ErrorAction SilentlyContinue }

    Write-Log "Aplicando ajustes de registro para reducir telemetría..." "Cyan" 2
    $regKeys = @{
        "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\DataCollection" = @{ Name = "AllowTelemetry"; Value = 0 };
        "HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\DataCollection" = @{ Name = "AllowTelemetry"; Value = 0 };
        "HKLM:\\SYSTEM\\CurrentControlSet\\Control\\WMI\\AutoLogger\\AutoLogger-Diagtrack-Listener" = @{ Name = "Start"; Value = 0 }
    }
    foreach ($key in $regKeys.GetEnumerator()) {
        if (-not (Test-Path $key.Name)) { New-Item -Path $key.Name -Force -ErrorAction SilentlyContinue | Out-Null }
        Set-ItemProperty -Path $key.Name -Name $key.Value.Name -Value $key.Value.Value -Type DWord -Force -ErrorAction SilentlyContinue
    }
    Write-Log "Ajustes de registro aplicados." "Green" 4
}
#endregion

#region -------------------- [6] Fase de Optimización --------------------
function Stage-Optimize {
    Write-Section "[6] FASE DE OPTIMIZACIÓN"

    Write-Log "Aplicando plan de energía de 'Máximo Rendimiento'..." "Cyan" 2
    $ultimatePlanGuid = "e9a42b02-d5df-448d-aa00-03f14749eb61"
    if (-not (powercfg -l | Select-String $ultimatePlanGuid -Quiet)) {
        Write-Log "Importando plan de energía 'Máximo Rendimiento'..." "DarkGray" 4
        powercfg -duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61 | Out-Null
    }
    powercfg -setactive $ultimatePlanGuid
    if ($?) {
        Write-Log "Plan de energía 'Máximo Rendimiento' activado." "Green" 4
    } else {
        Write-Log "No se pudo activar el plan de energía 'Máximo Rendimiento'." "Yellow" 4
    }

    Write-Log "Deshabilitando hibernación para liberar espacio..." "Cyan" 2
    powercfg -h off

    Write-Log "Ajustando efectos visuales para máximo rendimiento..." "Cyan" 2
    Set-ItemProperty -Path "HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\VisualEffects" -Name "VisualFXSetting" -Value 2 -Type DWord -Force

    Write-Log "Deshabilitando SysMain (Superfetch) y optimizando memoria..." "Cyan" 2
    if (Get-Service -Name "SysMain" -ErrorAction SilentlyContinue) { Set-Service -Name "SysMain" -StartupType Disabled; Stop-Service -Name "SysMain" -Force }
    Set-ItemProperty -Path "HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\Memory Management" -Name "ClearPageFileAtShutdown" -Value 0 -Type DWord -Force

    Write-Log "Optimizando unidades (TRIM/Defrag)..." "Cyan" 2
    # CORRECCIÓN: Filtrar solo volúmenes con letra de unidad para evitar errores
    Get-Volume | Where-Object { $_.DriveType -eq 'Fixed' -and $_.HealthStatus -eq 'Healthy' -and $null -ne $_.DriveLetter } | ForEach-Object {
        Write-Log "Optimizando unidad $($_.DriveLetter):..." "DarkGray" 4
        try {
            # El parámetro -Defrag ejecuta TRIM en SSDs y Defrag en HDDs automáticamente.
            Optimize-Volume -DriveLetter $_.DriveLetter -Defrag -Verbose -ErrorAction Stop
        } catch {
            Write-Log "Fallo al optimizar la unidad $($_.DriveLetter): $_" "Red" 6
        }
    }
    Write-Log "Optimización de unidades completada." "Green" 2
}
#endregion

#region -------------------- [7] Lógica Principal de Ejecución --------------------
function Main {
    Write-Host "\`n"
    Write-Host "================================================================================" -ForegroundColor "White"
    Write-Host "           INICIANDO OPTICLEAN-XTREME v7.2 (MODO AUTOMÁTICO)            " -ForegroundColor "White"
    Write-Host "================================================================================" -ForegroundColor "White"

    $phases = @(
        { Stage-Preparation }, { Stage-Clean }, { Stage-Debloat },
        { Stage-Repair }, { Stage-Privacy }, { Stage-Optimize }
    )
    foreach ($phase in $phases) { & $phase }

    # --- Finalización ---
    Write-Section "[7] REPORTE FINAL"
    $totalGB = [math]::Round($global:totalFreedSpace / 1GB, 3)
    $elapsed = [math]::Round((New-TimeSpan -Start $startTime).TotalMinutes, 1)
    Write-Log "Espacio total liberado en esta sesión: $totalGB GB (aprox.)" "Green" 2
    Write-Log "Tiempo total de ejecución: $elapsed minutos." "Green" 2

    if ($global:errorLog.Count -gt 0) {
        Write-Log "Se registraron $($global:errorLog.Count) advertencias o errores durante la ejecución:" "Yellow" 2
        $global:errorLog | ForEach-Object { Write-Log $_ "Yellow" 4 }
    } else {
        Write-Log "El script se completó sin errores registrados." "Green" 2
    }

    Write-Host "--------------------------------------------------------------------------------" -ForegroundColor "White"
    Write-Log "OptiClean-Xtreme v7.2 ha finalizado. Se RECOMIENDA REINICIAR el sistema." "Green"
    Write-Host "================================================================================" -ForegroundColor "White"
}

# Iniciar la ejecución
Main
#endregion`;

        // Insertar el contenido del script en el elemento <code>
        const codeBlock = document.querySelector('#scriptContainer code');
        codeBlock.textContent = scriptContent;

        const copyButton = document.getElementById('copyButton');
        copyButton.addEventListener('click', () => {
            // Crear un área de texto temporal para copiar el contenido
            const textArea = document.createElement('textarea');
            textArea.value = scriptContent;
            
            // Evitar que se vea en pantalla
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            textArea.style.opacity = 0;

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                // Usar document.execCommand para compatibilidad
                const successful = document.execCommand('copy');
                if (successful) {
                    const originalText = copyButton.textContent;
                    copyButton.textContent = '¡Copiado!';
                    copyButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    copyButton.classList.add('bg-green-600');
                    
                    setTimeout(() => {
                        copyButton.textContent = originalText;
                        copyButton.classList.remove('bg-green-600');
                        copyButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    }, 2000);
                }
            } catch (err) {
                console.error('Error al intentar copiar el script: ', err);
            }

            document.body.removeChild(textArea);
        });
    </script>
</body>
</html>
