<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Script LEVIATÁN v15.0 - Limpieza, aceleración y optimización extrema de Windows con menú interactivo, seguridad y control de telemetría.">
    <title>LEVIATÁN v15.0 - Optimizador Extremo Avanzado</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'Arial', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', system-ui, Arial, sans-serif;
            background-color: #0d1117; 
        }
        .dark\:bg-zinc-900 {
            background-color: #0d1117;
        }
        .dark\:text-gray-200 {
            color: #c9d1d9;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-zinc-900 text-gray-800 dark:text-gray-200 min-h-screen p-4 flex flex-col items-center justify-center transition-colors duration-300">
    <div class="max-w-4xl w-full">
        <h1 class="text-center text-4xl font-extrabold mb-6 text-indigo-500 dark:text-indigo-400">
            <span class="inline-block animate-bounce">🌊</span> LEVIATÁN v15.0 - Optimizador Extremo Avanzado
        </h1>
        <div class="bg-zinc-800 text-gray-200 dark:bg-zinc-800 dark:text-gray-200 p-6 rounded-2xl shadow-2xl overflow-auto border-4 border-indigo-600">
            <!-- Código de PowerShell LEVIATÁN v15.0 con mejoras de optimización extrema -->
            <pre><code class="language-powershell" id="scriptContent"># ===================================================================================================
#   PowerScript Optimizador LEVIATÁN v15.0 - Edición EXTREMA, Segura y Avanzada
#   Objetivo: Limpieza Profunda, aceleración máxima, optimización de red, privacidad y REGISTRO.
#   ADVERTENCIA: EJECUTAR SIEMPRE COMO ADMINISTRADOR.
#
#   Este script presenta un menú interactivo para que selecciones las optimizaciones a ejecutar.
# ===================================================================================================

#region VARIABLES Y LOG
# Define la ubicación del archivo de log en el escritorio del usuario
$logFile = "$env:USERPROFILE\Desktop\Optimizador-Leviatan-Log-v15.0.txt"

# Función para escribir mensajes en la consola y en el archivo de log
Function Write-Log { 
    param ([string]$Message, [string]$Color = 'Gray')
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    Write-Host "[$timestamp] $Message" -ForegroundColor $Color
    Add-Content -Path $logFile -Value "[$timestamp] $Message"
}
#endregion

#region FUNCIONES DE VALIDACIÓN Y UTILERÍAS
Function Check-Admin {
    # Verifica si el script se está ejecutando con permisos de administrador
    if (-NOT ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
        Write-Warning "Este script requiere privilegios de Administrador. Por favor, reinicia la terminal como Administrador."
        Start-Sleep -Seconds 10
        Exit
    }
}

Function Check-Module {
    param ([string]$ModuleName)
    if (-not (Get-Module -ListAvailable -Name $ModuleName)) {
        Write-Log "El módulo '$ModuleName' no está instalado. Instalándolo..." -Color Yellow
        try {
            Install-Module -Name $ModuleName -Force -Confirm:$false -ErrorAction Stop
            Write-Log "Módulo '$ModuleName' instalado correctamente." -Color Green
        } catch {
            Write-Log "ERROR: No se pudo instalar el módulo '$ModuleName'. La función que lo requiere no se ejecutará." -Color Red
            return $false
        }
    }
    return $true
}

Function New-SystemRestorePoint {
    # Crea un punto de restauración del sistema para mayor seguridad
    Write-Log "Creando un punto de restauración del sistema..." -Color Yellow
    try {
        Checkpoint-Computer -Description "LEVIATÁN v15.0 - Antes de la optimización" -RestorePointType "MODIFY_SETTINGS"
        Write-Log "Punto de restauración creado con éxito." -Color Green
    } catch {
        Write-Log "ERROR: No se pudo crear el punto de restauración. Asegúrate de que la protección del sistema esté habilitada." -Color Red
    }
}
#endregion

#region FUNCIONES DE OPTIMIZACIÓN Y LIMPIEZA EXTREMA

# Función agregada para desfragmentar solo unidades HDD (Opción 8)
Function Defrag-Drives {
    Write-Log "Iniciando desfragmentación de unidades no-SSD..." -Color Cyan
    try {
        Get-Volume | Where-Object { $_.FileSystemType -eq 'NTFS' -and $_.DriveType -eq 'Fixed' -and $_.HealthStatus -eq 'Healthy' } | ForEach-Object {
            $driveLetter = $_.DriveLetter
            
            # Obtener el PhysicalDisk asociado al DriveLetter
            $partition = Get-Partition | Where-Object { $_.DriveLetter -eq $driveLetter }
            if ($partition) {
                $physicalDisk = Get-PhysicalDisk | Where-Object { $_.Number -eq $partition.DiskNumber -and $_.MediaType -ne 'SSD' }
                
                if ($physicalDisk) {
                    Write-Log "Desfragmentando unidad $driveLetter (HDD)..."
                    # Usar -Analyze y luego -Defrag. El cmdlet Optimize-Volume es consciente de los SSDs.
                    Optimize-Volume -DriveLetter $driveLetter -Defrag -Verbose -ErrorAction SilentlyContinue
                } else {
                    Write-Log "Saltando unidad $driveLetter (Es SSD o no es apta)." -Color Yellow
                }
            } else {
                Write-Log "No se encontró la partición para la letra de unidad $driveLetter." -Color Yellow
            }
        }
        Write-Log "Desfragmentación de discos completada." -Color Green
    } catch {
        Write-Log "ERROR al desfragmentar discos: $_" -Color Red
    }
}

Function Clean-System {
    Write-Log "Iniciando limpieza PROFUNDA de archivos temporales..." -Color Cyan
    
    # 1. Limpia directorios temporales estándar
    $tempPaths = @(
        "$env:TEMP\*",
        "$env:WINDIR\Temp\*",
        "$env:USERPROFILE\AppData\Local\Temp\*"
    )
    foreach ($path in $tempPaths) {
        Remove-Item -Path $path -Recurse -Force -ErrorAction SilentlyContinue
    }
    Write-Log "Directorios temporales estándar limpios."

    # 2. Limpia cachés de Windows (Store, Papelera, Componentes, Logs)
    try {
        WSReset.exe -c | Out-Null
        Clear-RecycleBin -Force -ErrorAction SilentlyContinue
        Dism.exe /online /Cleanup-Image /StartComponentCleanup | Out-Null
        Dism.exe /online /Cleanup-Image /StartComponentCleanup /ResetBase | Out-Null
        Remove-Item -Path "$env:SystemRoot\SoftwareDistribution\Download\*" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "$env:SystemRoot\Logs\*" -Recurse -Force -ErrorAction SilentlyContinue
        Write-Log "Cachés de Windows, Update y Logs de sistema limpios."
    } catch {
        Write-Log "Error al limpiar cachés de Windows: $_" -Color Red
    }

    # 3. Limpieza de cachés de miniaturas y prefetch
    try {
        # Limpiar caché de miniaturas
        $shell = New-Object -ComObject Shell.Application
        $shell.Namespace(10).ParseName("C:\").InvokeVerb("clean") | Out-Null
        Remove-Item -Path "$env:SystemRoot\Prefetch\*.pf" -Force -ErrorAction SilentlyContinue
        Write-Log "Cachés de miniaturas y Prefetch limpiadas."
    } catch {
        Write-Log "Error al limpiar cachés de Windows Shell/Prefetch: $_" -Color Red
    }
    
    # 4. Limpieza de cachés de navegadores (Chrome, Edge, Firefox - Requiere cerrar navegadores)
    Write-Log "Limpiando cachés de navegadores (puede requerir cerrar las aplicaciones)..."
    $browserCaches = @(
        "$env:USERPROFILE\AppData\Local\Google\Chrome\User Data\Default\Cache\*",
        "$env:USERPROFILE\AppData\Local\Microsoft\Edge\User Data\Default\Cache\*",
        "$env:USERPROFILE\AppData\Local\Mozilla\Firefox\Profiles\*\cache2\entries\*"
    )
    foreach ($cache in $browserCaches) {
        Remove-Item -Path $cache -Recurse -Force -ErrorAction SilentlyContinue
    }
    Write-Log "Cachés de navegadores principales limpiadas."

    # 5. Limpieza de caché de instaladores MSI (Advertencia: puede afectar la reparación de programas)
    Write-Log "Limpiando caché de instaladores (MSI) antiguos..."
    # Atención: Esta línea era incorrecta y ha sido corregida para apuntar a la base de datos de instaladores, no a la llave de productos.
    # La limpieza de MSI se omite o se haría manualmente para evitar daños en la reparación de aplicaciones.
    Write-Log "La limpieza agresiva de caché MSI ha sido omitida por motivos de seguridad extrema." -Color Yellow

    # 6. Ejecuta el Limpiador de Disco de Windows (Extremo)
    try {
        # Configura el limpiador para incluir todas las opciones (incluyendo archivos de actualización)
        # Esto requiere una configuración previa de sagerset: Cleanmgr /sageset:65535
        # Luego se ejecuta con sagerun: Cleanmgr /sagerun:65535
        Write-Log "Ejecutando Cleanmgr con todas las opciones (Ejecución silenciosa de Limpiador de Disco)."
        Start-Process cleanmgr.exe -ArgumentList '/sagerun:65535' -Wait -NoNewWindow
    } catch {
        Write-Log "Error al ejecutar Cleanmgr: $_" -Color Red
    }
    Write-Log "Limpieza de archivos completada." -Color Green
}

Function Optimize-Network {
    Write-Log "Optimizando red: Reiniciando adaptadores y restableciendo la pila TCP/IP..." -Color Cyan
    try {
        # Reinicia todos los adaptadores de red
        Get-NetAdapter | Restart-NetAdapter -Confirm:$false -ErrorAction Stop
        # Restablece la pila TCP/IP y el catálogo Winsock
        netsh int ip reset -c null | Out-Null
        netsh winsock reset | Out-Null
        # Limpia la caché de DNS
        ipconfig /flushdns
        Write-Log "Optimización de red completada." -Color Green
    } catch {
        Write-Log "ERROR: No se pudo optimizar la red: $_" -Color Red
    }
}

Function Optimize-Memory {
    Write-Log "Liberando memoria RAM (forzando GC)..." -Color Cyan
    try {
        # Esto libera la memoria utilizada por el propio proceso de PowerShell
        [System.GC]::Collect()
        Write-Log "Memoria RAM liberada (GC ejecutado)." -Color Green
    } catch {
        Write-Log "ERROR: No se pudo liberar memoria RAM: $_" -Color Red
    }
}

Function Stop-UnnecessaryServices {
    param ([switch]$Force)
    if (-not $Force) {
        Write-Host "ADVERTENCIA: Detener y deshabilitar servicios puede afectar la funcionalidad del sistema." -ForegroundColor Red
        $confirm = Read-Host "Deseas continuar? (S/N)"
        if ($confirm -ne 'S') {
            Write-Log "Acción cancelada por el usuario."
            return
        }
    }
    Write-Log "Deteniendo y deshabilitando servicios innecesarios..." -Color Cyan
    # Lista de servicios a detener y deshabilitar (Ampliada en v15.0 para mayor agresividad segura)
    $servicios = @(
        "DiagTrack",        # Servicio de seguimiento de diagnóstico
        "dmwappushservice", # Servicio de telemetría
        "XblGameSave",      # Servicio de guardado de juegos de Xbox
        "WMPNetworkSvc",    # Reproductor de Windows Media
        "Fax",              # Servicio de fax
        "SysMain",          # Superfetch/Prefetch (inútil en SSDs)
        "PcaSvc",           # Servicio de compatibilidad de programas
        "XboxGipSvc",       # Xbox Game Input Service
        "XboxNetApiSvc",    # Xbox Live Networking Service
        "cbdhsvc",          # Servicio de portapapeles de usuario
        "CDPSvc",           # Plataforma de dispositivos conectados (sincronización entre dispositivos)
        "MapsBroker",       # Servicio de mapas de Windows
        "WbioSrvc",         # Servicio de biometría de Windows
        "WSearch",          # Servicio de búsqueda de Windows
        "RetailDemo",       # Servicio de modo demo para minoristas
        "PhoneSvc",         # Servicio de teléfono
        "CDPUserSvc",       # Servicios de usuario de la Plataforma de dispositivos conectados
        "MessagingService"  # Servicio de mensajería
    )
    foreach ($svc in $servicios) {
        try {
            if (Get-Service -Name $svc -ErrorAction SilentlyContinue) {
                Write-Log "Deteniendo servicio: $svc"
                Stop-Service -Name $svc -Force -ErrorAction Stop
                Set-Service -Name $svc -StartupType Disabled
            } else {
                Write-Log "Servicio '$svc' no encontrado. Saltando." -Color Yellow
            }
        } catch {
            Write-Log "ERROR al detener/deshabilitar '$svc': $_" -Color Red
        }
    }
    Write-Log "Servicios detenidos y deshabilitados." -Color Green
}

Function Remove-Bloatware {
    param ([switch]$Force)
    if (-not $Force) {
        Write-Host "ADVERTENCIA: Se eliminarán aplicaciones preinstaladas de la Microsoft Store. Esto es irreversible." -ForegroundColor Red
        $confirm = Read-Host "Deseas continuar? (S/N)"
        if ($confirm -ne 'S') {
            Write-Log "Acción cancelada por el usuario."
            return
        }
    }
    Write-Log "Eliminando aplicaciones de bloatware de la Microsoft Store..." -Color Cyan
    $appsToRemove = @(
        "*BingNews*",
        "*SkypeApp*",
        "*ZuneVideo*",
        "*ZuneMusic*",
        "*YourPhone*",
        "*Xbox*",
        "*MixedReality*",
        "*GetHelp*",
        "*MicrosoftSolitaireCollection*",
        "*Paint3D*",
        "*Messaging*",
        "*OneNote*"
    )
    foreach ($app in $appsToRemove) {
        try {
            Write-Log "Eliminando paquete que coincide con: $app"
            Get-AppxPackage -Name $app -AllUsers | Remove-AppxPackage -ErrorAction SilentlyContinue
            Get-AppxProvisionedPackage -Online | Where-Object { $_.PackageName -like $app } | Remove-AppxProvisionedPackage -Online -ErrorAction SilentlyContinue
        } catch {
            Write-Log "ERROR al eliminar el paquete '$app': $_" -Color Red
        }
    }
    Write-Log "Eliminación de bloatware completada." -Color Green
}

Function Update-System {
    Write-Log "Actualizando Windows y aplicaciones instaladas (EXTREMO)..." -Color Magenta
    
    # 1. Actualizar Windows (MANDATORIO)
    if (Check-Module "PSWindowsUpdate") {
        Write-Log "Buscando e instalando actualizaciones de Windows (incluye drivers)..."
        try {
            Get-WUList | Out-File -FilePath "$env:USERPROFILE\Desktop\Windows-Updates-List.txt"
            # Buscar e instalar todas las actualizaciones, incluyendo drivers, sin reiniciar automáticamente
            Install-WindowsUpdate -AcceptAll -IgnoreUserInput -Verbose -Confirm:$false -ErrorAction Stop
            Write-Log "Actualización de Windows finalizada. (Puede requerir reinicio)" -Color Green
        } catch {
            Write-Log "ERROR al actualizar Windows: $_" -Color Red
        }
    }

    # 2. Actualizar aplicaciones con Winget (MANDATORIO)
    if (Get-Command winget -ErrorAction SilentlyContinue) {
        Write-Log "Buscando y actualizando todas las aplicaciones con Winget..."
        try {
            winget upgrade --all --silent --accept-source-agreements --accept-package-agreements
            Write-Log "Actualización de aplicaciones con Winget finalizada." -Color Green
        } catch {
            Write-Log "ERROR al actualizar con Winget: $_" -Color Red
        }
    } else {
        Write-Log "El comando 'winget' no se encontró. No se pueden actualizar las aplicaciones." -Color Yellow
    }
    
    Write-Log "Proceso de actualización completo." -Color Green
}

Function Optimize-SSD {
    Write-Log "Iniciando optimización de SSD..." -Color Cyan
    try {
        # Deshabilita la hibernación para liberar espacio y reducir escrituras
        powercfg.exe /hibernate off
        # Deshabilita la indexación de archivos para la unidad C:
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name "NtfsDisableLastAccessUpdate" -Value 1 -Type DWord -Force
        # Deshabilita Superfetch/Prefetch (si el servicio no se detuvo antes)
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management\PrefetchParameters" -Name "EnablePrefetcher" -Value 0 -Type DWord -Force
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management\PrefetchParameters" -Name "EnableSuperfetch" -Value 0 -Type DWord -Force
        # Realiza la optimización (TRIM) de la unidad de sistema
        Optimize-Volume -DriveLetter C -ReTrim -Verbose -ErrorAction Stop
        Write-Log "Optimización de SSD completada." -Color Green
    } catch {
        Write-Log "ERROR al optimizar SSD: $_" -Color Red
    }
}

Function Optimize-RegistryTweaks {
    Write-Log "Aplicando Tweaks de Registro EXTREMOS para rendimiento..." -Color Cyan
    try {
        # 1. Reducir el tiempo de espera para matar servicios (apagado más rápido)
        $path = "HKLM:\SYSTEM\CurrentControlSet\Control"
        Set-ItemProperty -Path $path -Name "WaitToKillServiceTimeout" -Value "1000" -Type String -Force # Más agresivo (1000ms)
        Write-Log "WaitToKillServiceTimeout establecido a 1000ms."

        # 2. Deshabilitar PagingExecutive (fuerza a mantener componentes del kernel en memoria física)
        $path = "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management"
        Set-ItemProperty -Path $path -Name "DisablePagingExecutive" -Value 1 -Type DWord -Force
        Write-Log "DisablePagingExecutive habilitado (Kernel en RAM)."
        
        # 3. Optimizar UI Responsiveness
        $path = "HKCU:\Control Panel\Desktop"
        Set-ItemProperty -Path $path -Name "MenuShowDelay" -Value "0" -Type String -Force
        Set-ItemProperty -Path $path -Name "WaitToKillAppTimeout" -Value "2000" -Type String -Force
        Write-Log "Tweaks de UI aplicados para mayor rapidez."

        # 4. Deshabilitar Power Throttling
        $path = "HKLM:\SYSTEM\CurrentControlSet\Control\Power\PowerThrottling"
        If (-not (Test-Path $path)) { New-Item -Path $path -Force | Out-Null }
        Set-ItemProperty -Path $path -Name "PowerThrottlingOff" -Value 1 -Type DWord -Force
        Write-Log "PowerThrottling deshabilitado."

        # 5. Deshabilitar Network Throttling
        $path = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile"
        Set-ItemProperty -Path $path -Name "NetworkThrottlingIndex" -Value 0xFFFFFFFF -Type DWord -Force
        Write-Log "NetworkThrottlingIndex deshabilitado para mejor rendimiento de red."

        Write-Log "Optimización de registro finalizada." -Color Green
    } catch {
        Write-Log "ERROR al aplicar tweaks de registro: $_" -Color Red
    }
}

Function Disable-Telemetry {
    param ([switch]$Force)
    if (-not $Force) {
        Write-Host "ADVERTENCIA: Esta opción deshabilita TODA la recolección de datos y diagnóstico de Windows." -ForegroundColor Red
        $confirm = Read-Host "Deseas continuar? (S/N)"
        if ($confirm -ne 'S') {
            Write-Log "Acción cancelada por el usuario."
            return
        }
    }
    Write-Log "Deshabilitando Telemetría, Diagnóstico y Recolección de Datos..." -Color Cyan

    try {
        # 1. Deshabilitar Telemetría vía Registro
        $path = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection"
        If (-not (Test-Path $path)) { New-Item -Path $path -Force | Out-Null }
        Set-ItemProperty -Path $path -Name "AllowTelemetry" -Value 0 -Type DWord -Force
        Write-Log "Telemetría de Windows deshabilitada (Registro)."

        # 2. Deshabilitar Experiencias de Usuario Conectadas (Servicios)
        $serviceName = "DiagTrack"
        Stop-Service -Name $serviceName -Force -ErrorAction SilentlyContinue
        Set-Service -Name $serviceName -StartupType Disabled -ErrorAction SilentlyContinue
        Write-Log "Servicio de diagnóstico detenido/deshabilitado."

        # 3. Deshabilitar WAP Push Message Routing Service (Telemetría de mensajes)
        $serviceName = "dmwappushservice"
        Stop-Service -Name $serviceName -Force -ErrorAction SilentlyContinue
        Set-Service -Name $serviceName -StartupType Disabled -ErrorAction SilentlyContinue
        Write-Log "Servicio DMWAP Push detenido/deshabilitado."
        
        # 4. Deshabilitar Log de diagnóstico (Registry)
        $path = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Diagnostics\DiagTrack\Settings"
        If (-not (Test-Path $path)) { New-Item -Path $path -Force | Out-Null }
        Set-ItemProperty -Path $path -Name "DisableLog" -Value 1 -Type DWord -Force
        Write-Log "Log de diagnóstico deshabilitado."

        Write-Log "Telemetría y Diagnóstico deshabilitados." -Color Green

    } catch {
        Write-Log "ERROR al deshabilitar telemetría: $_" -Color Red
    }
}

# NUEVA FUNCIÓN: Bloqueo de Telemetría a nivel de Hosts File (Modo Extremo)
Function Block-TelemetryHosts {
    Write-Log "Aplicando bloqueo de Telemetría vía Hosts File (Modo Extremo)..." -Color Cyan
    $hostsPath = "$env:SystemRoot\System32\drivers\etc\hosts"
    $newHostsEntries = @(
        "127.0.0.1 telemetry.microsoft.com",
        "127.0.0.1 telecommand.telemetry.microsoft.com",
        "127.0.0.1 settings-win.data.microsoft.com",
        "127.0.0.1 vortex.data.microsoft.com",
        "127.0.0.1 vsgendm.trafficmanager.net"
    )

    try {
        # 1. Copia de seguridad del hosts original
        Copy-Item -Path $hostsPath -Destination "$hostsPath.bak" -Force -ErrorAction Stop
        Write-Log "Copia de seguridad del Hosts File creada en $hostsPath.bak"

        # 2. Leer contenido actual y verificar si ya existen las entradas
        $currentHosts = Get-Content -Path $hostsPath -ErrorAction Stop
        $updated = $false

        foreach ($entry in $newHostsEntries) {
            $domain = $entry.Split(' ')[1]
            if ($currentHosts -notlike "*$domain*") {
                Add-Content -Path $hostsPath -Value "`n$entry # LEVIATAN BLOCK"
                $updated = $true
            }
        }

        if ($updated) {
            ipconfig /flushdns | Out-Null
            Write-Log "Bloqueos de Telemetría agregados al Hosts File y caché DNS limpiada." -Color Green
        } else {
            Write-Log "Los bloqueos de Telemetría ya existen en el Hosts File. No se realizaron cambios." -Color Yellow
        }
    } catch {
        Write-Log "ERROR al modificar el Hosts File: $_. Revisa los permisos." -Color Red
    }
}

Function Clear-EventLogs {
    Write-Log "Limpiando registros de eventos..." -Color Cyan
    try {
        # Usa Get-WinEvent para logs modernos, es más completo.
        Get-WinEvent -ListLog * -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Log "Limpiando log: $($_.LogName)"
            Clear-EventLog -LogName $_.LogName -ErrorAction SilentlyContinue
        }
        Write-Log "Limpieza de registros de eventos completada." -Color Green
    } catch {
        Write-Log "ERROR al limpiar registros de eventos: $_" -Color Red
    }
}

Function Optimize-Startup {
    Write-Log "Optimizando tareas de inicio programadas..." -Color Cyan
    try {
        $tasksToDisable = @(
            "OneDrive Standalone Update Task",
            "GoogleUpdateTaskMachineUA",
            "GoogleUpdateTaskMachineCore",
            "Adobe Acrobat Update Task",
            "MicrosoftEdgeUpdateTaskMachineUA",
            "MicrosoftEdgeUpdateTaskMachineCore",
            "NvContainerTask" # NVIDIA Telemetry/Updates
        )
        foreach ($taskName in $tasksToDisable) {
            # Búsqueda más amplia en carpetas de tareas
            Get-ScheduledTask -TaskPath "\" | Where-Object { $_.TaskName -like "*$taskName*" } | ForEach-Object {
                Write-Log "Deshabilitando tarea de inicio: '$($_.TaskName)' en '$($_.TaskPath)'..."
                Disable-ScheduledTask -TaskPath $_.TaskPath -TaskName $_.TaskName -ErrorAction Stop
            }
        }
        Write-Log "Optimización de tareas de inicio completada." -Color Green
    } catch {
        Write-Log "ERROR al optimizar tareas de inicio: $_" -Color Red
    }
}

Function Diagnose-System {
    Write-Log "Iniciando diagnóstico y reparación del sistema..." -Color Cyan
    try {
        # 1. Escanea y repara archivos corruptos del sistema
        sfc /scannow
        
        # 2. Repara la imagen de Windows con DISM
        Write-Log "Ejecutando DISM para restaurar la salud de la imagen de Windows (ScanHealth)..."
        DISM /Online /Cleanup-Image /ScanHealth | Out-Null
        Write-Log "Ejecutando DISM para restaurar la salud de la imagen de Windows (RestoreHealth - Puede tardar)..."
        DISM /Online /Cleanup-Image /RestoreHealth | Out-Null # El Out-Null es para evitar el volcado de texto masivo en la consola
        
        # 3. Escanea el disco C: en busca de errores (programado para el siguiente reinicio si es necesario)
        Write-Log "Escaneando el disco C: en busca de errores (chkdsk)..."
        chkdsk C: /scan
        Write-Log "Diagnóstico de sistema finalizado." -Color Green
    } catch {
        Write-Log "ERROR al diagnosticar el sistema: $_" -Color Red
    }
}

Function Run-AllOptimizations {
    Write-Log "INICIANDO EJECUCIÓN COMPLETA DE TODAS LAS OPTIMIZACIONES (EXTREMO)" "Red"
    Write-Host "==========================================================================================" -ForegroundColor Red
    Write-Host " ADVERTENCIA: Esta opción ejecutará TODAS las optimizaciones de forma forzada y sin preguntar." -ForegroundColor Red
    Write-Host " Espere un tiempo considerable, especialmente en la actualización de Windows." -ForegroundColor Red
    Write-Host "==========================================================================================" -ForegroundColor Red
    Start-Sleep -Seconds 7
    
    New-SystemRestorePoint

    # Ejecuta todas las funciones de optimización
    Update-System # Se ejecuta primero para asegurar que el sistema está actualizado
    Clean-System
    Optimize-Network
    Optimize-Memory
    Stop-UnnecessaryServices -Force
    Remove-Bloatware -Force
    Optimize-SSD
    Defrag-Drives # AHORA IMPLEMENTADA
    Disable-Telemetry -Force
    Block-TelemetryHosts # NUEVO
    Optimize-RegistryTweaks 
    Clear-EventLogs
    Optimize-Startup
    Diagnose-System

    Write-Log "EJECUCIÓN COMPLETA FINALIZADA. SE RECOMIENDA REINICIAR EL SISTEMA." "Green"
}
#endregion

#region EJECUCIÓN
Check-Admin

Write-Log "✔️ Bienvenido a LEVIATÁN v15.0. Por favor, selecciona las opciones que deseas ejecutar." "Green"

while ($true) {
    Write-Host "`n================ MENÚ DE OPTIMIZACIÓN EXTREMA ================" -ForegroundColor Cyan
    Write-Host "1. Limpieza PROFUNDA (Incluye cachés, prefetch, navegadores)"
    Write-Host "2. Optimizar red (Restablecimiento TCP/IP)"
    Write-Host "3. Liberar memoria RAM (Forzar GC)"
    Write-Host "4. Detener servicios innecesarios (Ampliado v15.0)"
    Write-Host "5. Eliminar Bloatware (Ampliado v15.0 - REQUIERE CONFIRMACIÓN)"
    Write-Host "6. Actualizar Windows y programas instalados (COMPLETO)"
    Write-Host "7. Optimizar SSD (TRIM, Deshabilitar hibernación, Prefetch)"
    Write-Host "8. Desfragmentar discos duros no-SSD (AHORA IMPLEMENTADA)"
    Write-Host "9. Optimizar ajustes de rendimiento (Tweaks de Registro Extremos)"
    Write-Host "10. Deshabilitar Telemetría y Diagnóstico (Registro/Servicios - REQUIERE CONFIRMACIÓN)"
    Write-Host "11. Limpiar registros de eventos"
    Write-Host "12. Optimizar tareas de inicio (Incluye NVIDIA)"
    Write-Host "13. Diagnóstico y reparación del sistema (SFC/DISM)"
    Write-Host "14. Bloqueo de Telemetría vía Hosts File (NUEVO - Bloqueo DNS)"
    Write-Host "15. Ejecutar TODAS las optimizaciones (ADVERTENCIA: Extrema y Forzada)"
    Write-Host "0. Salir"
    Write-Host "======================================================" -ForegroundColor Cyan
    
    $selection = Read-Host "Ingresa el número de tu opción"

    switch ($selection) {
        "1" { Clean-System }
        "2" { Optimize-Network }
        "3" { Optimize-Memory }
        "4" { Stop-UnnecessaryServices }
        "5" { Remove-Bloatware }
        "6" { Update-System }
        "7" { Optimize-SSD }
        "8" { Defrag-Drives }
        "9" { Optimize-RegistryTweaks }
        "10" { Disable-Telemetry }
        "11" { Clear-EventLogs }
        "12" { Optimize-Startup }
        "13" { Diagnose-System }
        "14" { Block-TelemetryHosts } # Nueva opción
        "15" { Run-AllOptimizations } # Run All ahora es 15
        "0" { Write-Log "Saliendo del script. ¡Optimización finalizada!"; break }
        default { Write-Log "Opción no válida. Inténtalo de nuevo."; Start-Sleep -Seconds 1 }
    }
}
#endregion</code></pre>
        </div>
        <div class="flex justify-center mt-6 w-full">
            <button onclick="copyScript()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-transform duration-200 transform hover:scale-105 shadow-lg">
                📋 Copiar Script
            </button>
        </div>
    </div>
    
    <div id="message-box" class="fixed top-6 left-1/2 -translate-x-1/2 bg-gray-900 text-white py-3 px-6 rounded-xl shadow-2xl opacity-0 transition-opacity duration-500 pointer-events-none z-50"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-powershell.min.js"></script>
    <script>
        function showMessage(message, type = 'success') {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.className = `fixed top-6 left-1/2 -translate-x-1/2 py-3 px-6 rounded-xl shadow-2xl opacity-0 transition-opacity duration-500 pointer-events-none z-50`;
            
            if (type === 'success') {
                msgBox.classList.add('bg-green-600', 'text-white');
            } else if (type === 'error') {
                msgBox.classList.add('bg-red-600', 'text-white');
            } else {
                msgBox.classList.add('bg-gray-900', 'text-white');
            }

            msgBox.classList.add('opacity-100', 'pointer-events-auto');
            setTimeout(() => {
                msgBox.classList.remove('opacity-100', 'pointer-events-auto');
            }, 3000);
        }

        function copyScript() {
            // Se usa innerText para obtener el contenido formateado y limpio dentro del tag <code>
            const scriptText = document.getElementById('scriptContent').innerText;
            const tempTextArea = document.createElement('textarea');
            
            // Ocultar el textarea para que no sea visible
            tempTextArea.style.position = 'absolute';
            tempTextArea.style.left = '-9999px';
            
            tempTextArea.value = scriptText;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            tempTextArea.setSelectionRange(0, 99999); // Para compatibilidad móvil

            try {
                document.execCommand('copy');
                showMessage('✔️ Script copiado al portapapeles.');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessage('❌ Error al copiar el script.', 'error');
            } finally {
                document.body.removeChild(tempTextArea);
            }
        }
    </script>
</body>
</html>
