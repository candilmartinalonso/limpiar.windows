<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Script TITÁN v17.0 - A modernized web UI for the ultimate Windows optimization PowerShell script, featuring a responsive design, dark mode, interactive elements, and enhanced code readability.">
    <title>TITAN v17.0 - Windows Performance Optimizer</title>
    
    <!-- Load Tailwind CSS for modern and responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts for a cleaner typography (Inter is the standard) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Favicon using SVG -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%E2%9A%A1%3C/text%3E%3C/svg%3E">

    <style>
        /* ==========================================================================
           Custom Styles and Overrides
           ========================================================================== */
        :root {
            --background-light: #f9fafb;
            --text-light: #1f2937;
            --background-dark: #0d1117;
            --text-dark: #c9d1d9;
            --primary-color: #0ea5e9;
            --primary-hover: #0284c7;
            --secondary-color-dark: #1e293b;
            --secondary-color-light: #ffffff;
            --border-dark: #374151;
            --border-light: #d1d5db;
        }

        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Light mode theme */
        body.light {
            background-color: var(--background-light);
            color: var(--text-light);
        }
        
        /* Dark mode theme */
        body.dark {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }
        
        /* Custom styling for the code block */
        .code-block {
            background-color: var(--secondary-color-dark);
            border: 1px solid var(--border-dark);
        }

        .light .code-block {
            background-color: var(--secondary-color-light);
            border: 1px solid var(--border-light);
        }
        
        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
        }

        /* Syntax Highlighting Styles (Optimized for dark theme) */
        .token.comment, .token.prolog, .token.doctype, .token.cdata { color: #6a9955; } /* Green for comments */
        .token.punctuation { color: #d4d4d4; } /* White/Gray for symbols */
        .token.keyword, .token.atrule { color: #569cd6; } /* Blue for keywords (Function, If, For) */
        .token.property, .token.tag, .token.constant, .token.symbol { color: #b5cea8; } /* Light Green/Gray for variables/parameters */
        .token.selector, .token.string, .token.inserted { color: #ce9178; } /* Orange for strings/paths */
        .token.function { color: #dcdcaa; } /* Yellow for function names */
        .token.variable { color: #9cdcfe; } /* Light Blue for variable names */

        /* Highlighted line style for search */
        .highlighted-line {
            background-color: rgba(14, 165, 233, 0.2);
            display: block;
            border-left: 3px solid var(--primary-color);
            transition: background-color 0.3s;
        }
    </style>
</head>
<body class="dark antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-sky-400">
                <span aria-hidden="true" class="mr-2">⚡</span>TITAN v17.0
            </h1>
            <p class="mt-2 text-lg text-gray-400">An enhanced, single-file Windows performance and cleaning script.</p>
        </header>

        <main>
            <!-- Control Panel -->
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <!-- Search Input -->
                <div class="relative flex-grow">
                    <input type="text" id="searchBox" placeholder="Search in script (e.g., 'Optimize-Services')" class="w-full pl-10 pr-4 py-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-sky-500 text-gray-200 placeholder-gray-500">
                    <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <!-- Action Buttons -->
                <div class="flex items-center justify-center gap-2">
                    <button id="copyBtn" title="Copy Script" class="px-4 py-2 bg-sky-500 hover:bg-sky-600 rounded-lg font-semibold text-white transition-transform transform hover:scale-105">Copy</button>
                    <button id="downloadBtn" title="Download Script" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg font-semibold text-white transition-transform transform hover:scale-105">Download</button>
                    <button id="themeToggle" title="Toggle Theme" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg font-semibold text-white transition-transform transform hover:scale-105">🌓</button>
                </div>
            </div>

            <!-- Code Viewer -->
            <div class="code-block rounded-lg shadow-2xl overflow-hidden">
                <div class="px-4 py-2 bg-gray-900/50 border-b border-gray-700 flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-400">TITAN_v17.0_Optimizer.ps1</span>
                    <span id="line-count" class="text-sm text-gray-500"></span>
                </div>
                <pre class="overflow-auto p-4 text-sm" style="max-height: 60vh;"><code id="scriptContent" class="language-powershell"></code></pre>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>Designed for Windows 10/11. Run as Administrator for full optimization.</p>
        </footer>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300">
        Message
    </div>

    <!-- Prism.js for Syntax Highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-powershell.min.js"></script>

    <script>
        // ==========================================================================
        //  JavaScript Logic - TITAN v17.0 UI
        // ==========================================================================
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Elements ---
            const themeToggle = document.getElementById('themeToggle');
            const scriptContentEl = document.getElementById('scriptContent');
            const searchBox = document.getElementById('searchBox');
            const copyBtn = document.getElementById('copyBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const toast = document.getElementById('toast');
            const lineCountEl = document.getElementById('line-count');

            // --- The PowerShell script content (Fully translated and enhanced) ---
            const scriptContentText = `# ===================================================================================================
#   PowerScript Optimizer TITAN v17.0 - Modern, Safe, and Reversible Edition
#   Goal: Deep cleanup, maximum acceleration, privacy control, and system stability.
#   WARNING: ALWAYS RUN AS ADMINISTRATOR.
#
#   This script is structured for maximum safety, including restoration options.
# ===================================================================================================

#region GLOBAL VARIABLES AND LOG CONFIGURATION
$logPath = "$env:USERPROFILE\\Desktop"
$logFile = "$logPath\\Titan-Optimizer-Log-v17.0.txt"
$backupPath = "$logPath\\Titan_Backups"
if (-not (Test-Path $backupPath)) { New-Item -Path $backupPath -ItemType Directory -Force | Out-Null }

# Enhanced Logging Function for clarity
Function Write-Log { 
    param ([string]$Message, [string]$Color = 'Gray', [string]$Level = 'INFO')
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logEntry = "[$timestamp] [$Level] :: $Message"
    Write-Host $logEntry -ForegroundColor $Color
    Add-Content -Path $logFile -Value $logEntry
}
#endregion

#region VALIDATION AND UTILITY FUNCTIONS
Function Check-Admin {
    if (-NOT ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
        Write-Log "This script requires Administrator privileges. Please restart the terminal as Administrator." 'Red' 'FATAL'
        Start-Sleep -Seconds 10
        Exit
    }
}

Function New-SystemRestorePoint {
    Write-Log "Creating a system restore point..." 'Yellow' 'ACTION'
    try {
        Checkpoint-Computer -Description "TITAN v17.0 - Before Optimization" -RestorePointType "MODIFY_SETTINGS"
        Write-Log "Restore point created successfully." 'Green' 'SUCCESS'
    } catch {
        Write-Log "Could not create restore point. Ensure system protection is enabled." 'Red' 'ERROR'
    }
}

# Backup Registry Key function
Function Backup-RegistryKey {
    param ([string]$RegistryPath)
    $keyName = $RegistryPath.Split('\\')[-1]
    $backupFile = "$backupPath\\RegBackup-$keyName-$(Get-Date -f yyyyMMddHHmmss).reg"
    Write-Log "Backing up registry key: $RegistryPath" 'Cyan' 'INFO'
    try {
        Start-Process "reg" -ArgumentList "export \`"$RegistryPath\`" \`"$backupFile\`" /y" -Wait -NoNewWindow
        Write-Log "Backup of '$keyName' created in '$backupFile'." 'Green' 'SUCCESS'
    } catch {
        Write-Log "Could not backup key '$RegistryPath'." 'Red' 'ERROR'
    }
}
#endregion

#region DEEP CLEANUP FUNCTIONS (Requirement 1)
Function Clean-System {
    Write-Log "Starting DEEP system file cleanup..." 'Cyan' 'SECTION'
    
    # 1. Cleanup of temporary directories
    Get-ChildItem -Path $env:TEMP, "$env:WINDIR\\Temp" -Recurse -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
    Write-Log "Standard temporary directories cleaned." 'Green' 'SUCCESS'

    # 2. Cleanup of Windows Caches (Component Store, Software Distribution)
    # Uses DISM for deep cleanup of the component store (WinSxS)
    DISM.exe /online /Cleanup-Image /StartComponentCleanup /ResetBase | Out-Null
    # Delete Windows Update download files
    Remove-Item -Path "$env:SystemRoot\\SoftwareDistribution\\Download\\*" -Recurse -Force -ErrorAction SilentlyContinue
    Write-Log "Windows Update and Component Store caches cleaned." 'Green' 'SUCCESS'

    # 3. Cleanup of Prefetch and Recycle Bin
    Remove-Item -Path "$env:SystemRoot\\Prefetch\\*.pf" -Force -ErrorAction SilentlyContinue
    Clear-RecycleBin -Force -ErrorAction SilentlyContinue
    Write-Log "Prefetch files and Recycle Bin emptied." 'Green' 'SUCCESS'
    
    # 4. Cleanup of browser caches (Chrome, Edge, Firefox)
    $browserCaches = @(
        "$env:LOCALAPPDATA\\Google\\Chrome\\User Data\\Default\\Cache\\*",
        "$env:LOCALAPPDATA\\Microsoft\\Edge\\User Data\\Default\\Cache\\*",
        "$env:LOCALAPPDATA\\Mozilla\\Firefox\\Profiles\\*\\cache2\\entries\\*"
    )
    $browserCaches | ForEach-Object { Remove-Item -Path $_ -Recurse -Force -ErrorAction SilentlyContinue }
    Write-Log "Main browser caches cleaned." 'Green' 'SUCCESS'
}

Function Clear-EventLogs {
    Write-Log "Clearing all Windows Event Logs..." 'Cyan' 'SECTION'
    Get-WinEvent -ListLog * -ErrorAction SilentlyContinue | ForEach-Object {
        $logName = $_.LogName
        Clear-EventLog -LogName $logName -ErrorAction SilentlyContinue
    }
    Write-Log "Event log cleanup completed." 'Green' 'SUCCESS'
}
#endregion

#region SYSTEM OPTIMIZATION FUNCTIONS (Requirements 2 & 3)
Function Optimize-Services {
    Write-Log "Optimizing Windows services..." 'Cyan' 'SECTION'
    # NOTE (Requirement 3): Print Spooler (Spooler) is EXCLUDED from this list to ensure printing functionality.
    # Services disabled are typically Telemetry, Diagnostic, Indexing, and unnecessary Networking services.
    $servicesToDisable = @("DiagTrack", "dmwappushservice", "WMPNetworkSvc", "Fax", "SysMain", "WSearch", "RemoteRegistry", "lfsvc")
    $serviceStates = @{}

    foreach ($svc in $servicesToDisable) {
        try {
            $service = Get-Service -Name $svc -ErrorAction Stop
            # Save current state before modifying
            $serviceStates[$svc] = $service.StartType
            Write-Log "Disabling service: $svc (Original state: $($service.StartType))" 'Yellow' 'ACTION'
            Stop-Service -Name $svc -Force -ErrorAction Stop
            Set-Service -Name $svc -StartupType Disabled -ErrorAction Stop
        } catch {
            Write-Log "Service '$svc' not found or could not be modified." 'Red' 'ERROR'
        }
    }
    # Export original states for restoration
    $serviceStates | Export-CliXml -Path "$backupPath\\service_states_backup.xml"
    Write-Log "Unnecessary services disabled. State backup created." 'Green' 'SUCCESS'
    Write-Log "Print Spooler service (Spooler) remains ACTIVE, as requested." 'Green' 'INFO'
}

Function Remove-Bloatware {
    Write-Log "Removing pre-installed applications (Bloatware)..." 'Cyan' 'SECTION'
    $appsToRemove = @("*BingNews*", "*SkypeApp*", "*Zune*", "*YourPhone*", "*Xbox*", "*MixedReality*", "*GetHelp*", "*Solitaire*", "*Paint3D*", "*People*", "*WindowsFeedbackHub*", "*WindowsMaps*", "*Clipchamp*", "*Teams*")
    
    foreach ($app in $appsToRemove) {
        Write-Log "Attempting to remove packages matching: $app" 'Yellow' 'ACTION'
        # 1. Remove for the current user
        Get-AppxPackage -Name $app -AllUsers | Remove-AppxPackage -ErrorAction SilentlyContinue
        # 2. Remove provisioning for new users
        Get-AppxProvisionedPackage -Online | Where-Object { $_.PackageName -like $app } | Remove-AppxProvisionedPackage -Online -ErrorAction SilentlyContinue
    }
    Write-Log "Bloatware removal completed." 'Green' 'SUCCESS'
}

Function Optimize-PerformanceTweaks {
    Write-Log "Applying performance tweaks (Registry and System)..." 'Cyan' 'SECTION'
    
    # 1. Faster shutdown tweaks (WaitToKillServiceTimeout)
    $regPath = "HKLM:\\SYSTEM\\CurrentControlSet\\Control"
    Backup-RegistryKey -RegistryPath $regPath
    Set-ItemProperty -Path $regPath -Name "WaitToKillServiceTimeout" -Value "2000" -Type String -Force
    Write-Log "Service shutdown wait time reduced to 2000ms." 'Green' 'SUCCESS'

    # 2. Disable Telemetry (AllowTelemetry)
    $regPath = "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\DataCollection"
    Backup-RegistryKey -RegistryPath $regPath
    If (-not (Test-Path $regPath)) { New-Item -Path $regPath -Force | Out-Null }
    Set-ItemProperty -Path $regPath -Name "AllowTelemetry" -Value 0 -Type DWord -Force
    Write-Log "Windows Telemetry disabled." 'Green' 'SUCCESS'

    # 3. Optimize UI (Faster Menus) (MenuShowDelay)
    $regPath = "HKCU:\\Control Panel\\Desktop"
    Backup-RegistryKey -RegistryPath $regPath
    Set-ItemProperty -Path $regPath -Name "MenuShowDelay" -Value "100" -Type String -Force
    Write-Log "Menu delay reduced for a snappier UI." 'Green' 'SUCCESS'
}

# Optimize visual effects
Function Set-VisualEffects {
    Write-Log "Optimizing visual effects for maximum performance..." 'Cyan' 'SECTION'
    $regPath = "HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\VisualEffects"
    Backup-RegistryKey -RegistryPath $regPath
    # '2' means "Adjust for best performance", disabling all visual effects.
    Set-ItemProperty -Path $regPath -Name "VisualFXSetting" -Value 2 -Type DWord -Force
    Write-Log "Visual effects configured for 'Best Performance'." 'Green' 'SUCCESS'
    Write-Log "A Windows Explorer or system restart is recommended to apply visual changes." 'Yellow' 'INFO'
}

# Unlock and activate Ultimate Performance power plan
Function Unlock-UltimatePerformance {
    Write-Log "Activating 'Ultimate Performance' power plan..." 'Cyan' 'SECTION'
    $ultimatePlanGuid = "e9a42b02-d5df-448d-aa00-03f14749eb61"
    $currentPlans = powercfg /LIST
    if ($currentPlans -notmatch $ultimatePlanGuid) {
        Write-Log "The 'Ultimate Performance' plan is not present. Importing it..." 'Yellow' 'ACTION'
        # Duplicates the existing High Performance scheme GUID to unlock Ultimate Performance
        powercfg -duplicatescheme 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c $ultimatePlanGuid | Out-Null
    }
    powercfg /SETACTIVE $ultimatePlanGuid | Out-Null
    Write-Log "'Ultimate Performance' power plan activated." 'Green' 'SUCCESS'
}
#endregion

#region UPDATE FUNCTION (Requirement 4)
Function Update-SystemAndApps {
    Write-Log "Starting System and Application Updates..." 'Cyan' 'SECTION'
    
    # 1. Windows Updates (Requires PSWindowsUpdate Module)
    Write-Log "Attempting Windows Updates (requires 'PSWindowsUpdate' module)..." 'Yellow' 'WARN'
    try {
        # Check if PSWindowsUpdate is installed
        if (Get-Module -ListAvailable -Name PSWindowsUpdate) {
            # Install all available updates without user confirmation
            # Note: This may force an automatic reboot if critical updates are found.
            Get-WindowsUpdate -Install -AcceptAll -AutoReboot | Out-Null
            Write-Log "Windows Update command executed. Check console for details." 'Green' 'SUCCESS'
        } else {
            Write-Log "Module 'PSWindowsUpdate' not found. To enable, run: Install-Module -Name PSWindowsUpdate -Force" 'Red' 'ERROR'
        }
    } catch {
        Write-Log "Error during Windows Update check: $($_.Exception.Message)" 'Red' 'ERROR'
    }

    # 2. Installed Program Updates (Uses Winget)
    Write-Log "Attempting to update installed programs using Winget..." 'Yellow' 'ACTION'
    try {
        # Check if winget is available
        $wingetPath = (Get-Command winget -ErrorAction SilentlyContinue).Source
        if ($wingetPath) {
            # Upgrade all installed packages silently
            & "$wingetPath" upgrade --all --silent --accept-package-agreements --accept-source-agreements
            Write-Log "Winget command executed successfully to update all applications." 'Green' 'SUCCESS'
        } else {
            Write-Log "Winget (Windows Package Manager) not found. Skipping application updates." 'Red' 'ERROR'
        }
    } catch {
        Write-Log "Error during Winget update: $($_.Exception.Message)" 'Red' 'ERROR'
    }
}
#endregion

#region RESTORATION FUNCTIONS (CRITICAL FOR SAFETY)
Function Restore-Services {
    Write-Log "Restoring services to their original state..." 'Cyan' 'SECTION'
    $backupFile = "$backupPath\\service_states_backup.xml"
    if (Test-Path $backupFile) {
        $serviceStates = Import-CliXml -Path $backupFile
        foreach ($svc in $serviceStates.GetEnumerator()) {
            try {
                Write-Log "Restoring service: $($svc.Name) to '$($svc.Value)'" 'Yellow' 'ACTION'
                Set-Service -Name $svc.Name -StartupType $svc.Value -ErrorAction Stop
            } catch {
                Write-Log "Could not restore service '$($svc.Name)'." 'Red' 'ERROR'
            }
        }
        Write-Log "Service restoration completed." 'Green' 'SUCCESS'
    } else {
        Write-Log "No service backup file found." 'Red' 'ERROR'
    }
}

Function Restore-PowerPlan {
    Write-Log "Restoring 'Balanced' power plan..." 'Cyan' 'SECTION'
    $balancedPlanGuid = "381b4222-f694-41f0-9685-ff5bb260df2e"
    powercfg /SETACTIVE $balancedPlanGuid
    Write-Log "'Balanced' power plan restored." 'Green' 'SUCCESS'
}
#endregion

#region MAIN MENU AND EXECUTION
Check-Admin
Write-Log "✔️ Welcome to TITAN v17.0. The LOG will be saved to '$logFile'." 'Green' 'SYSTEM'

while ($true) {
    Write-Host "\n"
    Write-Host "========================== TITAN v17.0 OPTIMIZATION MENU ==========================" -ForegroundColor Cyan
    Write-Host "    [DEEP CLEANUP]                           [PERFORMANCE OPTIMIZATION]"
    Write-Host " 1. Complete System Cleanup                 5. Optimize Services (Creates backup)"
    Write-Host " 2. Remove Bloatware (Pre-installed Apps)   6. Registry Performance Tweaks"
    Write-Host " 3. Clear Windows Event Logs                7. Optimize Visual Effects (Faster UI)"
    Write-Host "    [UPDATES & NETWORKING]                   8. Activate 'Ultimate Performance' Power Plan"
    Write-Host " 4. Update System and Apps (Requires Winget/Modules)"
    Write-Host "    [ADDITIONAL UTILITIES]                      [GLOBAL ACTIONS]"
    Write-Host " 9. Block Telemetry (Hosts File)             A. APPLY ALL (Cleanup and Optimization)"
    Write-Host " 10. Add 'Take Ownership' to Context Menu   S. EXIT"
    Write-Host "==========================================================================================" -ForegroundColor Cyan
    Write-Host "    [SAFE RESTORATION]"
    Write-Host " R1. Restore Services to Previous State"
    Write-Host " R2. Restore 'Balanced' Power Plan"
    Write-Host "==========================================================================================" -ForegroundColor Cyan
    
    $selection = Read-Host "➡️  Enter your option and press Enter"

    switch ($selection.ToUpper()) {
        "1" { Clean-System }
        "2" { Remove-Bloatware }
        "3" { Clear-EventLogs }
        "4" { Update-SystemAndApps }
        "5" { Optimize-Services }
        "6" { Optimize-PerformanceTweaks }
        "7" { Set-VisualEffects }
        "8" { Unlock-UltimatePerformance }
        "9" { 
            # Block-TelemetryHosts logic
            $hostsPath = "$env:SystemRoot\\System32\\drivers\\etc\\hosts"
            $telemetryDomains = @("telemetry.microsoft.com", "vortex.data.microsoft.com", "settings-win.data.microsoft.com")
            Copy-Item -Path $hostsPath -Destination "$backupPath\\hosts.bak" -Force
            $currentHosts = Get-Content -Path $hostsPath
            foreach ($domain in $telemetryDomains) {
                if ($currentHosts -notcontains $domain) {
                    Add-Content -Path $hostsPath -Value "0.0.0.0 $domain # Blocked by TITAN Optimizer"
                }
            }
            ipconfig /flushdns | Out-Null
            Write-Log "Telemetry domains blocked and DNS cache flushed." 'Green' 'SUCCESS'
        }
        "10" { 
            # Add-TakeOwnership logic
            $regKey = "HKCR\\*\\shell\\runas"
            if (-not (Test-Path $regKey)) {
                New-Item -Path $regKey -Force | Out-Null
                Set-ItemProperty -Path $regKey -Name "(Default)" -Value "Take Ownership" -Force
                $commandPath = "$regKey\\command"
                New-Item -Path $commandPath -Force | Out-Null
                Set-ItemProperty -Path $commandPath -Name "(Default)" -Value 'cmd.exe /c takeown /f "%1" && icacls "%1" /grant administrators:F' -Force
                Write-Log "'Take Ownership' option added successfully." 'Green' 'SUCCESS'
            } else {
                Write-Log "'Take Ownership' option appears to exist already." 'Yellow' 'INFO'
            }
        }
        "R1" { Restore-Services }
        "R2" { Restore-PowerPlan }
        "A" { 
            Write-Log "Executing all cleanup and performance optimizations..." 'Magenta' 'GLOBAL'
            New-SystemRestorePoint
            Clean-System
            Remove-Bloatware
            Clear-EventLogs
            # Block-TelemetryHosts logic here for 'A' option
            $hostsPath = "$env:SystemRoot\\System32\\drivers\\etc\\hosts"
            $telemetryDomains = @("telemetry.microsoft.com", "vortex.data.microsoft.com", "settings-win.data.microsoft.com")
            Copy-Item -Path $hostsPath -Destination "$backupPath\\hosts.bak" -Force
            $currentHosts = Get-Content -Path $hostsPath
            foreach ($domain in $telemetryDomains) {
                if ($currentHosts -notcontains $domain) {
                    Add-Content -Path $hostsPath -Value "0.0.0.0 $domain # Blocked by TITAN Optimizer"
                }
            }
            ipconfig /flushdns | Out-Null
            Write-Log "Telemetry domains blocked and DNS cache flushed." 'Green' 'SUCCESS'
            # End Block-TelemetryHosts logic
            Optimize-Services
            Optimize-PerformanceTweaks
            Set-VisualEffects
            Unlock-UltimatePerformance
            Write-Log "ALL TASKS COMPLETED. A system restart is recommended." 'Green' 'SYSTEM'
        }
        "S" { Write-Log "Exiting script. System optimized!"; break }
        default { Write-Log "Invalid option. Please try again." 'Red' 'WARN' }
    }
}
#endregion`;

            // --- State ---
            let currentTheme = localStorage.getItem('theme') || 'dark';

            // --- Functions ---
            
            /** Applies the current theme to the body. */
            const applyTheme = () => {
                document.body.className = '';
                document.body.classList.add(currentTheme, 'antialiased');
                themeToggle.textContent = currentTheme === 'dark' ? '☀️' : '🌓';
            };

            /** Toggles the theme between light and dark. */
            const toggleTheme = () => {
                currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', currentTheme);
                applyTheme();
                showToast(`Switched to ${currentTheme} mode`);
            };

            /** Displays a toast notification. */
            const showToast = (message, type = 'success') => {
                toast.textContent = message;
                toast.className = `fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300`;
                toast.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
                
                // Animate in
                setTimeout(() => {
                    toast.classList.remove('opacity-0', 'translate-y-10');
                }, 10);
                
                // Animate out
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-10');
                }, 3000);
            };

            /** Copies the script content to the clipboard. */
            const copyScript = () => {
                // Fallback method using a temporary textarea
                const textArea = document.createElement('textarea');
                textArea.value = scriptContentText;
                textArea.style.position = 'fixed';
                textArea.style.top = '-9999px';
                textArea.style.left = '-9999px';

                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showToast('✅ Script copied to clipboard!');
                    } else {
                        showToast('❌ Failed to copy script.', 'error');
                    }
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    showToast('❌ Failed to copy script.', 'error');
                }

                document.body.removeChild(textArea);
            };
            
            /** Downloads the script as a .ps1 file. */
            const downloadScript = () => {
                const blob = new Blob([scriptContentText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'TITAN_v17.0_Optimizer.ps1';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('⬇️ Script download started.');
            };

            /** Initializes and highlights the script content. */
            const renderScript = () => {
                scriptContentEl.textContent = scriptContentText;
                Prism.highlightElement(scriptContentEl);
                const lineCount = scriptContentText.split('\n').length;
                lineCountEl.textContent = `${lineCount} lines`;
            };

            /** Handles the search functionality. */
            const handleSearch = () => {
                const query = searchBox.value.toLowerCase();
                renderScript(); // Reset highlights

                if (query.length < 3) {
                    return;
                }

                const lines = scriptContentEl.innerHTML.split('\n');
                let firstMatch = null;
                const highlightedLines = lines.map((line, index) => {
                    if (line.toLowerCase().includes(query)) {
                        if (!firstMatch) firstMatch = index;
                        // Use a regex to wrap the match in a mark tag for styling
                        const regex = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                        const highlightedLine = line.replace(regex, `<mark class="bg-sky-500/30 px-1 rounded">\$1</mark>`);
                        return `<span class="highlighted-line">${highlightedLine}</span>`;
                    }
                    return line;
                }).join('\n');

                scriptContentEl.innerHTML = highlightedLines;
                
                // Scroll to the first match
                if (firstMatch !== null) {
                    const firstMatchElement = scriptContentEl.querySelector('.highlighted-line');
                    if (firstMatchElement) {
                        firstMatchElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            };

            // --- Event Listeners ---
            themeToggle.addEventListener('click', toggleTheme);
            copyBtn.addEventListener('click', copyScript);
            downloadBtn.addEventListener('click', downloadScript);
            searchBox.addEventListener('input', handleSearch);

            // --- Initialization ---
            applyTheme();
            renderScript();
        });
    </script>
</body>
</html>
