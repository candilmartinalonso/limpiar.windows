<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Script TIT√ÅN v17.0 - A modernized web UI for the ultimate Windows optimization PowerShell script, featuring a responsive design, dark mode, interactive elements, and enhanced code readability.">
    <title>TIT√ÅN v17.0 - Windows Performance Optimizer</title>
    
    <!-- Load Tailwind CSS for modern and responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts for a cleaner typography (Inter is the standard) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Favicon using SVG -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%E2%9A%A1%3C/text%3E%3C/svg%3E">

    <style>
        /* ==========================================================================
           Custom Styles and Overrides
           ========================================================================== */
        :root {
            --background-light: #f9fafb;
            --text-light: #1f2937;
            --background-dark: #0d1117;
            --text-dark: #c9d1d9;
            --primary-color: #0ea5e9;
            --primary-hover: #0284c7;
            --secondary-color-dark: #1e293b;
            --secondary-color-light: #ffffff;
            --border-dark: #374151;
            --border-light: #d1d5db;
        }

        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Light mode theme */
        body.light {
            background-color: var(--background-light);
            color: var(--text-light);
        }
        
        /* Dark mode theme */
        body.dark {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }
        
        /* Custom styling for the code block */
        .code-block {
            background-color: var(--secondary-color-dark);
            border: 1px solid var(--border-dark);
        }

        .light .code-block {
            background-color: var(--secondary-color-light);
            border: 1px solid var(--border-light);
        }
        
        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
        }

        /* Syntax Highlighting Styles (Simplified for general use) */
        /* These colors are optimized for the dark theme */
        .token.comment, .token.prolog, .token.doctype, .token.cdata { color: #6a9955; } /* Green for comments */
        .token.punctuation { color: #d4d4d4; } /* White/Gray for symbols */
        .token.keyword, .token.atrule { color: #569cd6; } /* Blue for keywords (Function, If, For) */
        .token.property, .token.tag, .token.constant, .token.symbol { color: #b5cea8; } /* Light Green/Gray for variables/parameters */
        .token.selector, .token.string, .token.inserted { color: #ce9178; } /* Orange for strings/paths */
        .token.function { color: #dcdcaa; } /* Yellow for function names */
        .token.variable { color: #9cdcfe; } /* Light Blue for variable names */

        /* Highlighted line style for search */
        .highlighted-line {
            background-color: rgba(14, 165, 233, 0.2);
            display: block;
            border-left: 3px solid var(--primary-color);
            transition: background-color 0.3s;
        }
    </style>
</head>
<body class="dark antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-sky-400">
                <span aria-hidden="true" class="mr-2">‚ö°</span>TIT√ÅN v17.0
            </h1>
            <p class="mt-2 text-lg text-gray-400">An enhanced, single-file Windows performance and cleaning script.</p>
        </header>

        <main>
            <!-- Control Panel -->
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <!-- Search Input -->
                <div class="relative flex-grow">
                    <input type="text" id="searchBox" placeholder="Search in script (e.g., 'Optimize-Services')" class="w-full pl-10 pr-4 py-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-sky-500 text-gray-200 placeholder-gray-500">
                    <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <!-- Action Buttons -->
                <div class="flex items-center justify-center gap-2">
                    <button id="copyBtn" title="Copy Script" class="px-4 py-2 bg-sky-500 hover:bg-sky-600 rounded-lg font-semibold text-white transition-transform transform hover:scale-105">Copy</button>
                    <button id="downloadBtn" title="Download Script" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg font-semibold text-white transition-transform transform hover:scale-105">Download</button>
                    <button id="themeToggle" title="Toggle Theme" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg font-semibold text-white transition-transform transform hover:scale-105">üåì</button>
                </div>
            </div>

            <!-- Code Viewer -->
            <div class="code-block rounded-lg shadow-2xl overflow-hidden">
                <div class="px-4 py-2 bg-gray-900/50 border-b border-gray-700 flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-400">TITAN_v17.0_Optimizer.ps1</span>
                    <span id="line-count" class="text-sm text-gray-500"></span>
                </div>
                <pre class="overflow-auto p-4 text-sm" style="max-height: 60vh;"><code id="scriptContent" class="language-powershell"></code></pre>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>Designed for Windows 10/11. Run as Administrator for full optimization.</p>
        </footer>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300">
        Message
    </div>

    <!-- Prism.js for Syntax Highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-powershell.min.js"></script>

    <script>
        // ==========================================================================
        //  JavaScript Logic - TIT√ÅN v17.0 UI
        // ==========================================================================
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Elements ---
            const themeToggle = document.getElementById('themeToggle');
            const scriptContentEl = document.getElementById('scriptContent');
            const searchBox = document.getElementById('searchBox');
            const copyBtn = document.getElementById('copyBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const toast = document.getElementById('toast');
            const lineCountEl = document.getElementById('line-count');

            // --- The PowerShell script content (UPDATED: Print Spooler removed from disable list) ---
            const scriptContentText = `# ===================================================================================================
#   PowerScript Optimizador TIT√ÅN v17.0 - Edici√≥n Moderna, Segura y Reversible
#   Objetivo: Limpieza Profunda, aceleraci√≥n m√°xima, control de privacidad y estabilidad del sistema.
#   ADVERTENCIA: EJECUTAR SIEMPRE COMO ADMINISTRADOR.
#
#   Este script ha sido reestructurado para ofrecer m√°xima seguridad, incluyendo opciones de restauraci√≥n.
# ===================================================================================================

#region VARIABLES GLOBALES Y CONFIGURACI√ìN DEL LOG
$logPath = "$env:USERPROFILE\\Desktop"
$logFile = "$logPath\\Titan-Optimizer-Log-v17.0.txt"
$backupPath = "$logPath\\Titan_Backups"
if (-not (Test-Path $backupPath)) { New-Item -Path $backupPath -ItemType Directory -Force | Out-Null }

# Funci√≥n de Log mejorada para mayor claridad
Function Write-Log { 
    param ([string]$Message, [string]$Color = 'Gray', [string]$Level = 'INFO')
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logEntry = "[$timestamp] [$Level] :: $Message"
    Write-Host $logEntry -ForegroundColor $Color
    Add-Content -Path $logFile -Value $logEntry
}
#endregion

#region FUNCIONES DE VALIDACI√ìN Y UTILER√çAS
Function Check-Admin {
    if (-NOT ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
        Write-Log "Este script requiere privilegios de Administrador. Por favor, reinicia la terminal como Administrador." 'Red' 'FATAL'
        Start-Sleep -Seconds 10
        Exit
    }
}

Function New-SystemRestorePoint {
    Write-Log "Creando un punto de restauraci√≥n del sistema..." 'Yellow' 'ACTION'
    try {
        Checkpoint-Computer -Description "TIT√ÅN v17.0 - Antes de la optimizaci√≥n" -RestorePointType "MODIFY_SETTINGS"
        Write-Log "Punto de restauraci√≥n creado con √©xito." 'Green' 'SUCCESS'
    } catch {
        Write-Log "No se pudo crear el punto de restauraci√≥n. Aseg√∫rate de que la protecci√≥n del sistema est√© habilitada." 'Red' 'ERROR'
    }
}

# NUEVA FUNCI√ìN: Respaldo de claves de registro
Function Backup-RegistryKey {
    param ([string]$RegistryPath)
    $keyName = $RegistryPath.Split('\\')[-1]
    $backupFile = "$backupPath\\RegBackup-$keyName-$(Get-Date -f yyyyMMddHHmmss).reg"
    Write-Log "Respaldando clave de registro: $RegistryPath" 'Cyan' 'INFO'
    try {
        Start-Process "reg" -ArgumentList "export \`"$RegistryPath\`" \`"$backupFile\`" /y" -Wait -NoNewWindow
        Write-Log "Respaldo de '$keyName' creado en '$backupFile'." 'Green' 'SUCCESS'
    } catch {
        Write-Log "No se pudo respaldar la clave '$RegistryPath'." 'Red' 'ERROR'
    }
}
#endregion

#region FUNCIONES DE LIMPIEZA PROFUNDA
Function Clean-System {
    Write-Log "Iniciando limpieza PROFUNDA de archivos del sistema..." 'Cyan' 'SECTION'
    
    # 1. Limpieza de directorios temporales
    Get-ChildItem -Path $env:TEMP, "$env:WINDIR\\Temp" -Recurse -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
    Write-Log "Directorios temporales est√°ndar limpios." 'Green' 'SUCCESS'

    # 2. Limpieza de cach√©s de Windows (Componentes, Distribuci√≥n de Software)
    # Usa DISM para la limpieza profunda de la tienda de componentes (WinSxS)
    DISM.exe /online /Cleanup-Image /StartComponentCleanup /ResetBase | Out-Null
    # Elimina archivos de descarga de Windows Update
    Remove-Item -Path "$env:SystemRoot\\SoftwareDistribution\\Download\\*" -Recurse -Force -ErrorAction SilentlyContinue
    Write-Log "Cach√©s de Windows Update y Component Store limpiados." 'Green' 'SUCCESS'

    # 3. Limpieza de Prefetch y Papelera de Reciclaje
    Remove-Item -Path "$env:SystemRoot\\Prefetch\\*.pf" -Force -ErrorAction SilentlyContinue
    Clear-RecycleBin -Force -ErrorAction SilentlyContinue
    Write-Log "Archivos Prefetch y Papelera de Reciclaje vaciados." 'Green' 'SUCCESS'
    
    # 4. Limpieza de cach√©s de navegadores (Chrome, Edge, Firefox)
    $browserCaches = @(
        "$env:LOCALAPPDATA\\Google\\Chrome\\User Data\\Default\\Cache\\*",
        "$env:LOCALAPPDATA\\Microsoft\\Edge\\User Data\\Default\\Cache\\*",
        "$env:LOCALAPPDATA\\Mozilla\\Firefox\\Profiles\\*\\cache2\\entries\\*"
    )
    $browserCaches | ForEach-Object { Remove-Item -Path $_ -Recurse -Force -ErrorAction SilentlyContinue }
    Write-Log "Cach√©s de navegadores principales limpiadas." 'Green' 'SUCCESS'
}

Function Clear-EventLogs {
    Write-Log "Limpiando todos los registros de eventos de Windows..." 'Cyan' 'SECTION'
    Get-WinEvent -ListLog * -ErrorAction SilentlyContinue | ForEach-Object {
        $logName = $_.LogName
        Clear-EventLog -LogName $logName -ErrorAction SilentlyContinue
    }
    Write-Log "Limpieza de registros de eventos completada." 'Green' 'SUCCESS'
}
#endregion

#region FUNCIONES DE OPTIMIZACI√ìN DEL SISTEMA
Function Optimize-Services {
    Write-Log "Optimizando servicios de Windows..." 'Cyan' 'SECTION'
    # NOTA: Print Spooler (Spooler) se excluye de esta lista para asegurar la funcionalidad de impresi√≥n.
    $servicesToDisable = @("DiagTrack", "dmwappushservice", "WMPNetworkSvc", "Fax", "SysMain", "WSearch", "RemoteRegistry", "lfsvc")
    $serviceStates = @{}

    foreach ($svc in $servicesToDisable) {
        try {
            $service = Get-Service -Name $svc -ErrorAction Stop
            # Guarda el estado actual antes de modificarlo
            $serviceStates[$svc] = $service.StartType
            Write-Log "Deshabilitando servicio: $svc (Estado original: $($service.StartType))" 'Yellow' 'ACTION'
            Stop-Service -Name $svc -Force -ErrorAction Stop
            Set-Service -Name $svc -StartupType Disabled -ErrorAction Stop
        } catch {
            Write-Log "Servicio '$svc' no encontrado o no se pudo modificar." 'Red' 'ERROR'
        }
    }
    # Exporta los estados originales para la restauraci√≥n
    $serviceStates | Export-CliXml -Path "$backupPath\\service_states_backup.xml"
    Write-Log "Servicios innecesarios deshabilitados. Respaldo de estados creado." 'Green' 'SUCCESS'
    Write-Log "Servicio de cola de impresi√≥n (Spooler) se mantiene ACTIVO, seg√∫n lo solicitado." 'Green' 'INFO'
}

Function Remove-Bloatware {
    Write-Log "Eliminando aplicaciones preinstaladas (Bloatware)..." 'Cyan' 'SECTION'
    $appsToRemove = @("*BingNews*", "*SkypeApp*", "*Zune*", "*YourPhone*", "*Xbox*", "*MixedReality*", "*GetHelp*", "*Solitaire*", "*Paint3D*", "*People*", "*WindowsFeedbackHub*", "*WindowsMaps*", "*Clipchamp*", "*Teams*")
    
    foreach ($app in $appsToRemove) {
        Write-Log "Intentando eliminar paquetes que coincidan con: $app" 'Yellow' 'ACTION'
        # 1. Elimina para el usuario actual
        Get-AppxPackage -Name $app -AllUsers | Remove-AppxPackage -ErrorAction SilentlyContinue
        # 2. Elimina la provisi√≥n para nuevos usuarios
        Get-AppxProvisionedPackage -Online | Where-Object { $_.PackageName -like $app } | Remove-AppxProvisionedPackage -Online -ErrorAction SilentlyContinue
    }
    Write-Log "Eliminaci√≥n de bloatware completada." 'Green' 'SUCCESS'
}

Function Optimize-PerformanceTweaks {
    Write-Log "Aplicando ajustes de rendimiento (Registro y Sistema)..." 'Cyan' 'SECTION'
    
    # 1. Ajustes de apagado m√°s r√°pido (WaitToKillServiceTimeout)
    $regPath = "HKLM:\\SYSTEM\\CurrentControlSet\\Control"
    Backup-RegistryKey -RegistryPath $regPath
    Set-ItemProperty -Path $regPath -Name "WaitToKillServiceTimeout" -Value "2000" -Type String -Force
    Write-Log "Tiempo de espera para cerrar servicios reducido a 2000ms." 'Green' 'SUCCESS'

    # 2. Deshabilitar telemetr√≠a (AllowTelemetry)
    $regPath = "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\DataCollection"
    Backup-RegistryKey -RegistryPath $regPath
    If (-not (Test-Path $regPath)) { New-Item -Path $regPath -Force | Out-Null }
    Set-ItemProperty -Path $regPath -Name "AllowTelemetry" -Value 0 -Type DWord -Force
    Write-Log "Telemetr√≠a de Windows deshabilitada." 'Green' 'SUCCESS'

    # 3. Optimizar UI (men√∫s m√°s r√°pidos) (MenuShowDelay)
    $regPath = "HKCU:\\Control Panel\\Desktop"
    Backup-RegistryKey -RegistryPath $regPath
    Set-ItemProperty -Path $regPath -Name "MenuShowDelay" -Value "100" -Type String -Force
    Write-Log "Retraso de men√∫s reducido para una UI m√°s √°gil." 'Green' 'SUCCESS'
}

# NUEVA FUNCI√ìN: Optimizar efectos visuales
Function Set-VisualEffects {
    Write-Log "Optimizando efectos visuales para m√°ximo rendimiento..." 'Cyan' 'SECTION'
    $regPath = "HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\VisualEffects"
    Backup-RegistryKey -RegistryPath $regPath
    # '2' significa "Mejor rendimiento", deshabilita todos los efectos visuales.
    Set-ItemProperty -Path $regPath -Name "VisualFXSetting" -Value 2 -Type DWord -Force
    Write-Log "Efectos visuales configurados para 'Mejor rendimiento'." 'Green' 'SUCCESS'
    Write-Log "Se recomienda reiniciar el Explorador de Windows o el sistema para aplicar los cambios visuales." 'Yellow' 'INFO'
}

# NUEVA FUNCI√ìN: Desbloquear y activar plan de energ√≠a de M√°ximo Rendimiento
Function Unlock-UltimatePerformance {
    Write-Log "Activando plan de energ√≠a de 'M√°ximo Rendimiento'..." 'Cyan' 'SECTION'
    $ultimatePlanGuid = "e9a42b02-d5df-448d-aa00-03f14749eb61"
    $currentPlans = powercfg /LIST
    if ($currentPlans -notmatch $ultimatePlanGuid) {
        Write-Log "El plan de 'M√°ximo Rendimiento' no est√° presente. Import√°ndolo..." 'Yellow' 'ACTION'
        # Duplica el esquema de rendimiento existente para desbloquear el m√°ximo rendimiento
        powercfg -duplicatescheme 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c $ultimatePlanGuid | Out-Null
    }
    powercfg /SETACTIVE $ultimatePlanGuid | Out-Null
    Write-Log "Plan de energ√≠a 'M√°ximo Rendimiento' activado." 'Green' 'SUCCESS'
}
#endregion

#region FUNCIONES DE RESTAURACI√ìN (CR√çTICO PARA LA SEGURIDAD)
Function Restore-Services {
    Write-Log "Restaurando servicios a su estado original..." 'Cyan' 'SECTION'
    $backupFile = "$backupPath\\service_states_backup.xml"
    if (Test-Path $backupFile) {
        $serviceStates = Import-CliXml -Path $backupFile
        foreach ($svc in $serviceStates.GetEnumerator()) {
            try {
                Write-Log "Restaurando servicio: $($svc.Name) a '$($svc.Value)'" 'Yellow' 'ACTION'
                Set-Service -Name $svc.Name -StartupType $svc.Value -ErrorAction Stop
            } catch {
                Write-Log "No se pudo restaurar el servicio '$($svc.Name)'." 'Red' 'ERROR'
            }
        }
        Write-Log "Restauraci√≥n de servicios completada." 'Green' 'SUCCESS'
    } else {
        Write-Log "No se encontr√≥ un archivo de respaldo de servicios." 'Red' 'ERROR'
    }
}

Function Restore-PowerPlan {
    Write-Log "Restaurando plan de energ√≠a 'Equilibrado'..." 'Cyan' 'SECTION'
    $balancedPlanGuid = "381b4222-f694-41f0-9685-ff5bb260df2e"
    powercfg /SETACTIVE $balancedPlanGuid
    Write-Log "Plan de energ√≠a 'Equilibrado' restaurado." 'Green' 'SUCCESS'
}
#endregion

#region MEN√ö PRINCIPAL Y EJECUCI√ìN
Check-Admin
Write-Log "‚úîÔ∏è Bienvenido a TIT√ÅN v17.0. El LOG se guardar√° en '$logFile'." 'Green' 'SYSTEM'

while ($true) {
    Write-Host "\\n"
    Write-Host "========================== MEN√ö DE OPTIMIZACI√ìN TIT√ÅN v17.0 ==========================" -ForegroundColor Cyan
    Write-Host "    [LIMPIEZA PROFUNDA]                          [OPTIMIZACI√ìN DE RENDIMIENTO]"
    Write-Host " 1. Limpieza completa del sistema             6. Optimizar servicios (Crea respaldo)"
    Write-Host " 2. Eliminar Bloatware (Apps preinstaladas)   7. Ajustes de rendimiento del registro"
    Write-Host " 3. Limpiar registros de eventos de Windows   8. Optimizar efectos visuales (M√°s r√°pido)"
    Write-Host "                                              9. Activar plan de energ√≠a 'M√°ximo Rendimiento'"
    Write-Host "    [RED Y ACTUALIZACIONES]                      [UTILIDADES ADICIONALES]"
    Write-Host " 4. (Opcional) Actualizar Sistema (Winget)   10. Bloquear Telemetr√≠a (Archivo Hosts)"
    Write-Host " 5. (Opcional) Cambiar DNS a Cloudflare      11. A√±adir 'Tomar Posesi√≥n' al men√∫ contextual"
    Write-Host "==========================================================================================" -ForegroundColor Cyan
    Write-Host "    [RESTAURACI√ìN SEGURA]                                 [ACCIONES GLOBALES]"
    Write-Host " R1. Restaurar servicios a su estado previo   A. APLICAR TODO (Limpieza y Optimizaci√≥n)"
    Write-Host " R2. Restaurar plan de energ√≠a 'Equilibrado' "
    Write-Host "==========================================================================================" -ForegroundColor Cyan
    
    $selection = Read-Host "‚û°Ô∏è  Ingresa tu opci√≥n y presiona Enter"

    switch ($selection.ToUpper()) {
        "1" { Clean-System }
        "2" { Remove-Bloatware }
        "3" { Clear-EventLogs }
        # Ops 4 y 5 son tareas avanzadas que requieren m√≥dulos adicionales o cambios de red, por eso se marcan como opcionales
        "4" { Write-Log "La actualizaci√≥n requiere la instalaci√≥n de m√≥dulos de PSWindowsUpdate y Winget." 'Yellow' 'WARN'; Start-Sleep -Seconds 3 }
        "5" { Write-Log "El cambio de DNS puede afectar tu red actual." 'Yellow' 'WARN'; Start-Sleep -Seconds 3 }
        "6" { Optimize-Services }
        "7" { Optimize-PerformanceTweaks }
        "8" { Set-VisualEffects }
        "9" { Unlock-UltimatePerformance }
        "10" { 
            # Reintegrating Block-TelemetryHosts logic locally if not included above
            $hostsPath = "$env:SystemRoot\\System32\\drivers\\etc\\hosts"
            $telemetryDomains = @("telemetry.microsoft.com", "vortex.data.microsoft.com", "settings-win.data.microsoft.com")
            Copy-Item -Path $hostsPath -Destination "$backupPath\\hosts.bak" -Force
            $currentHosts = Get-Content -Path $hostsPath
            foreach ($domain in $telemetryDomains) {
                if ($currentHosts -notcontains $domain) {
                    Add-Content -Path $hostsPath -Value "0.0.0.0 $domain # Bloqueado por TITAN Optimizer"
                }
            }
            ipconfig /flushdns | Out-Null
            Write-Log "Dominios de telemetr√≠a bloqueados y cach√© DNS limpiada." 'Green' 'SUCCESS'
        }
        "11" { 
            # Reintegrating Add-TakeOwnership logic locally if not included above
            $regKey = "HKCR\\*\\shell\\runas"
            if (-not (Test-Path $regKey)) {
                New-Item -Path $regKey -Force | Out-Null
                Set-ItemProperty -Path $regKey -Name "(Default)" -Value "Tomar Posesi√≥n" -Force
                $commandPath = "$regKey\\command"
                New-Item -Path $commandPath -Force | Out-Null
                Set-ItemProperty -Path $commandPath -Name "(Default)" -Value 'cmd.exe /c takeown /f "%1" && icacls "%1" /grant administrators:F' -Force
                Write-Log "Opci√≥n 'Tomar Posesi√≥n' a√±adida correctamente." 'Green' 'SUCCESS'
            } else {
                Write-Log "La opci√≥n 'Tomar Posesi√≥n' ya parece existir." 'Yellow' 'INFO'
            }
        }
        "R1" { Restore-Services }
        "R2" { Restore-PowerPlan }
        "A" { 
            Write-Log "Ejecutando todas las optimizaciones de limpieza y rendimiento..." 'Magenta' 'GLOBAL'
            New-SystemRestorePoint
            Clean-System
            Remove-Bloatware
            Clear-EventLogs
            # Re-run Block-TelemetryHosts logic here for 'A' option
            $hostsPath = "$env:SystemRoot\\System32\\drivers\\etc\\hosts"
            $telemetryDomains = @("telemetry.microsoft.com", "vortex.data.microsoft.com", "settings-win.data.microsoft.com")
            Copy-Item -Path $hostsPath -Destination "$backupPath\\hosts.bak" -Force
            $currentHosts = Get-Content -Path $hostsPath
            foreach ($domain in $telemetryDomains) {
                if ($currentHosts -notcontains $domain) {
                    Add-Content -Path $hostsPath -Value "0.0.0.0 $domain # Bloqueado por TITAN Optimizer"
                }
            }
            ipconfig /flushdns | Out-Null
            Write-Log "Dominios de telemetr√≠a bloqueados y cach√© DNS limpiada." 'Green' 'SUCCESS'
            # End Block-TelemetryHosts logic
            Optimize-Services
            Optimize-PerformanceTweaks
            Set-VisualEffects
            Unlock-UltimatePerformance
            Write-Log "TODAS LAS TAREAS HAN FINALIZADO. Se recomienda reiniciar." 'Green' 'SYSTEM'
        }
        "S" { Write-Log "Saliendo del script. ¬°Sistema optimizado!"; break }
        default { Write-Log "Opci√≥n no v√°lida. Int√©ntalo de nuevo." 'Red' 'WARN' }
    }
}
#endregion`;

            // --- State ---
            let currentTheme = localStorage.getItem('theme') || 'dark';

            // --- Functions ---
            
            /** Applies the current theme to the body. */
            const applyTheme = () => {
                document.body.className = '';
                document.body.classList.add(currentTheme, 'antialiased');
                themeToggle.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåì';
            };

            /** Toggles the theme between light and dark. */
            const toggleTheme = () => {
                currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', currentTheme);
                applyTheme();
                showToast(`Switched to ${currentTheme} mode`);
            };

            /** Displays a toast notification. */
            const showToast = (message, type = 'success') => {
                toast.textContent = message;
                toast.className = `fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300`;
                toast.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
                
                // Animate in
                setTimeout(() => {
                    toast.classList.remove('opacity-0', 'translate-y-10');
                }, 10);
                
                // Animate out
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-10');
                }, 3000);
            };

            /** Copies the script content to the clipboard. */
            const copyScript = () => {
                // Fallback method using a temporary textarea
                const textArea = document.createElement('textarea');
                textArea.value = scriptContentText;
                textArea.style.position = 'fixed';
                textArea.style.top = '-9999px';
                textArea.style.left = '-9999px';

                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showToast('‚úÖ Script copied to clipboard!');
                    } else {
                        showToast('‚ùå Failed to copy script.', 'error');
                    }
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    showToast('‚ùå Failed to copy script.', 'error');
                }

                document.body.removeChild(textArea);
            };
            
            /** Downloads the script as a .ps1 file. */
            const downloadScript = () => {
                const blob = new Blob([scriptContentText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'TITAN_v17.0_Optimizer.ps1';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('‚¨áÔ∏è Script download started.');
            };

            /** Initializes and highlights the script content. */
            const renderScript = () => {
                scriptContentEl.textContent = scriptContentText;
                Prism.highlightElement(scriptContentEl);
                const lineCount = scriptContentText.split('\n').length;
                lineCountEl.textContent = `${lineCount} lines`;
            };

            /** Handles the search functionality. */
            const handleSearch = () => {
                const query = searchBox.value.toLowerCase();
                renderScript(); // Reset highlights

                if (query.length < 3) {
                    return;
                }

                const lines = scriptContentEl.innerHTML.split('\n');
                let firstMatch = null;
                const highlightedLines = lines.map((line, index) => {
                    if (line.toLowerCase().includes(query)) {
                        if (!firstMatch) firstMatch = index;
                        // Use a regex to wrap the match in a mark tag for styling
                        const regex = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                        const highlightedLine = line.replace(regex, `<mark class="bg-sky-500/30 px-1 rounded">\$1</mark>`);
                        return `<span class="highlighted-line">${highlightedLine}</span>`;
                    }
                    return line;
                }).join('\n');

                scriptContentEl.innerHTML = highlightedLines;
                
                // Scroll to the first match
                if (firstMatch !== null) {
                    const firstMatchElement = scriptContentEl.querySelector('.highlighted-line');
                    if (firstMatchElement) {
                        firstMatchElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            };

            // --- Event Listeners ---
            themeToggle.addEventListener('click', toggleTheme);
            copyBtn.addEventListener('click', copyScript);
            downloadBtn.addEventListener('click', downloadScript);
            searchBox.addEventListener('input', handleSearch);

            // --- Initialization ---
            applyTheme();
            renderScript();
        });
    </script>
</body>
</html>
