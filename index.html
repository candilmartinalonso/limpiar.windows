# =================================================================================================
#
#   PowerScript Optimizer LEVIAT√ÅN v6.0 - EDICI√ìN PROFESIONAL
#   Objetivo: Limpieza exhaustiva, optimizaci√≥n profunda, mantenimiento preventivo y diagn√≥stico avanzado.
#
#   ADVERTENCIA: EJECUTAR SIEMPRE COMO ADMINISTRADOR.
#   Este script realiza cambios profundos. √ösese bajo su propia responsabilidad.
#
# =================================================================================================
#region PREPARACI√ìN Y CONFIGURACI√ìN INICIAL
if (-NOT ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Write-Warning "Este script requiere privilegios de Administrador. Por favor, reinicia la terminal como Administrador."
    Start-Sleep -Seconds 10
    Exit
}

function Show-SectionTitle {
    param([string]$Title)
    Write-Host "`n"
    Write-Host "==================================================================" -ForegroundColor Cyan
    Write-Host "    $Title" -ForegroundColor White
    Write-Host "==================================================================" -ForegroundColor Cyan
}

$logFile = "$env:USERPROFILE\Desktop\Optimizador-Leviatan-Log.txt"
Function Write-Log {
    param ([string]$Message, [string]$ForegroundColor = 'Gray')
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] - $Message"
    $logMessage | Out-File -FilePath $logFile -Append
    Write-Host $logMessage -ForegroundColor $ForegroundColor
}

function Show-Menu {
    Clear-Host
    Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
    Write-Host "‚ïë              üê≤ OPTIMIZADOR LEVIAT√ÅN PARA WINDOWS üê≤             ‚ïë" -ForegroundColor White
    Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "ADVERTENCIA: Herramienta de poder extremo. Proceda con precauci√≥n." -ForegroundColor Red
    Write-Host "Se recomienda encarecidamente cerrar todos los programas." -ForegroundColor Yellow
    Write-Host ""
    Write-Host "Selecciona una opci√≥n:" -ForegroundColor Cyan
    Write-Host "   [1] Limpieza Exhaustiva del Sistema (Profunda)"
    Write-Host "   [2] Actualizaci√≥n Universal (Windows, Apps, Drivers)"
    Write-Host "   [3] Optimizaci√≥n Extrema y de Red (Riesgo Controlado)"
    Write-Host "   [4] Depuraci√≥n Profunda de Windows (Bloatware + Seguridad)"
    Write-Host "   [5] Liberaci√≥n de Memoria RAM (Limpieza Avanzada)"
    Write-Host "   [6] Mantenimiento y Reparaci√≥n del Sistema (Integral)"
    Write-Host "   [7] Diagn√≥stico Avanzado (Rendimiento, Salud del Sistema)"
    Write-Host "   [8] Utilidades del Sistema (Contextual, Tweaks, Monitor)"
    Write-Host "   [9] ¬°MODO APOCALIPSIS! (Todo en Orden √ìptimo)"
    Write-Host "   [Q] Salir"
    Write-Host ""
}

function Create-RestorePoint {
    Show-SectionTitle "Creando Punto de Restauraci√≥n del Sistema"
    if (-NOT (Get-Service -Name VSS -ErrorAction SilentlyContinue).Status -eq "Running") {
        Write-Log "El servicio de Volume Shadow Copy no est√° activo. Intentando iniciarlo." -ForegroundColor Yellow
        Start-Service -Name VSS
        Start-Sleep -Seconds 2
    }
    if ((Get-ComputerRestorePoint -ErrorAction SilentlyContinue).Count -gt 0) {
        Write-Log "Creando punto de restauraci√≥n 'Pre-Leviatan-Optimizer'..."
        Checkpoint-Computer -Description "Pre-Leviatan-Optimizer" -RestorePointType "MODIFY_SETTINGS"
        Write-Log "Punto de restauraci√≥n creado con √©xito." -ForegroundColor Green
    } else {
        Write-Log "La creaci√≥n de puntos de restauraci√≥n parece estar deshabilitada en tu sistema. Omitiendo." -ForegroundColor Red
    }
}
#endregion

#region FUNCIONES PRINCIPALES MEJORADAS
# --- [1] FUNCI√ìN DE LIMPIEZA PROFUNDA ---
function Invoke-ExhaustiveClean {
    Show-SectionTitle "Iniciando Limpieza Exhaustiva Profunda"
    $initialDiskSpace = (Get-PSDrive C).Free
    
    Write-Log "Limpieza de cach√©s del sistema, navegadores y aplicaciones..."
    $locationsToClean = @(
        "$env:TEMP\*", "$env:SystemRoot\Temp\*", "$env:SystemRoot\SoftwareDistribution\Download\*",
        "$env:windir\Prefetch\*", "$env:windir\Logs\*", "$env:windir\Panther\*",
        "$env:SystemRoot\System32\Winevt\Logs\*", "$env:LOCALAPPDATA\Microsoft\Windows\Explorer\thumbcache_*.db",
        
        # Navegadores
        "$env:LOCALAPPDATA\Microsoft\Edge\User Data\Default\Cache\*", 
        "$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Cache\*",
        "$env:LOCALAPPDATA\Mozilla\Firefox\Profiles\*\cache2\entries\*",
        "$env:LOCALAPPDATA\BraveSoftware\Brave-Browser\User Data\Default\Cache\*",
        
        # Aplicaciones Populares
        "$env:LOCALAPPDATA\Discord\Cache\*", "$env:APPDATA\Discord\Cache\*",
        "$env:APPDATA\Spotify\Cache\*", "$env:APPDATA\Steam\htmlcache\*",
        "$env:APPDATA\VSCode\Cache\*", "$env:APPDATA\VSCode\CachedData\*",
        "$env:LOCALAPPDATA\GitHub Desktop\Cache\*",
        "$env:LOCALAPPDATA\Zoom\*\Cache\*", "$env:LOCALAPPDATA\Telegram Desktop\*\Cache\*",
        "$env:LOCALAPPDATA\Microsoft\Teams\Cache\*", "$env:LOCALAPPDATA\Microsoft\Teams\blob_storage\*",
        
        # Logs y Registros
        "$env:APPDATA\Microsoft\Windows\Recent\AutomaticDestinations\*", 
        "$env:APPDATA\Microsoft\Windows\Recent\CustomDestinations\*",
        "$env:APPDATA\Microsoft\Windows\Recent\Destinations\*",
        "$env:APPDATA\Microsoft\Windows\Recent\JumpLists\*",
        "$env:APPDATA\Microsoft\Windows\Recent\TypedPaths\*",
        "$env:APPDATA\Microsoft\Windows\Recent\WorkFolders\*",
        
        # Otros
        "$env:USERPROFILE\AppData\LocalLow\Sun\Java\Deployment\cache\*",
        "$env:USERPROFILE\AppData\Roaming\Microsoft\Windows\Themes\*.theme",
        "$env:USERPROFILE\AppData\Roamming\Microsoft\Windows\WebCache\*"
    )
    
    foreach ($location in $locationsToClean) {
        Write-Log "Limpiando: $location"
        Remove-Item -Path $location -Recurse -Force -ErrorAction SilentlyContinue
    }

    Write-Log "Vaciando registros de eventos de Windows..."
    wevtutil el | ForEach-Object { wevtutil cl "$_" }
    
    Write-Log "Limpieza de cach√© de DNS, Papelera de Reciclaje y Windows Update..."
    Clear-DnsClientCache; ipconfig /flushdns
    Clear-RecycleBin -Force -ErrorAction SilentlyContinue
    Remove-Item -Path "$env:windir\SoftwareDistribution\Download\*" -Recurse -Force
    
    Write-Log "Ejecutando Liberador de espacio en disco de Windows en modo avanzado..."
    $regKey = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches"
    Get-ChildItem -Path $regKey | ForEach-Object {Set-ItemProperty -Path $_.PSPath -Name "StateFlags0001" -Value 2 -Type DWord -Force -ErrorAction SilentlyContinue} | Out-Null
    cleanmgr.exe /sagerun:1 | Out-Null
    
    Write-Log "Limpiando el almac√©n de componentes de Windows (WinSxS)..."
    Dism.exe /online /Cleanup-Image /StartComponentCleanup /ResetBase | Out-Null
    
    $finalDiskSpace = (Get-PSDrive C).Free
    $spaceFreed = [math]::Round(($finalDiskSpace - $initialDiskSpace) / 1GB, 2)
    Write-Log "Limpieza Exhaustiva Finalizada. Espacio liberado: $spaceFreed GB" -ForegroundColor Green
}

# --- [2] FUNCI√ìN DE ACTUALIZACI√ìN UNIVERSAL ---
function Invoke-UniversalUpdate {
    Show-SectionTitle "Iniciando Actualizaci√≥n Universal Completa"
    
    Write-Log "Fase 1: Actualizando Windows..."
    Write-Log "Esto puede tardar MUCHO tiempo. Ten paciencia."
    Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force -ErrorAction SilentlyContinue | Out-Null
    Install-Module -Name PSWindowsUpdate -Force -AcceptLicense -ErrorAction SilentlyContinue | Out-Null
    Import-Module PSWindowsUpdate -ErrorAction SilentlyContinue
    Get-WindowsUpdate -AcceptAll -Install -AutoReboot | Out-Null
    Write-Log "Sistema Operativo Windows actualizado." -ForegroundColor Green
    
    Write-Log "Fase 2: Actualizando aplicaciones con Winget..."
    if (Get-Command "winget" -ErrorAction SilentlyContinue) {
        winget upgrade --all --accept-package-agreements --accept-source-agreements --disable-interactivity
        Write-Log "Aplicaciones de Winget actualizadas." -ForegroundColor Green
    } else { Write-Log "Winget no encontrado." -ForegroundColor Yellow }
    
    Write-Log "Fase 3: Actualizando aplicaciones con Chocolatey..."
    if (Get-Command "choco" -ErrorAction SilentlyComplete) {
        choco upgrade all -y --ignore-checksums
        Write-Log "Aplicaciones de Chocolatey actualizadas." -ForegroundColor Green
    } else { Write-Log "Chocolatey no encontrado." -ForegroundColor Yellow }
    
    Write-Log "Fase 4: Actualizando aplicaciones con Scoop..."
    if (Get-Command "scoop" -ErrorAction SilentlyComplete) {
        scoop update *; scoop cleanup *
        Write-Log "Aplicaciones de Scoop actualizadas." -ForegroundColor Green
    } else { Write-Log "Scoop no encontrado." -ForegroundColor Yellow }
    
    Write-Log "Fase 5: Actualizando drivers con Snappy Driver Installer..."
    if (Test-Path "C:\SnappyDriverInstaller_x64\SdiGui.exe") {
        Start-Process "C:\SnappyDriverInstaller_x64\SdiGui.exe" -ArgumentList "/update" -Wait
        Write-Log "Drivers actualizados con Snappy Driver Installer." -ForegroundColor Green
    } else {
        Write-Log "Snappy Driver Installer no encontrado. Considera instalarlo manualmente." -ForegroundColor Yellow
    }
}

# --- [3] FUNCI√ìN DE OPTIMIZACI√ìN EXTREMA ---
function Invoke-ExtremeOptimization {
    Show-SectionTitle "Aplicando Optimizaciones Extremas Seguras"
    Write-Log "Activando plan de energ√≠a de 'M√°ximo Rendimiento' y desactivando hibernaci√≥n..."
    powercfg -duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61 | Out-Null
    $planGuid = (powercfg -l | Select-String "M√°ximo rendimiento" -split " ")[3]
    powercfg /s $planGuid
    powercfg.exe /hibernate off
    
    Write-Log "Optimizaciones de sistema y UI..."
    fsutil behavior set disablelastaccess 1
    Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" -Name "VisualFxSetting" -Value 2
    Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name "MenuShowDelay" -Value "0"
    Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name "AutoEndTasks" -Value "1"
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control" -Name "WaitToKillServiceTimeout" -Value "2000"
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -Name "ClearPageFileAtShutdown" -Value 0
    Set-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile" -Name "SystemResponsiveness" -Value 00000000 -Type dword -Force
    
    Write-Log "Activando Hardware-Accelerated GPU Scheduling..."
    Set-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\GraphicsDrivers" -Name "HwSchMode" -Value 2 -Type Dword -Force
    
    Write-Log "Desactivando servicios innecesarios..."
    $servicesToDisable = @(
        "DiagTrack", "dmwappushservice", "SysMain", "MapsBroker", "lfsvc", "DoSvc", 
        "Fax", "RemoteRegistry", "TabletInputService", "WMPNetworkSvc", "XblAuthManager",
        "XblGameSave", "XboxNetApiSvc", "Print Spooler", "Adobe Acrobat Update Service"
    )
    foreach ($service in $servicesToDisable) {
        Write-Log "Desactivando servicio: $service"
        Set-Service -Name $service -StartupType Disabled -Status Stopped -ErrorAction SilentlyContinue
    }
    
    Write-Log "Optimizaciones de red avanzadas..."
    netsh int tcp set global autotuninglevel=normal; netsh int tcp set global ecncapability=enabled; netsh int tcp set global rss=enabled
    netsh int tcp set supplemental template=internet congestionprovider=ctcp
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name "TcpAckFrequency" -Value 1 -ErrorAction SilentlyContinue
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name "TCPNoDelay" -Value 1 -ErrorAction SilentlyContinue
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile" -Name "NetworkThrottlingIndex" -Value 0xFFFFFFFF -Type DWord -Force
    
    Write-Log "Configuraciones de SSD..."
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -Name "EnableSuperfetch" -Value 0 -Type DWord -Force
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -Name "DisablePagingExecutive" -Value 1 -Type DWord -Force
    Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -Name "LargeSystemCache" -Value 1 -Type DWord -Force
    
    Write-Log "Optimizaciones Extremas Aplicadas." -ForegroundColor Green
}

# --- [4] FUNCI√ìN DE DEPURACI√ìN PROFUNDA ---
function Invoke-DeepDebloat {
    Show-SectionTitle "Depuraci√≥n Profunda de Windows (Bloatware + Seguridad)"
    
    Write-Log "Eliminando paquetes de aplicaciones preinstaladas..."
    $appsToRemove = @(
        "Microsoft.549981C3F5F10", "*Cortana*", "*Microsoft.Windows.Search*", "Microsoft.WindowsSoundRecorder", 
        "Microsoft.XboxApp", "Microsoft.Xbox.TCUI", "Microsoft.XboxGameOverlay", "Microsoft.XboxGamingOverlay", 
        "Microsoft.XboxIdentityProvider", "Microsoft.XboxSpeechToTextOverlay", "Microsoft.ZuneMusic", 
        "Microsoft.ZuneVideo", "Microsoft.YourPhone", "Microsoft.WindowsAlarms", "Microsoft.WindowsMaps", 
        "Microsoft.SkypeApp", "Microsoft.Getstarted", "Microsoft.GetHelp", "Microsoft.MicrosoftSolitaireCollection", 
        "Microsoft.People", "Microsoft.Office.OneNote", "Microsoft.OneConnect", "Microsoft.Print3D", "Microsoft.Wallet",
        "Microsoft.MixedReality.Portal", "Microsoft.WindowsFeedbackHub", "Microsoft.WebMediaExtensions",
        "Microsoft.BingWeather", "Microsoft.GetOffice", "Microsoft.WindowsCamera", "Microsoft.Windows.Photos",
        "Microsoft.GrooveMusic", "Microsoft.ZuneSocial", "Microsoft.WindowsCalculator", "Microsoft.WindowsVoiceRecorder",
        "Microsoft.WindowsStore", "Microsoft.Windows.Photos", "Microsoft.MicrosoftStickyNotes"
    )
    
    $confirmation = Read-Host "¬øEst√°s seguro de que deseas eliminar estas aplicaciones? (S/N)"
    if ($confirmation -eq 'S') {
        foreach ($app in $appsToRemove) {
            Write-Log "Intentando eliminar: $app"
            Get-AppxPackage -AllUsers $app | Remove-AppxPackage -AllUsers -ErrorAction SilentlyContinue
            Get-AppxProvisionedPackage -Online | Where-Object { $_.PackageName -like $app } | Remove-AppxProvisionedPackage -Online -ErrorAction SilentlyContinue
        }
        Write-Log "Depuraci√≥n de bloatware completada." -ForegroundColor Green
    }
    
    Write-Log "Desactivando telemetr√≠a y recopilaci√≥n de datos..."
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection" -Name "AllowTelemetry" -Value 0 -Type DWord -Force
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection" -Name " telemetry_level" -Value 0 -Type DWord -Force
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\CloudContent" -Name "DisableSoftLanding" -Value 1 -Type DWord -Force
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\CloudContent" -Name "DisableWindowsConsumerFeatures" -Value 1 -Type DWord -Force
    
    Write-Log "Bloqueando actualizaciones autom√°ticas de aplicaciones de Microsoft Store..."
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\WindowsStore" -Name "AutoDownload" -Value 2 -Type DWord -Force
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\WindowsStore" -Name "AutoDownload" -Value 2 -Type DWord -Force
    
    Write-Log "Desactivando caracter√≠sticas de privacidad..."
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization" -Name "NoLockScreenUserTile" -Value 1 -Type DWord -Force
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization" -Name "NoLockScreenAppNotifications" -Value 1 -Type DWord -Force
    
    Write-Log "Depuraci√≥n profunda completada." -ForegroundColor Green
}

# --- [5] FUNCI√ìN DE LIBERACI√ìN DE RAM AVANZADA ---
function Invoke-FreeRAM {
    Show-SectionTitle "Liberando Memoria RAM (T√©cnica Avanzada)"
    Write-Log "Usando t√©cnica de liberaci√≥n de memoria avanzada..."
    
    try {
        $Code = @"
        using System;
        using System.Runtime.InteropServices;
        public class MemoryTool {
            [DllImport("psapi.dll")]
            public static extern bool EmptyWorkingSet(IntPtr hProcess);
            [DllImport("advapi32.dll", SetLastError=true)]
            [return: MarshalAs(UnmanagedType.Bool)]
            static extern bool AdjustTokenPrivileges(IntPtr TokenHandle, [MarshalAs(UnmanagedType.Bool)]bool DisableAllPrivileges, ref TOKEN_PRIVILEGES NewState, UInt32 BufferLength, IntPtr PreviousState, IntPtr ReturnLength);
            [DllImport("kernel32.dll", SetLastError=true)]
            static extern IntPtr GetCurrentProcess();
            [DllImport("advapi32.dll", SetLastError=true, CharSet=CharSet.Auto)]
            [return: MarshalAs(UnmanagedType.Bool)]
            static extern bool OpenProcessToken(IntPtr ProcessHandle, UInt32 DesiredAccess, out IntPtr TokenHandle);
            
            [DllImport("advapi32.dll", SetLastError=true, CharSet=CharSet.Auto)]
            [return: MarshalAs(UnmanagedType.Bool)]
            static extern bool LookupPrivilegeValue(string lpSystemName, string lpName, out LUID lpLuid);
            [StructLayout(LayoutKind.Sequential)]
            public struct LUID { public uint LowPart; public int HighPart; }
            [StructLayout(LayoutKind.Sequential)]
            public struct TOKEN_PRIVILEGES { public uint PrivilegeCount; public LUID_AND_ATTRIBUTES Privileges; }
            
            [StructLayout(LayoutKind.Sequential)]
            public struct LUID_AND_ATTRIBUTES { public LUID Luid; public uint Attributes; }
            
            const uint TOKEN_ADJUST_PRIVILEGES = 0x0020;
            const uint TOKEN_QUERY = 0x0008;
            const uint SE_PRIVILEGE_ENABLED = 0x00000002;
            const string SE_INCREASE_QUOTA_NAME = "SeIncreaseQuotaPrivilege";
            
            public static void ClearStandbyCache() {
                IntPtr hToken;
                OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, out hToken);
                TOKEN_PRIVILEGES tkp = new TOKEN_PRIVILEGES{ PrivilegeCount = 1, Privileges = new LUID_AND_ATTRIBUTES { Attributes = SE_PRIVILEGE_ENABLED }};
                LookupPrivilegeValue(null, SE_INCREASE_QUOTA_NAME, out tkp.Privileges.Luid);
                AdjustTokenPrivileges(hToken, false, ref tkp, 0, IntPtr.Zero, IntPtr.Zero);
                
                long originalSize = 1024L * 1024 * 256; // 256MB
                long maxSize = 1024L * 1024 * 1024 * 16; // 16GB
                try {
                    GC.AddMemoryPressure(originalSize);
                    for (int i=0; i<10; i++) System.Threading.Thread.Sleep(100);
                    EmptyWorkingSet(GetCurrentProcess());
                } finally {
                    GC.RemoveMemoryPressure(originalSize);
                }
            }
        }
"@
        Add-Type -TypeDefinition $Code -Language CSharp
        
        $memBefore = (Get-CimInstance Win32_OperatingSystem).FreePhysicalMemory / 1024
        Write-Log "Memoria libre ANTES: $([math]::Round($memBefore, 2)) MB"
        [MemoryTool]::ClearStandbyCache()
        Start-Sleep -Seconds 2
        $memAfter = (Get-CimInstance Win32_OperatingSystem).FreePhysicalMemory / 1024
        $freedMem = $memAfter - $memBefore
        Write-Log "Memoria libre DESPU√âS: $([math]::Round($memAfter, 2)) MB"
        Write-Log "¬°Se han liberado $([math]::Round($freedMem, 2)) MB de RAM!" -ForegroundColor Green
    } catch {
        Write-Warning "Error al ejecutar la limpieza de RAM. Puede que el entorno de ejecuci√≥n lo impida."
    }
}

# --- [6] FUNCI√ìN DE MANTENIMIENTO INTEGRAL ---
function Invoke-SystemMaintenance {
    Show-SectionTitle "Mantenimiento y Reparaci√≥n del Sistema"
    
    Write-Log "Optimizando unidades (TRIM/Defrag)..."
    Get-WmiObject -Class Win32_Volume | Where-Object { $_.DriveType -eq 3 -and $_.DriveLetter } | ForEach-Object { 
        Optimize-Volume -DriveLetter $_.DriveLetter.Substring(0,1) -Verbose 
    }
    
    Write-Log "Verificando y reparando archivos del sistema (SFC /scannow)..."
    sfc.exe /scannow | Out-Null
    Write-Log "SFC completado."
    
    Write-Log "Verificando y reparando imagen de Windows (DISM)..."
    Dism.exe /online /Cleanup-Image /ScanHealth | Out-Null
    Dism.exe /online /Cleanup-Image /CheckHealth | Out-Null
    Dism.exe /online /Cleanup-Image /RestoreHealth | Out-Null
    Write-Log "DISM completado."
    
    Write-Log "Realizando chequeo de disco (chkdsk)..."
    $drive = (Get-CimInstance Win32_LogicalDisk | Where-Object {$_.DeviceID -eq "C:"}).DeviceID
    chkdsk $drive /f /r
    Write-Log "Chequeo de disco programado para el pr√≥ximo reinicio."
    
    Write-Log "Verificando integridad de archivos del sistema..."
    $fileCheck = cmd /c "sfc /verifyonly"
    Write-Log "Verificaci√≥n de archivos completada."
    
    Write-Log "Mantenimiento del sistema completado." -ForegroundColor Green
}

# --- [7] FUNCI√ìN DE DIAGN√ìSTICO AVANZADO ---
function Invoke-SystemDiagnostics {
    Show-SectionTitle "Diagn√≥stico Avanzado del Sistema"
    
    Write-Log "Generando informe de salud del sistema..."
    $healthReport = Get-HealthReport
    $healthReport | Out-File "$env:USERPROFILE\Desktop\Informe_Salud_Sistema.txt"
    Write-Log "Informe de salud generado en: $env:USERPROFILE\Desktop\Informe_Salud_Sistema.txt"
    
    Write-Log "Analizando rendimiento del sistema..."
    $performanceData = Get-PerformanceCounterSample -Counter "\Processor(_Total)\% Processor Time" -SampleInterval 1 -MaxSamples 60
    $avgCPU = ($performanceData | Measure-Object -Property CookedValue -Average).Average
    Write-Log "Uso promedio de CPU: $([math]::Round($avgCPU, 2))%"
    
    $memoryData = Get-PerformanceCounterSample -Counter "\Memory\Available MBytes" -SampleInterval 1 -MaxSamples 60
    $minMemory = ($memoryData | Measure-Object -Property CookedValue -Minimum).Minimum
    Write-Log "Memoria m√≠nima disponible: $([math]::Round($minMemory, 2)) MB"
    
    Write-Log "Analizando temperatura del sistema..."
    $tempData = Get-WmiObject -Namespace root\WMI -Class MSAcpi_ThermalZoneTemperature
    foreach ($zone in $tempData) {
        Write-Log "Temperatura $($zone.InstanceName): $($zone.CurrentTemperature / 10)¬∞C"
    }
    
    Write-Log "Analizando uso de disco..."
    $diskUsage = Get-Counter "\LogicalDisk(*)\% Disk Time" -ErrorAction SilentlyContinue
    $avgDiskTime = ($diskUsage.CounterSamples.CookedValue | Measure-Object -Average).Average
    Write-Log "Tiempo de uso de disco promedio: $([math]::Round($avgDiskTime, 2))%"
    
    Write-Log "Diagn√≥stico completo." -ForegroundColor Green
}

# --- [8] FUNCI√ìN DE UTILIDADES DEL SISTEMA ---
function Invoke-SystemUtilities {
    Show-SectionTitle "Utilidades del Sistema"
    Write-Host " [1] A√±adir Optimizador al Men√∫ Contextual del Escritorio"
    Write-Host " [2] Quitar Optimizador del Men√∫ Contextual"
    Write-Host " [3] Mostrar/Ocultar archivos ocultos y extensiones"
    Write-Host " [4] Desactivar Hibernaci√≥n"
    Write-Host " [5] Activar Modo Port√°til (Power Saver)"
    Write-Host " [6] Generar Informe de Estado del Sistema"
    Write-Host " [7] Monitoreo en Tiempo Real de Recursos"
    $choice = Read-Host "Elige una utilidad"
    
    switch ($choice) {
        '1' { Add-ContextMenuEntry }
        '2' { Remove-ContextMenuEntry }
        '3' { ToggleHiddenFiles }
        '4' { DisableHibernate }
        '5' { EnablePowerSaver }
        '6' { GenerateSystemReport }
        '7' { Start-ResourceMonitor }
        default { Write-Host "Opci√≥n no v√°lida." -ForegroundColor Red }
    }
}

# --- [9] MODO APOCALIPSIS ---
function Invoke-ApocalypseMode {
    Show-SectionTitle "¬°MODO APOCALIPSIS ACTIVADO! Ejecutando todas las optimizaciones..."
    Invoke-ExhaustiveClean
    Invoke-UniversalUpdate
    Invoke-ExtremeOptimization
    Invoke-DeepDebloat
    Invoke-FreeRAM
    Invoke-SystemMaintenance
    Invoke-SystemDiagnostics
    Write-Log "¬°APOCALIPSIS COMPLETADO! Tu sistema ahora est√° en su forma m√°s pura y optimizada." -ForegroundColor Magenta
}
#endregion

#region FUNCIONES AUXILIARES
function Add-ContextMenuEntry {
    $scriptPath = $MyInvocation.MyCommand.Path
    $regPath = "HKCU:\Software\Classes\DesktopBackground\Shell\OptimizadorLeviatan"
    $commandPath = "HKCU:\Software\Classes\DesktopBackground\Shell\OptimizadorLeviatan\command"
    
    New-Item -Path $regPath -Name "Icon" -Value "imageres.dll,-109" -Force
    New-Item -Path $regPath -Name "Position" -Value "Bottom" -Force
    New-Item -Path $commandPath -Value "powershell.exe -NoExit -Command `". '$scriptPath'`"" -Force
    
    Write-Log "Men√∫ contextual a√±adido. Haz clic derecho en el escritorio." -ForegroundColor Green
}

function Remove-ContextMenuEntry {
    $regPath = "HKCU:\Software\Classes\DesktopBackground\Shell\OptimizadorLeviatan"
    Remove-Item -Path $regPath -Recurse -Force -ErrorAction SilentlyContinue
    Write-Log "Men√∫ contextual eliminado." -ForegroundColor Green
}

function ToggleHiddenFiles {
    $currentValue = (Get-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced").Hidden
    $newValue = if ($currentValue -eq 1) { 2 } else { 1 }
    Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Name "Hidden" -Value $newValue
    Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Name "HideFileExt" -Value ($newValue -eq 2 ? 1 : 0)
    Stop-Process -Name explorer -Force
    Write-Log "Archivos ocultos y extensiones cambiados." -ForegroundColor Green
}

function DisableHibernate {
    powercfg.exe /hibernate off
    Write-Log "Hibernaci√≥n desactivada." -ForegroundColor Green
}

function EnablePowerSaver {
    powercfg -setactive SCHEME_MIN | Out-Null
    Write-Log "Modo Port√°til activado." -ForegroundColor Green
}

function GenerateSystemReport {
    Write-Log "Generando informe detallado del sistema..."
    systeminfo | Out-File "$env:USERPROFILE\Desktop\Informe_Sistema.txt"
    Get-EventLog -LogName System -Newest 50 | Out-File -Append "$env:USERPROFILE\Desktop\Informe_Sistema.txt"
    Get-EventLog -LogName Application -Newest 50 | Out-File -Append "$env:USERPROFILE\Desktop\Informe_Sistema.txt"
    Write-Log "Informe generado en: $env:USERPROFILE\Desktop\Informe_Sistema.txt" -ForegroundColor Green
}

function Start-ResourceMonitor {
    Write-Log "Iniciando monitor de recursos en segundo plano..."
    while ($true) {
        $cpu = (Get-Counter "\Processor(_Total)\% Processor Time").CounterSamples.CookedValue
        $ram = (Get-Counter "\Memory\Available MBytes").CounterSamples.CookedValue
        $disk = (Get-Counter "\LogicalDisk(C:)\% Disk Time").CounterSamples.CookedValue
        $temp = (Get-WmiObject -Namespace root\WMI -Class MSAcpi_ThermalZoneTemperature).CurrentTemperature / 10
        
        Write-Host "`rCPU: $([math]::Round($cpu,1))% | RAM: $([math]::Round($ram,0))MB | Disco: $([math]::Round($disk,1))% | Temp: $([math]::Round($temp,1))¬∞C" -NoNewline
        Start-Sleep -Milliseconds 500
    }
}
#endregion

#region EJECUCI√ìN PRINCIPAL
$choice = ''
while ($choice -ne 'q') {
    Show-Menu
    $choice = Read-Host "Introduce tu elecci√≥n"
    
    if ($choice -in '1','2','3','4','5','6','7','8', '9') {
        Create-RestorePoint
    }
    
    switch ($choice) {
        '1' { Invoke-ExhaustiveClean }
        '2' { Invoke-UniversalUpdate }
        '3' { Invoke-ExtremeOptimization }
        '4' { Invoke-DeepDebloat }
        '5' { Invoke-FreeRAM }
        '6' { Invoke-SystemMaintenance }
        '7' { Invoke-SystemDiagnostics }
        '8' { Invoke-SystemUtilities }
        '9' { Invoke-ApocalypseMode }
        'q' { break }
        default { Write-Host "Opci√≥n no v√°lida." -ForegroundColor Red }
    }
    
    if ($choice -in '1','2','3','4','5','6','7','8', '9') {
        Show-SectionTitle "Operaci√≥n Completada"
        Write-Host "üéâ ¬°La operaci√≥n seleccionada ha finalizado!" -ForegroundColor Green
        Write-Host "Se ha creado un registro detallado en tu escritorio:" -ForegroundColor Cyan
        Write-Host "$logFile" -ForegroundColor White
        Write-Host "Se recomienda ENCARECIDAMENTE reiniciar el sistema para que todos los cambios surtan efecto." -ForegroundColor Yellow
        Read-Host "Presiona Enter para volver al men√∫..."
    }
}

Write-Host "Gracias por usar Optimizador Leviat√°n. ¬°Disfruta del poder!" -ForegroundColor Cyan
Start-Sleep -Seconds 3
#endregion
