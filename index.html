<!DOCTYPE html>
<!-- 
  ===================================================================================================
  ARCHIVO HTML OPTIMIZADO - LEVIATÁN v15.0
  Autor de la optimización: Asistente de Desarrollo Web
  Fecha de optimización: 2024-10-04

  Resumen de mejoras clave:
  1.  **Semántica HTML/CSS:** Se movió el CSS a una etiqueta <style> dedicada en el <head> para mayor claridad, 
      manteniendo la carga prioritaria para evitar el bloqueo de renderizado.
  2.  **JavaScript Moderno:** Se eliminaron los atributos 'onclick' en línea. Todos los eventos se manejan 
      con 'addEventListener' en un único script diferido (<script defer>), mejorando la separación de 
      responsabilidades (HTML para estructura, JS para comportamiento).
  3.  **Mejora de la Experiencia de Usuario (UX):** Se reemplazó la función 'alert()' por un modal no intrusivo 
      y estilizado, lo que evita bloquear la interacción del usuario y ofrece una presentación más profesional.
  4.  **Accesibilidad y Mantenibilidad:** Se mejoró la estructura del script para facilitar futuras 
      actualizaciones y se aseguró que todos los elementos interactivos sigan siendo accesibles.
  5.  **Compatibilidad:** La interfaz web es totalmente compatible con cualquier sistema operativo moderno que 
      tenga un navegador web, mientras que el script de PowerShell está diseñado específicamente para Windows.
  ===================================================================================================
-->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Script LEVIATÁN v15.0 - Limpieza, aceleración y optimización extrema de Windows con menú interactivo, seguridad y control de telemetría.">
    <title>LEVIATÁN v15.0 - Optimizador Extremo Avanzado (Optimizado)</title>
    
    <!-- OPTIMIZACIÓN: Se usa un Data URI para el favicon para ahorrar una petición HTTP. -->
    <link rel="icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQEAYAAABPYyMiAAAABmJLR0T///////8JWPfcAAAACXBIWXMAAABIAAAASABGyWs+AAAAF0lEQVRIx2NgGAWjYBSMglEwCkbBSAcAATAAAf/0/wcAAAAASUVORK5CYII=" type="image/x-icon">
    
    <!-- 
      OPTIMIZACIÓN: El CSS crítico se coloca directamente en el <head> dentro de una etiqueta <style>.
      Esto es semánticamente más correcto que usar un script para inyectarlo.
      Permite al navegador renderizar la página con estilos desde el inicio sin esperar un archivo externo,
      mejorando drásticamente el "First Contentful Paint" (FCP).
    -->
    <style>
      :root {
        --background-dark: #0d1117; --text-dark: #c9d1d9;
        --background-light: #f9fafb; --text-light: #1f2937;
        --primary-color: #4f46e5; --primary-hover: #4338ca;
        --secondary-color: #374151; --secondary-hover: #4b5563;
        --success-color: #059669; --success-hover: #047857;
        --error-color: #dc2626;
        --code-bg-dark: #1e293b; --code-bg-light: #ffffff;
        --border-color: #4f46e5; --border-focus: #818cf8;
        --highlight-bg: #fef08a; --highlight-text: #1e293b;
        --shadow-light: rgba(0,0,0,0.1); --shadow-dark: rgba(0,0,0,0.25);
      }
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background-color: var(--background-dark);
        color: var(--text-dark);
        margin: 0; padding: 0;
        min-height: 100vh;
        display: flex; flex-direction: column;
        align-items: center;
        transition: background-color .3s, color .3s;
      }
      .container { max-width: min(95%, 1200px); width: 100%; padding: 1rem; }
      .header { text-align: center; margin-bottom: 1.5rem; }
      .title { font-size: 2.25rem; font-weight: 800; margin-bottom: .5rem; color: var(--border-focus); }
      .code-container {
        background-color: var(--code-bg-dark); color: var(--text-dark);
        padding: 1.5rem; border-radius: 1rem;
        box-shadow: 0 25px 50px -12px var(--shadow-dark);
        overflow: auto;
        border: 4px solid var(--border-color);
        position: relative;
      }
      .code-container pre { white-space: pre-wrap; word-break: break-all; margin: 0; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: .875rem; line-height: 1.5; }
      .button-container { display: flex; flex-wrap: wrap; gap: .5rem; justify-content: center; margin-top: 1.5rem; width: 100%; }
      .btn {
        background-color: var(--primary-color); color: white; font-weight: 700;
        padding: .75rem 1.5rem; border-radius: .5rem; border: none;
        cursor: pointer; transition: all .2s;
        box-shadow: 0 10px 15px -3px var(--shadow-light);
      }
      .btn:hover { background-color: var(--primary-hover); transform: scale(1.05); }
      .btn-secondary { background-color: var(--secondary-color); }
      .btn-secondary:hover { background-color: var(--secondary-hover); }
      .btn-success { background-color: var(--success-color); }
      .btn-success:hover { background-color: var(--success-hover); }
      .message-box {
        position: fixed; top: 1.5rem; left: 50%;
        transform: translateX(-50%);
        background-color: #1f2937; color: white;
        padding: .75rem 1.5rem; border-radius: .75rem;
        box-shadow: 0 25px 50px -12px var(--shadow-dark);
        opacity: 0; transition: opacity .5s, transform .5s;
        pointer-events: none; z-index: 100;
      }
      .message-box.show { opacity: 1; pointer-events: auto; transform: translate(-50%, 10px); }
      .message-box.success { background-color: var(--success-color); }
      .message-box.error { background-color: var(--error-color); }
      .theme-toggle { position: absolute; top: 1rem; right: 1rem; background: transparent; border: none; cursor: pointer; font-size: 1.5rem; }
      .search-container { position: relative; margin-bottom: 1rem; }
      .search-box {
        width: 100%; padding: .75rem 1rem; border-radius: .5rem;
        border: 2px solid var(--border-color); background-color: var(--code-bg-dark);
        color: var(--text-dark); font-size: 1rem;
      }
      .search-box:focus { outline: none; border-color: var(--border-focus); }
      .search-results { position: absolute; top: 100%; left: 0; right: 0; background-color: var(--code-bg-dark); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 .5rem .5rem; max-height: 200px; overflow-y: auto; z-index: 10; }
      .search-result-item { padding: .5rem 1rem; cursor: pointer; border-bottom: 1px solid var(--secondary-color); }
      .search-result-item:hover { background-color: var(--secondary-color); }
      .highlight { background-color: var(--highlight-bg); color: var(--highlight-text); padding: 0 2px; border-radius: 2px; }
      .function-info { background-color: var(--secondary-color); border-left: 4px solid var(--border-color); padding: 1rem; margin: 1rem 0; border-radius: 0 .5rem .5rem 0; }
      .function-info h3 { margin-top: 0; color: var(--border-focus); }
      .function-info p { margin-bottom: .5rem; }
      /* Modal Styles */
      .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
      .modal-overlay.show { opacity: 1; pointer-events: auto; }
      .modal-content { background: var(--code-bg-dark); color: var(--text-dark); padding: 2rem; border-radius: 1rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative; }
      .modal-content h2 { color: var(--border-focus); margin-top: 0; }
      .modal-content pre { background: var(--background-dark); padding: 1rem; border-radius: .5rem; white-space: pre-wrap; }
      .modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: var(--text-dark); cursor: pointer; }
      
      @media (max-width:768px) {
        .title { font-size: 1.875rem; }
        .code-container { padding: 1rem; }
        .btn { width: 100%; }
      }
      body.light-mode { background-color: var(--background-light); color: var(--text-light); }
      .light-mode .code-container, .light-mode .modal-content { background-color: var(--code-bg-light); color: var(--text-light); border-color: var(--border-focus); box-shadow: 0 4px 6px -1px var(--shadow-light); }
      .light-mode .modal-content pre { background: #f1f5f9; }
      .light-mode .btn { box-shadow: 0 4px 6px -1px var(--shadow-light); }
      .light-mode .search-box { background-color: var(--code-bg-light); color: var(--text-light); border-color: var(--border-focus); }
      .light-mode .function-info { background-color: #e5e7eb; color: var(--text-light); }
      .light-mode .modal-close { color: var(--text-light); }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="title">
                <span aria-hidden="true">🌊</span> LEVIATÁN v15.0 - Optimizador Extremo Avanzado
            </h1>
            <p>Script PowerShell para limpieza profunda, aceleración máxima y optimización de Windows</p>
        </header>
        
        <main>
            <div class="search-container">
                <input type="text" class="search-box" id="searchBox" placeholder="Buscar en el script (funciones, comandos, etc.)">
                <div class="search-results" id="searchResults" style="display: none;"></div>
            </div>
            
            <section class="code-container" aria-label="Código del script de optimización">
                <button class="theme-toggle" id="themeToggle" aria-label="Cambiar tema">🌓</button>
                <pre><code class="script-content" id="scriptContent"># Cargando script LEVIATÁN v15.0...</code></pre>
            </section>
            
            <div class="function-info" id="functionInfo" style="display: none;">
                <h3 id="functionName">Nombre de la función</h3>
                <p id="functionDescription">Descripción de la función</p>
                <p><strong>Uso:</strong> <code id="functionUsageCode"></code></p>
            </div>
            
            <div class="button-container">
                <!-- OPTIMIZACIÓN: Se eliminan los 'onclick' para gestionarlos con addEventListener en el script. -->
                <button id="copyBtn" class="btn" aria-label="Copiar script al portapapeles">
                    📋 Copiar Script
                </button>
                <button id="downloadBtn" class="btn btn-secondary" aria-label="Descargar script como archivo">
                    ⬇️ Descargar Script
                </button>
                <button id="stepByStepBtn" class="btn btn-success" aria-label="Ver modo paso a paso">
                    🚶 Modo Paso a Paso
                </button>
            </div>
        </main>
    </div>
    
    <div id="message-box" class="message-box" role="alert" aria-live="polite"></div>

    <!-- MEJORA: Modal para la función "Paso a Paso". Reemplaza el 'alert()' nativo. -->
    <div id="stepByStepModal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <button id="modalCloseBtn" class="modal-close" aria-label="Cerrar">&times;</button>
            <h2 id="modalTitle">Modo Paso a Paso - LEVIATÁN v15.0</h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- 
      OPTIMIZACIÓN: Todo el JavaScript se consolida en un único bloque al final del body.
      El atributo 'defer' asegura que el script se ejecute después de que el HTML haya sido completamente
      analizado, evitando errores de "elemento no encontrado" y mejorando el tiempo de carga percibido.
    -->
    <script defer>
      document.addEventListener('DOMContentLoaded', () => {

        // ===================================================================================================
        //  CONTENIDO DEL SCRIPT Y DATOS
        //  Mantener el contenido del script aquí facilita la gestión como un solo archivo.
        // ===================================================================================================
        const scriptContentText = `# ===================================================================================================
#   PowerScript Optimizador LEVIATÁN v15.0 - Edición EXTREMA, Segura y Avanzada
#   Objetivo: Limpieza Profunda, aceleración máxima, optimización de red, privacidad y REGISTRO.
#   ADVERTENCIA: EJECUTAR SIEMPRE COMO ADMINISTRADOR.
#
#   Este script presenta un menú interactivo para que selecciones las optimizaciones a ejecutar.
# ===================================================================================================

#region VARIABLES Y LOG
# Define la ubicación del archivo de log en el escritorio del usuario
$logFile = "$env:USERPROFILE\\Desktop\\Optimizador-Leviatan-Log-v15.0.txt"

# Función para escribir mensajes en la consola y en el archivo de log
Function Write-Log { 
    param ([string]$Message, [string]$Color = 'Gray')
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    Write-Host "[$timestamp] $Message" -ForegroundColor $Color
    Add-Content -Path $logFile -Value "[$timestamp] $Message"
}
#endregion

#region FUNCIONES DE VALIDACIÓN Y UTILERÍAS
Function Check-Admin {
    # Verifica si el script se está ejecutando con permisos de administrador
    if (-NOT ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
        Write-Warning "Este script requiere privilegios de Administrador. Por favor, reinicia la terminal como Administrador."
        Start-Sleep -Seconds 10
        Exit
    }
}

Function Check-Module {
    param ([string]$ModuleName)
    if (-not (Get-Module -ListAvailable -Name $ModuleName)) {
        Write-Log "El módulo '$ModuleName' no está instalado. Instalándolo..." -Color Yellow
        try {
            Install-Module -Name $ModuleName -Force -Confirm:$false -ErrorAction Stop
            Write-Log "Módulo '$ModuleName' instalado correctamente." -Color Green
        } catch {
            Write-Log "ERROR: No se pudo instalar el módulo '$ModuleName'. La función que lo requiere no se ejecutará." -Color Red
            return $false
        }
    }
    return $true
}

Function New-SystemRestorePoint {
    # Crea un punto de restauración del sistema para mayor seguridad
    Write-Log "Creando un punto de restauración del sistema..." -Color Yellow
    try {
        Checkpoint-Computer -Description "LEVIATÁN v15.0 - Antes de la optimización" -RestorePointType "MODIFY_SETTINGS"
        Write-Log "Punto de restauración creado con éxito." -Color Green
    } catch {
        Write-Log "ERROR: No se pudo crear el punto de restauración. Asegúrate de que la protección del sistema esté habilitada." -Color Red
    }
}
#endregion

#region FUNCIONES DE OPTIMIZACIÓN Y LIMPIEZA EXTREMA

# Función agregada para desfragmentar solo unidades HDD (Opción 8)
Function Defrag-Drives {
    Write-Log "Iniciando desfragmentación de unidades no-SSD..." -Color Cyan
    try {
        Get-Volume | Where-Object { $_.FileSystemType -eq 'NTFS' -and $_.DriveType -eq 'Fixed' -and $_.HealthStatus -eq 'Healthy' } | ForEach-Object {
            $driveLetter = $_.DriveLetter
            
            # Obtener el PhysicalDisk asociado al DriveLetter
            $partition = Get-Partition | Where-Object { $_.DriveLetter -eq $driveLetter }
            if ($partition) {
                $physicalDisk = Get-PhysicalDisk | Where-Object { $_.Number -eq $partition.DiskNumber -and $_.MediaType -ne 'SSD' }
                
                if ($physicalDisk) {
                    Write-Log "Desfragmentando unidad $driveLetter (HDD)..."
                    # Usar -Analyze y luego -Defrag. El cmdlet Optimize-Volume es consciente de los SSDs.
                    Optimize-Volume -DriveLetter $driveLetter -Defrag -Verbose -ErrorAction SilentlyContinue
                } else {
                    Write-Log "Saltando unidad $driveLetter (Es SSD o no es apta)." -Color Yellow
                }
            } else {
                Write-Log "No se encontró la partición para la letra de unidad $driveLetter." -Color Yellow
            }
        }
        Write-Log "Desfragmentación de discos completada." -Color Green
    } catch {
        Write-Log "ERROR al desfragmentar discos: $_" -Color Red
    }
}

Function Clean-System {
    Write-Log "Iniciando limpieza PROFUNDA de archivos temporales..." -Color Cyan
    
    # 1. Limpia directorios temporales estándar
    $tempPaths = @(
        "$env:TEMP\\*",
        "$env:WINDIR\\Temp\\*",
        "$env:USERPROFILE\\AppData\\Local\\Temp\\*"
    )
    foreach ($path in $tempPaths) {
        Remove-Item -Path $path -Recurse -Force -ErrorAction SilentlyContinue
    }
    Write-Log "Directorios temporales estándar limpios."

    # 2. Limpia cachés de Windows (Store, Papelera, Componentes, Logs)
    try {
        WSReset.exe -c | Out-Null
        Clear-RecycleBin -Force -ErrorAction SilentlyContinue
        Dism.exe /online /Cleanup-Image /StartComponentCleanup | Out-Null
        Dism.exe /online /Cleanup-Image /StartComponentCleanup /ResetBase | Out-Null
        Remove-Item -Path "$env:SystemRoot\\SoftwareDistribution\\Download\\*" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "$env:SystemRoot\\Logs\\*" -Recurse -Force -ErrorAction SilentlyContinue
        Write-Log "Cachés de Windows, Update y Logs de sistema limpios."
    } catch {
        Write-Log "Error al limpiar cachés de Windows: $_" -Color Red
    }

    # 3. Limpieza de cachés de miniaturas y prefetch
    try {
        # Limpiar caché de miniaturas
        $shell = New-Object -ComObject Shell.Application
        $shell.Namespace(10).ParseName("C:\\").InvokeVerb("clean") | Out-Null
        Remove-Item -Path "$env:SystemRoot\\Prefetch\\*.pf" -Force -ErrorAction SilentlyContinue
        Write-Log "Cachés de miniaturas y Prefetch limpiadas."
    } catch {
        Write-Log "Error al limpiar cachés de Windows Shell/Prefetch: $_" -Color Red
    }
    
    # 4. Limpieza de cachés de navegadores (Chrome, Edge, Firefox - Requiere cerrar navegadores)
    Write-Log "Limpiando cachés de navegadores (puede requerir cerrar las aplicaciones)..."
    $browserCaches = @(
        "$env:USERPROFILE\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Cache\\*",
        "$env:USERPROFILE\\AppData\\Local\\Microsoft\\Edge\\User Data\\Default\\Cache\\*",
        "$env:USERPROFILE\\AppData\\Local\\Mozilla\\Firefox\\Profiles\\*\\cache2\\entries\\*"
    )
    foreach ($cache in $browserCaches) {
        Remove-Item -Path $cache -Recurse -Force -ErrorAction SilentlyContinue
    }
    Write-Log "Cachés de navegadores principales limpiadas."

    # 5. Limpieza de caché de instaladores MSI (Advertencia: puede afectar la reparación de programas)
    Write-Log "Limpiando caché de instaladores (MSI) antiguos..."
    # Atención: Esta línea era incorrecta y ha sido corregida para apuntar a la base de datos de instaladores, no a la llave de productos.
    # La limpieza de MSI se omite o se haría manualmente para evitar daños en la reparación de aplicaciones.
    Write-Log "La limpieza agresiva de caché MSI ha sido omitida por motivos de seguridad extrema." -Color Yellow

    # 6. Ejecuta el Limpiador de Disco de Windows (Extremo)
    try {
        # Configura el limpiador para incluir todas las opciones (incluyendo archivos de actualización)
        # Esto requiere una configuración previa de sagerset: Cleanmgr /sageset:65535
        # Luego se ejecuta con sagerun: Cleanmgr /sagerun:65535
        Write-Log "Ejecutando Cleanmgr con todas las opciones (Ejecución silenciosa de Limpiador de Disco)."
        Start-Process cleanmgr.exe -ArgumentList '/sagerun:65535' -Wait -NoNewWindow
    } catch {
        Write-Log "Error al ejecutar Cleanmgr: $_" -Color Red
    }
    Write-Log "Limpieza de archivos completada." -Color Green
}

Function Optimize-Network {
    Write-Log "Optimizando red: Reiniciando adaptadores y restableciendo la pila TCP/IP..." -Color Cyan
    try {
        # Reinicia todos los adaptadores de red
        Get-NetAdapter | Restart-NetAdapter -Confirm:$false -ErrorAction Stop
        # Restablece la pila TCP/IP y el catálogo Winsock
        netsh int ip reset -c null | Out-Null
        netsh winsock reset | Out-Null
        # Limpia la caché de DNS
        ipconfig /flushdns
        Write-Log "Optimización de red completada." -Color Green
    } catch {
        Write-Log "ERROR: No se pudo optimizar la red: $_" -Color Red
    }
}

Function Optimize-Memory {
    Write-Log "Liberando memoria RAM (forzando GC)..." -Color Cyan
    try {
        # Esto libera la memoria utilizada por el propio proceso de PowerShell
        [System.GC]::Collect()
        Write-Log "Memoria RAM liberada (GC ejecutado)." -Color Green
    } catch {
        Write-Log "ERROR: No se pudo liberar memoria RAM: $_" -Color Red
    }
}

Function Stop-UnnecessaryServices {
    param ([switch]$Force)
    if (-not $Force) {
        Write-Host "ADVERTENCIA: Detener y deshabilitar servicios puede afectar la funcionalidad del sistema." -ForegroundColor Red
        $confirm = Read-Host "Deseas continuar? (S/N)"
        if ($confirm -ne 'S') {
            Write-Log "Acción cancelada por el usuario."
            return
        }
    }
    Write-Log "Deteniendo y deshabilitando servicios innecesarios..." -Color Cyan
    # Lista de servicios a detener y deshabilitar (Ampliada en v15.0 para mayor agresividad segura)
    $servicios = @(
        "DiagTrack",        # Servicio de seguimiento de diagnóstico
        "dmwappushservice", # Servicio de telemetría
        "XblGameSave",      # Servicio de guardado de juegos de Xbox
        "WMPNetworkSvc",    # Reproductor de Windows Media
        "Fax",              # Servicio de fax
        "SysMain",          # Superfetch/Prefetch (inútil en SSDs)
        "PcaSvc",           # Servicio de compatibilidad de programas
        "XboxGipSvc",       # Xbox Game Input Service
        "XboxNetApiSvc",    # Xbox Live Networking Service
        "cbdhsvc",          # Servicio de portapapeles de usuario
        "CDPSvc",           # Plataforma de dispositivos conectados (sincronización entre dispositivos)
        "MapsBroker",       # Servicio de mapas de Windows
        "WbioSrvc",         # Servicio de biometría de Windows
        "WSearch",          # Servicio de búsqueda de Windows
        "RetailDemo",       # Servicio de modo demo para minoristas
        "PhoneSvc",         # Servicio de teléfono
        "CDPUserSvc",       # Servicios de usuario de la Plataforma de dispositivos conectados
        "MessagingService"  # Servicio de mensajería
    )
    foreach ($svc in $servicios) {
        try {
            if (Get-Service -Name $svc -ErrorAction SilentlyContinue) {
                Write-Log "Deteniendo servicio: $svc"
                Stop-Service -Name $svc -Force -ErrorAction Stop
                Set-Service -Name $svc -StartupType Disabled
            } else {
                Write-Log "Servicio '$svc' no encontrado. Saltando." -Color Yellow
            }
        } catch {
            Write-Log "ERROR al detener/deshabilitar '$svc': $_" -Color Red
        }
    }
    Write-Log "Servicios detenidos y deshabilitados." -Color Green
}

Function Remove-Bloatware {
    param ([switch]$Force)
    if (-not $Force) {
        Write-Host "ADVERTENCIA: Se eliminarán aplicaciones preinstaladas de la Microsoft Store. Esto es irreversible." -ForegroundColor Red
        $confirm = Read-Host "Deseas continuar? (S/N)"
        if ($confirm -ne 'S') {
            Write-Log "Acción cancelada por el usuario."
            return
        }
    }
    Write-Log "Eliminando aplicaciones de bloatware de la Microsoft Store..." -Color Cyan
    $appsToRemove = @(
        "*BingNews*",
        "*SkypeApp*",
        "*ZuneVideo*",
        "*ZuneMusic*",
        "*YourPhone*",
        "*Xbox*",
        "*MixedReality*",
        "*GetHelp*",
        "*MicrosoftSolitaireCollection*",
        "*Paint3D*",
        "*Messaging*",
        "*OneNote*"
    )
    foreach ($app in $appsToRemove) {
        try {
            Write-Log "Eliminando paquete que coincide con: $app"
            Get-AppxPackage -Name $app -AllUsers | Remove-AppxPackage -ErrorAction SilentlyContinue
            Get-AppxProvisionedPackage -Online | Where-Object { $_.PackageName -like $app } | Remove-AppxProvisionedPackage -Online -ErrorAction SilentlyContinue
        } catch {
            Write-Log "ERROR al eliminar el paquete '$app': $_" -Color Red
        }
    }
    Write-Log "Eliminación de bloatware completada." -Color Green
}

Function Update-System {
    Write-Log "Actualizando Windows y aplicaciones instaladas (EXTREMO)..." -Color Magenta
    
    # 1. Actualizar Windows (MANDATORIO)
    if (Check-Module "PSWindowsUpdate") {
        Write-Log "Buscando e instalando actualizaciones de Windows (incluye drivers)..."
        try {
            Get-WUList | Out-File -FilePath "$env:USERPROFILE\\Desktop\\Windows-Updates-List.txt"
            # Buscar e instalar todas las actualizaciones, incluyendo drivers, sin reiniciar automáticamente
            Install-WindowsUpdate -AcceptAll -IgnoreUserInput -Verbose -Confirm:$false -ErrorAction Stop
            Write-Log "Actualización de Windows finalizada. (Puede requerir reinicio)" -Color Green
        } catch {
            Write-Log "ERROR al actualizar Windows: $_" -Color Red
        }
    }

    # 2. Actualizar aplicaciones con Winget (MANDATORIO)
    if (Get-Command winget -ErrorAction SilentlyContinue) {
        Write-Log "Buscando y actualizando todas las aplicaciones con Winget..."
        try {
            winget upgrade --all --silent --accept-source-agreements --accept-package-agreements
            Write-Log "Actualización de aplicaciones con Winget finalizada." -Color Green
        } catch {
            Write-Log "ERROR al actualizar con Winget: $_" -Color Red
        }
    } else {
        Write-Log "El comando 'winget' no se encontró. No se pueden actualizar las aplicaciones." -Color Yellow
    }
    
    Write-Log "Proceso de actualización completo." -Color Green
}

Function Optimize-SSD {
    Write-Log "Iniciando optimización de SSD..." -Color Cyan
    try {
        # Deshabilita la hibernación para liberar espacio y reducir escrituras
        powercfg.exe /hibernate off
        # Deshabilita la indexación de archivos para la unidad C:
        Set-ItemProperty -Path "HKLM:\\SYSTEM\\CurrentControlSet\\Control\\FileSystem" -Name "NtfsDisableLastAccessUpdate" -Value 1 -Type DWord -Force
        # Deshabilita Superfetch/Prefetch (si el servicio no se detuvo antes)
        Set-ItemProperty -Path "HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\Memory Management\\PrefetchParameters" -Name "EnablePrefetcher" -Value 0 -Type DWord -Force
        Set-ItemProperty -Path "HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\Memory Management\\PrefetchParameters" -Name "EnableSuperfetch" -Value 0 -Type DWord -Force
        # Realiza la optimización (TRIM) de la unidad de sistema
        Optimize-Volume -DriveLetter C -ReTrim -Verbose -ErrorAction Stop
        Write-Log "Optimización de SSD completada." -Color Green
    } catch {
        Write-Log "ERROR al optimizar SSD: $_" -Color Red
    }
}

Function Optimize-RegistryTweaks {
    Write-Log "Aplicando Tweaks de Registro EXTREMOS para rendimiento..." -Color Cyan
    try {
        # 1. Reducir el tiempo de espera para matar servicios (apagado más rápido)
        $path = "HKLM:\\SYSTEM\\CurrentControlSet\\Control"
        Set-ItemProperty -Path $path -Name "WaitToKillServiceTimeout" -Value "1000" -Type String -Force # Más agresivo (1000ms)
        Write-Log "WaitToKillServiceTimeout establecido a 1000ms."

        # 2. Deshabilitar PagingExecutive (fuerza a mantener componentes del kernel en memoria física)
        $path = "HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\Memory Management"
        Set-ItemProperty -Path $path -Name "DisablePagingExecutive" -Value 1 -Type DWord -Force
        Write-Log "DisablePagingExecutive habilitado (Kernel en RAM)."
        
        # 3. Optimizar UI Responsiveness
        $path = "HKCU:\\Control Panel\\Desktop"
        Set-ItemProperty -Path $path -Name "MenuShowDelay" -Value "0" -Type String -Force
        Set-ItemProperty -Path $path -Name "WaitToKillAppTimeout" -Value "2000" -Type String -Force
        Write-Log "Tweaks de UI aplicados para mayor rapidez."

        # 4. Deshabilitar Power Throttling
        $path = "HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Power\\PowerThrottling"
        If (-not (Test-Path $path)) { New-Item -Path $path -Force | Out-Null }
        Set-ItemProperty -Path $path -Name "PowerThrottlingOff" -Value 1 -Type DWord -Force
        Write-Log "PowerThrottling deshabilitado."

        # 5. Deshabilitar Network Throttling
        $path = "HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Multimedia\\SystemProfile"
        Set-ItemProperty -Path $path -Name "NetworkThrottlingIndex" -Value 0xFFFFFFFF -Type DWord -Force
        Write-Log "NetworkThrottlingIndex deshabilitado para mejor rendimiento de red."

        Write-Log "Optimización de registro finalizada." -Color Green
    } catch {
        Write-Log "ERROR al aplicar tweaks de registro: $_" -Color Red
    }
}

Function Disable-Telemetry {
    param ([switch]$Force)
    if (-not $Force) {
        Write-Host "ADVERTENCIA: Esta opción deshabilita TODA la recolección de datos y diagnóstico de Windows." -ForegroundColor Red
        $confirm = Read-Host "Deseas continuar? (S/N)"
        if ($confirm -ne 'S') {
            Write-Log "Acción cancelada por el usuario."
            return
        }
    }
    Write-Log "Deshabilitando Telemetría, Diagnóstico y Recolección de Datos..." -Color Cyan

    try {
        # 1. Deshabilitar Telemetría vía Registro
        $path = "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\DataCollection"
        If (-not (Test-Path $path)) { New-Item -Path $path -Force | Out-Null }
        Set-ItemProperty -Path $path -Name "AllowTelemetry" -Value 0 -Type DWord -Force
        Write-Log "Telemetría de Windows deshabilitada (Registro)."

        # 2. Deshabilitar Experiencias de Usuario Conectadas (Servicios)
        $serviceName = "DiagTrack"
        Stop-Service -Name $serviceName -Force -ErrorAction SilentlyContinue
        Set-Service -Name $serviceName -StartupType Disabled -ErrorAction SilentlyContinue
        Write-Log "Servicio de diagnóstico detenido/deshabilitado."

        # 3. Deshabilitar WAP Push Message Routing Service (Telemetría de mensajes)
        $serviceName = "dmwappushservice"
        Stop-Service -Name $serviceName -Force -ErrorAction SilentlyContinue
        Set-Service -Name $serviceName -StartupType Disabled -ErrorAction SilentlyContinue
        Write-Log "Servicio DMWAP Push detenido/deshabilitado."
        
        # 4. Deshabilitar Log de diagnóstico (Registry)
        $path = "HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Diagnostics\\DiagTrack\\Settings"
        If (-not (Test-Path $path)) { New-Item -Path $path -Force | Out-Null }
        Set-ItemProperty -Path $path -Name "DisableLog" -Value 1 -Type DWord -Force
        Write-Log "Log de diagnóstico deshabilitado."

        Write-Log "Telemetría y Diagnóstico deshabilitados." -Color Green

    } catch {
        Write-Log "ERROR al deshabilitar telemetría: $_" -Color Red
    }
}

# NUEVA FUNCIÓN: Bloqueo de Telemetría a nivel de Hosts File (Modo Extremo)
Function Block-TelemetryHosts {
    Write-Log "Aplicando bloqueo de Telemetría vía Hosts File (Modo Extremo)..." -Color Cyan
    $hostsPath = "$env:SystemRoot\\System32\\drivers\\etc\\hosts"
    $newHostsEntries = @(
        "127.0.0.1 telemetry.microsoft.com",
        "127.0.0.1 telecommand.telemetry.microsoft.com",
        "127.0.0.1 settings-win.data.microsoft.com",
        "127.0.0.1 vortex.data.microsoft.com",
        "127.0.0.1 vsgendm.trafficmanager.net"
    )

    try {
        # 1. Copia de seguridad del hosts original
        Copy-Item -Path $hostsPath -Destination "$hostsPath.bak" -Force -ErrorAction Stop
        Write-Log "Copia de seguridad del Hosts File creada en $hostsPath.bak"

        # 2. Leer contenido actual y verificar si ya existen las entradas
        $currentHosts = Get-Content -Path $hostsPath -ErrorAction Stop
        $updated = $false

        foreach ($entry in $newHostsEntries) {
            $domain = $entry.Split(' ')[1]
            if ($currentHosts -notlike "*$domain*") {
                Add-Content -Path $hostsPath -Value "\`n$entry # LEVIATAN BLOCK"
                $updated = $true
            }
        }

        if ($updated) {
            ipconfig /flushdns | Out-Null
            Write-Log "Bloqueos de Telemetría agregados al Hosts File y caché DNS limpiada." -Color Green
        } else {
            Write-Log "Los bloqueos de Telemetría ya existen en el Hosts File. No se realizaron cambios." -Color Yellow
        }
    } catch {
        Write-Log "ERROR al modificar el Hosts File: $_. Revisa los permisos." -Color Red
    }
}

Function Clear-EventLogs {
    Write-Log "Limpiando registros de eventos..." -Color Cyan
    try {
        # Usa Get-WinEvent para logs modernos, es más completo.
        Get-WinEvent -ListLog * -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Log "Limpiando log: $($_.LogName)"
            Clear-EventLog -LogName $_.LogName -ErrorAction SilentlyContinue
        }
        Write-Log "Limpieza de registros de eventos completada." -Color Green
    } catch {
        Write-Log "ERROR al limpiar registros de eventos: $_" -Color Red
    }
}

Function Optimize-Startup {
    Write-Log "Optimizando tareas de inicio programadas..." -Color Cyan
    try {
        $tasksToDisable = @(
            "OneDrive Standalone Update Task",
            "GoogleUpdateTaskMachineUA",
            "GoogleUpdateTaskMachineCore",
            "Adobe Acrobat Update Task",
            "MicrosoftEdgeUpdateTaskMachineUA",
            "MicrosoftEdgeUpdateTaskMachineCore",
            "NvContainerTask" # NVIDIA Telemetry/Updates
        )
        foreach ($taskName in $tasksToDisable) {
            # Búsqueda más amplia en carpetas de tareas
            Get-ScheduledTask -TaskPath "\\" | Where-Object { $_.TaskName -like "*$taskName*" } | ForEach-Object {
                Write-Log "Deshabilitando tarea de inicio: '$($_.TaskName)' en '$($_.TaskPath)'..."
                Disable-ScheduledTask -TaskPath $_.TaskPath -TaskName $_.TaskName -ErrorAction Stop
            }
        }
        Write-Log "Optimización de tareas de inicio completada." -Color Green
    } catch {
        Write-Log "ERROR al optimizar tareas de inicio: $_" -Color Red
    }
}

Function Diagnose-System {
    Write-Log "Iniciando diagnóstico y reparación del sistema..." -Color Cyan
    try {
        # 1. Escanea y repara archivos corruptos del sistema
        sfc /scannow
        
        # 2. Repara la imagen de Windows con DISM
        Write-Log "Ejecutando DISM para restaurar la salud de la imagen de Windows (ScanHealth)..."
        DISM /Online /Cleanup-Image /ScanHealth | Out-Null
        Write-Log "Ejecutando DISM para restaurar la salud de la imagen de Windows (RestoreHealth - Puede tardar)..."
        DISM /Online /Cleanup-Image /RestoreHealth | Out-Null # El Out-Null es para evitar el volcado de texto masivo en la consola
        
        # 3. Escanea el disco C: en busca de errores (programado para el siguiente reinicio si es necesario)
        Write-Log "Escaneando el disco C: en busca de errores (chkdsk)..."
        chkdsk C: /scan
        Write-Log "Diagnóstico de sistema finalizado." -Color Green
    } catch {
        Write-Log "ERROR al diagnosticar el sistema: $_" -Color Red
    }
}

# NUEVA FUNCIÓN: Limpieza de registro avanzada
Function Clean-Registry {
    Write-Log "Realizando limpieza avanzada del registro de Windows..." -Color Cyan
    try {
        # Limpiar entradas de programas desinstalados
        $registryPaths = @(
            "HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall",
            "HKCU:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall"
        )
        
        foreach ($path in $registryPaths) {
            Get-ChildItem -Path $path -ErrorAction SilentlyContinue | ForEach-Object {
                $key = $_.PSChildName
                $displayName = (Get-ItemProperty -Path "$path\\$key" -Name "DisplayName" -ErrorAction SilentlyContinue).DisplayName
                $uninstallString = (Get-ItemProperty -Path "$path\\$key" -Name "UninstallString" -ErrorAction SilentlyContinue).UninstallString
                
                if ($displayName -and -not $uninstallString) {
                    Write-Log "Eliminando entrada de registro huérfana: $displayName"
                    Remove-Item -Path "$path\\$key" -Recurse -Force -ErrorAction SilentlyContinue
                }
            }
        }
        Write-Log "Limpieza del registro completada." -Color Green
    } catch {
        Write-Log "ERROR al limpiar el registro: $_" -Color Red
    }
}

# NUEVA FUNCIÓN: Optimización de energía
Function Optimize-PowerPlan {
    Write-Log "Aplicando plan de energía de alto rendimiento..." -Color Cyan
    try {
        # Establecer plan de alto rendimiento
        powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        # Deshabilitar suspensión USB selectiva
        powercfg -setdcvalueindex SCHEME_CURRENT 2a737441-1930-4402-8d77-b2bebba308a3 48e6b7a6-50f5-4782-a5d4-53bb8f07e226 0
        powercfg -setacvalueindex SCHEME_CURRENT 2a737441-1930-4402-8d77-b2bebba308a3 48e6b7a6-50f5-4782-a5d4-53bb8f07e226 0
        Write-Log "Plan de energía optimizado para máximo rendimiento." -Color Green
    } catch {
        Write-Log "ERROR al optimizar plan de energía: $_" -Color Red
    }
}

Function Run-AllOptimizations {
    Write-Log "INICIANDO EJECUCIÓN COMPLETA DE TODAS LAS OPTIMIZACIONES (EXTREMO)" "Red"
    Write-Host "==========================================================================================" -ForegroundColor Red
    Write-Host " ADVERTENCIA: Esta opción ejecutará TODAS las optimizaciones de forma forzada y sin preguntar." -ForegroundColor Red
    Write-Host " Espere un tiempo considerable, especialmente en la actualización de Windows." -ForegroundColor Red
    Write-Host "==========================================================================================" -ForegroundColor Red
    Start-Sleep -Seconds 7
    
    New-SystemRestorePoint

    # Ejecuta todas las funciones de optimización
    Update-System # Se ejecuta primero para asegurar que el sistema está actualizado
    Clean-System
    Optimize-Network
    Optimize-Memory
    Stop-UnnecessaryServices -Force
    Remove-Bloatware -Force
    Optimize-SSD
    Defrag-Drives # AHORA IMPLEMENTADA
    Disable-Telemetry -Force
    Block-TelemetryHosts # NUEVO
    Optimize-RegistryTweaks 
    Clear-EventLogs
    Optimize-Startup
    Diagnose-System
    Clean-Registry # NUEVA
    Optimize-PowerPlan # NUEVA

    Write-Log "EJECUCIÓN COMPLETA FINALIZADA. SE RECOMIENDA REINICIAR EL SISTEMA." "Green"
}
#endregion

#region EJECUCIÓN
Check-Admin

Write-Log "✔️ Bienvenido a LEVIATÁN v15.0. Por favor, selecciona las opciones que deseas ejecutar." "Green"

while ($true) {
    Write-Host "\`n================ MENÚ DE OPTIMIZACIÓN EXTREMA ================" -ForegroundColor Cyan
    Write-Host "1. Limpieza PROFUNDA (Incluye cachés, prefetch, navegadores)"
    Write-Host "2. Optimizar red (Restablecimiento TCP/IP)"
    Write-Host "3. Liberar memoria RAM (Forzar GC)"
    Write-Host "4. Detener servicios innecesarios (Ampliado v15.0)"
    Write-Host "5. Eliminar Bloatware (Ampliado v15.0 - REQUIERE CONFIRMACIÓN)"
    Write-Host "6. Actualizar Windows y programas instalados (COMPLETO)"
    Write-Host "7. Optimizar SSD (TRIM, Deshabilitar hibernación, Prefetch)"
    Write-Host "8. Desfragmentar discos duros no-SSD (AHORA IMPLEMENTADA)"
    Write-Host "9. Optimizar ajustes de rendimiento (Tweaks de Registro Extremos)"
    Write-Host "10. Deshabilitar Telemetría y Diagnóstico (Registro/Servicios - REQUIERE CONFIRMACIÓN)"
    Write-Host "11. Limpiar registros de eventos"
    Write-Host "12. Optimizar tareas de inicio (Incluye NVIDIA)"
    Write-Host "13. Diagnóstico y reparación del sistema (SFC/DISM)"
    Write-Host "14. Bloqueo de Telemetría vía Hosts File (NUEVO - Bloqueo DNS)"
    Write-Host "15. Limpieza avanzada del registro (NUEVO)"
    Write-Host "16. Optimización de plan de energía (NUEVO)"
    Write-Host "17. Ejecutar TODAS las optimizaciones (ADVERTENCIA: Extrema y Forzada)"
    Write-Host "0. Salir"
    Write-Host "======================================================" -ForegroundColor Cyan
    
    $selection = Read-Host "Ingresa el número de tu opción"

    switch ($selection) {
        "1" { Clean-System }
        "2" { Optimize-Network }
        "3" { Optimize-Memory }
        "4" { Stop-UnnecessaryServices }
        "5" { Remove-Bloatware }
        "6" { Update-System }
        "7" { Optimize-SSD }
        "8" { Defrag-Drives }
        "9" { Optimize-RegistryTweaks }
        "10" { Disable-Telemetry }
        "11" { Clear-EventLogs }
        "12" { Optimize-Startup }
        "13" { Diagnose-System }
        "14" { Block-TelemetryHosts } # Nueva opción
        "15" { Clean-Registry } # Nueva opción
        "16" { Optimize-PowerPlan } # Nueva opción
        "17" { Run-AllOptimizations } # Run All ahora es 17
        "0" { Write-Log "Saliendo del script. ¡Optimización finalizada!"; break }
        default { Write-Log "Opción no válida. Inténtalo de nuevo."; Start-Sleep -Seconds 1 }
    }
}
#endregion`;
        
        const functionDescriptions = {
            "Clean-System": { name: "Limpieza Profunda del Sistema", description: "Elimina archivos temporales, cachés de navegadores, archivos de actualización y otros elementos innecesarios para liberar espacio en disco.", usage: "Clean-System" },
            "Optimize-Network": { name: "Optimización de Red", description: "Reinicia adaptadores de red, restablece la pila TCP/IP y limpia la caché DNS para mejorar la conectividad y velocidad de red.", usage: "Optimize-Network" },
            "Defrag-Drives": { name: "Desfragmentación de Discos", description: "Desfragmenta unidades HDD (excluye SSDs) para mejorar el rendimiento de acceso a datos en discos mecánicos.", usage: "Defrag-Drives" },
            "Stop-UnnecessaryServices": { name: "Detener Servicios Innecesarios", description: "Detiene y deshabilita servicios de Windows que consumen recursos pero no son esenciales para la mayoría de usuarios.", usage: "Stop-UnnecessaryServices [-Force]" },
            "Remove-Bloatware": { name: "Eliminar Aplicaciones Preinstaladas", description: "Elimina aplicaciones de la Microsoft Store que vienen preinstaladas con Windows y que muchos usuarios no utilizan.", usage: "Remove-Bloatware [-Force]" },
            "Update-System": { name: "Actualización del Sistema", description: "Actualiza Windows y todas las aplicaciones instaladas mediante Windows Update y Winget para mantener el sistema seguro y actualizado.", usage: "Update-System" },
            "Optimize-SSD": { name: "Optimización de SSD", description: "Aplica configuraciones específicas para unidades SSD, incluyendo TRIM, deshabilitación de hibernación y optimización de Prefetch.", usage: "Optimize-SSD" },
            "Optimize-RegistryTweaks": { name: "Ajustes de Registro", description: "Aplica modificaciones al registro de Windows para mejorar el rendimiento general del sistema y la responsividad de la interfaz.", usage: "Optimize-RegistryTweaks" },
            "Disable-Telemetry": { name: "Deshabilitar Telemetría", description: "Desactiva la recolección de datos de diagnóstico y telemetría de Windows para mejorar la privacidad.", usage: "Disable-Telemetry [-Force]" },
            "Block-TelemetryHosts": { name: "Bloqueo de Telemetría vía Hosts", description: "Bloquea dominios de telemetría de Microsoft mediante el archivo hosts para prevenir el envío de datos.", usage: "Block-TelemetryHosts" },
            "Clear-EventLogs": { name: "Limpieza de Registros de Eventos", description: "Limpia todos los registros de eventos de Windows para liberar espacio y mantener el sistema organizado.", usage: "Clear-EventLogs" },
            "Optimize-Startup": { name: "Optimización de Inicio", description: "Deshabilita tareas programadas innecesarias que se ejecutan al inicio para reducir el tiempo de arranque.", usage: "Optimize-Startup" },
            "Diagnose-System": { name: "Diagnóstico del Sistema", description: "Ejecuta SFC, DISM y CHKDSK para detectar y reparar problemas del sistema de archivos y la imagen de Windows.", usage: "Diagnose-System" },
            "Clean-Registry": { name: "Limpieza del Registro", description: "Elimina entradas huérfanas y obsoletas del registro de Windows para mejorar la estabilidad y rendimiento.", usage: "Clean-Registry" },
            "Optimize-PowerPlan": { name: "Optimización de Energía", description: "Establece el plan de energía de alto rendimiento y optimiza configuraciones relacionadas para máximo rendimiento.", usage: "Optimize-PowerPlan" },
            "Run-AllOptimizations": { name: "Ejecución Completa", description: "Ejecuta todas las optimizaciones disponibles de forma secuencial para una optimización completa del sistema.", usage: "Run-AllOptimizations" }
        };

        // ===================================================================================================
        //  SELECTORES DE ELEMENTOS DEL DOM
        //  Centralizar los selectores aquí facilita el mantenimiento.
        // ===================================================================================================
        const themeToggle = document.getElementById('themeToggle');
        const scriptContentEl = document.getElementById('scriptContent');
        const searchBox = document.getElementById('searchBox');
        const searchResults = document.getElementById('searchResults');
        const functionInfoEl = document.getElementById('functionInfo');
        const messageBox = document.getElementById('message-box');
        
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const stepByStepBtn = document.getElementById('stepByStepBtn');
        
        const modal = document.getElementById('stepByStepModal');
        const modalBody = document.getElementById('modalBody');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        // ===================================================================================================
        //  FUNCIONES DE LA APLICACIÓN
        // ===================================================================================================

        /**
         * Muestra un mensaje temporal al usuario.
         * @param {string} message - El texto a mostrar.
         * @param {('success'|'error')} type - El tipo de mensaje.
         */
        const showMessage = (message, type = 'success') => {
          messageBox.textContent = message;
          messageBox.className = 'message-box'; // Reset classes
          messageBox.classList.add(type, 'show');
          setTimeout(() => messageBox.classList.remove('show'), 3000);
        };
        
        /** Copia el contenido del script al portapapeles. */
        const copyScript = () => {
          // CORRECCIÓN: Se usa document.execCommand('copy') directamente.
          // Este método es más compatible con entornos de iframe donde la API del Portapapeles
          // (navigator.clipboard) puede estar restringida por políticas de permisos, 
          // que era la causa del error original.
          const textArea = document.createElement('textarea');
          textArea.value = scriptContentText;
          
          // Hacer el textarea invisible para el usuario
          textArea.style.position = 'fixed';
          textArea.style.top = '-9999px';
          textArea.style.left = '-9999px';

          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();

          try {
            const successful = document.execCommand('copy');
            if (successful) {
              showMessage('✔️ Script copiado al portapapeles.');
            } else {
              showMessage('❌ Error al copiar el script.', 'error');
            }
          } catch (err) {
            console.error('Error al ejecutar execCommand: ', err);
            showMessage('❌ Error al copiar el script.', 'error');
          }

          document.body.removeChild(textArea);
        };

        /** Descarga el script como un archivo .ps1 */
        const downloadScript = () => {
          const blob = new Blob([scriptContentText], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'LEVIATAN_v15.0_Optimizador_Extremo.ps1';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showMessage('⬇️ Script descargado correctamente.');
        };

        /** Muestra el modal con la guía paso a paso */
        const showStepByStep = () => {
          const steps = [
              { title: "Verificación de Administrador", description: "El script verifica que se esté ejecutando con privilegios de administrador." },
              { title: "Creación de Punto de Restauración", description: "Se crea un punto de restauración del sistema por seguridad." },
              { title: "Limpieza Profunda del Sistema", description: "Se eliminan archivos temporales, cachés y otros elementos innecesarios." },
              { title: "Optimización de Red", description: "Se reinician adaptadores de red y se restablece la pila TCP/IP." },
              { title: "Liberación de Memoria RAM", description: "Se fuerza la recolección de basura para liberar memoria." },
              { title: "Detención de Servicios Innecesarios", description: "Se detienen y deshabilitan servicios que consumen recursos." },
              { title: "Eliminación de Bloatware", description: "Se eliminan aplicaciones preinstaladas no deseadas." },
              { title: "Actualización del Sistema", description: "Se actualiza Windows y las aplicaciones instaladas." },
              { title: "Optimización de SSD", description: "Se aplican configuraciones específicas para unidades SSD." },
              { title: "Desfragmentación de Discos", description: "Se desfragmentan unidades HDD (excluyendo SSDs)." },
              { title: "Deshabilitación de Telemetría", description: "Se desactiva la recolección de datos de diagnóstico." },
              { title: "Bloqueo de Telemetría vía Hosts", description: "Se bloquean dominios de telemetría mediante el archivo hosts." },
              { title: "Optimización de Registro", description: "Se aplican ajustes de registro para mejorar el rendimiento." },
              { title: "Limpieza de Registros de Eventos", description: "Se limpian todos los registros de eventos." },
              { title: "Optimización de Inicio", description: "Se deshabilitan tareas programadas innecesarias al inicio." },
              { title: "Diagnóstico del Sistema", description: "Se ejecutan SFC, DISM y CHKDSK para detectar y reparar problemas." },
              { title: "Limpieza del Registro", description: "Se eliminan entradas huérfanas del registro." },
              { title: "Optimización de Energía", description: "Se establece el plan de energía de alto rendimiento." }
          ];

          let content = '<h4>Este script ejecuta las siguientes optimizaciones en orden:</h4>';
          content += '<ol>';
          steps.forEach(step => {
              content += `<li><strong>${step.title}:</strong> ${step.description}</li>`;
          });
          content += '</ol>';
          content += `<h4>Para ejecutar el script:</h4>
                      <pre>1. Guarda el script como 'LEVIATAN_v15.0.ps1'
2. Abre PowerShell como Administrador
3. Ejecuta: Set-ExecutionPolicy RemoteSigned (si es necesario)
4. Navega a la carpeta del script y ejecuta: .\\LEVIATAN_v15.0.ps1
5. Sigue las instrucciones en pantalla</pre>
                      <p><strong>ADVERTENCIA:</strong> Siempre ejecuta como Administrador y crea un punto de restauración antes de proceder.</p>`;

          modalBody.innerHTML = content;
          modal.classList.add('show');
        };

        /** Cierra el modal de paso a paso */
        const closeModal = () => modal.classList.remove('show');

        /** Resalta las definiciones de funciones de PowerShell y las hace clickables */
        const highlightFunctions = () => {
          let content = scriptContentEl.innerHTML;
          const functionRegex = /Function (\w+)/g;
          content = content.replace(functionRegex, '<span class="function-name" style="color: #60a5fa; cursor: pointer; text-decoration: underline;">Function $1</span>');
          scriptContentEl.innerHTML = content;
        };
        
        /**
         * Resalta una línea específica en el código y se desplaza hacia ella.
         * @param {number} lineIndex - El índice de la línea a resaltar.
         */
        const highlightAndScrollToLine = (lineIndex) => {
          const lines = scriptContentEl.textContent.split('\n');
          const highlightedLines = lines.map((line, index) => 
              index === lineIndex ? `<span class="highlight">${line}</span>` : line
          );
          
          scriptContentEl.innerHTML = highlightedLines.join('\n');
          highlightFunctions(); // Re-aplicar el resaltado de funciones
          
          const lineElement = scriptContentEl.querySelector('.highlight');
          if (lineElement) {
            lineElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => {
                lineElement.outerHTML = lineElement.innerHTML; // Quitar el span de highlight
            }, 3000);
          }
        };

        // ===================================================================================================
        //  LÓGICA DE INICIALIZACIÓN
        // ===================================================================================================
        function init() {
          // Cargar contenido del script
          scriptContentEl.textContent = scriptContentText;
          highlightFunctions();

          // Configurar tema (claro/oscuro)
          const savedTheme = localStorage.getItem('theme') || 'dark';
          if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
            themeToggle.textContent = '🌙';
          }
          themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            themeToggle.textContent = isLight ? '🌙' : '🌓';
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
          });

          // Configurar listeners de eventos para los botones
          copyBtn.addEventListener('click', copyScript);
          downloadBtn.addEventListener('click', downloadScript);
          stepByStepBtn.addEventListener('click', showStepByStep);

          // Configurar modal
          modalCloseBtn.addEventListener('click', closeModal);
          modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
          });

          // Configurar búsqueda
          searchBox.addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();
            if (query.length < 2) {
              searchResults.style.display = 'none';
              return;
            }
            
            const lines = scriptContentText.split('\n');
            const matches = lines.reduce((acc, line, index) => {
                if (line.toLowerCase().includes(query)) {
                    acc.push({ line: index + 1, content: line.trim(), index: index });
                }
                return acc;
            }, []);

            if (matches.length > 0) {
              searchResults.innerHTML = '';
              matches.slice(0, 10).forEach(match => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.textContent = `Línea ${match.line}: ${match.content.substring(0, 80)}${match.content.length > 80 ? '...' : ''}`;
                item.onclick = () => {
                  highlightAndScrollToLine(match.index);
                  searchResults.style.display = 'none';
                  searchBox.value = '';
                };
                searchResults.appendChild(item);
              });
              searchResults.style.display = 'block';
            } else {
              searchResults.style.display = 'none';
            }
          });
          document.addEventListener('click', (e) => {
            if (!searchBox.contains(e.target) && !searchResults.contains(e.target)) {
              searchResults.style.display = 'none';
            }
          });
          
          // Configurar click en nombres de funciones
          scriptContentEl.addEventListener('click', (e) => {
              if(e.target.classList.contains('function-name')) {
                  const functionName = e.target.textContent.replace('Function ', '').trim();
                  const info = functionDescriptions[functionName];
                  if (info) {
                      document.getElementById('functionName').textContent = info.name;
                      document.getElementById('functionDescription').textContent = info.description;
                      document.getElementById('functionUsageCode').textContent = info.usage;
                      functionInfoEl.style.display = 'block';
                      functionInfoEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                  }
              }
          });
        }

        // Ejecutar la inicialización
        init();
      });
    </script>
</body>
</html>

