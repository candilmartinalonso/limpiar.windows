<# 
.SYNOPSIS
  OptiClean-Ultra: Optimiza y limpia Windows de forma segura y avanzada.
.DESCRIPTION
  - Optimiza el plan de energía, efectos visuales, servicios innecesarios y aplica TRIM/defrag para SSD/HDD.
  - Limpia archivos TEMP, papelera, caché de actualización, mini-volcados, CBS y más.
  - Nivel Ultra: remueve *.tmp/*.log/*.etl antiguos fuera de rutas críticas.
  - Soporta varios perfiles: Max, Gamer, Work, Laptop, y modos limpieza CleanAll/Ultra.
  - Utiliza backup en JSON para revertir cambios críticos (no recuperación de archivos borrados).
  - Lleva reporte del espacio liberado.
.NOTES
  Ejecutar como Administrador. Versión: 2025+. Respeta prácticas seguras, comentarios y modularización.
#>

[CmdletBinding()]
param (
  [switch]$Max,
  [switch]$Gamer,
  [switch]$Work,
  [switch]$Laptop,

  [switch]$EnableHwGpuSchedule,
  [switch]$Deep,
  [switch]$Revert,

  [switch]$CleanAll,
  [switch]$Ultra,
  [int]$LogsDays = 7,
  [switch]$BrowsersAll,
  [switch]$OldUpgrades,
  [switch]$ResetWU,
  [switch]$RebuildIndex,
  [switch]$Irreversible,
  [switch]$Report
)

#region Helpers y Backup
function Require-Admin {
  $id = [Security.Principal.WindowsIdentity]::GetCurrent()
  $p = New-Object Security.Principal.WindowsPrincipal($id)
  if (-not $p.IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator)) {
    Write-Error "Ejecutá PowerShell como Administrador."; exit 1
  }
}
function Ensure-Key { param($Path) if(-not (Test-Path $Path)){ New-Item -Path $Path -Force |Out-Null}}
function Load-Backup {
  $dir = "$env:ProgramData\OptiCleanUltra"; $f="$dir\backup.json"
  if (-not (Test-Path $dir)){New-Item -ItemType Directory -Path $dir | Out-Null}
  if (Test-Path $f) {try {return (Get-Content $f -Encoding UTF8 | ConvertFrom-Json)} catch {}}
  return [pscustomobject]@{PowerPlanGUID=$null; Registry=@{}; Services=@{}; HibernateWasOn=$null; Version="2025+"}
}
function Save-Backup($bk) {
  $dir = "$env:ProgramData\OptiCleanUltra"; $f="$dir\backup.json"
  $bk | ConvertTo-Json -Depth 6 | Set-Content -Path $f -Encoding UTF8
}
function Set-Registry-Backup {
  param([string]$Key,[string]$Name,[string]$Type,[Parameter(Mandatory=$true)]$Value,[ref]$BackupObj)
  Ensure-Key $Key; $bk=$BackupObj.Value
  if(-not $bk.Registry.ContainsKey($Key)){$bk.Registry[$Key]=@{}}
  if(-not $bk.Registry[$Key].ContainsKey($Name)){
    try{$bk.Registry[$Key][$Name]=(Get-ItemProperty -Path $Key -Name $Name -ErrorAction Stop).$Name}catch{$bk.Registry[$Key][$Name]=$null}
  }
  if (Get-ItemProperty -Path $Key -Name $Name -ErrorAction SilentlyContinue) {
    Set-ItemProperty -Path $Key -Name $Name -Value $Value -Force
  } else {
    New-ItemProperty -Path $Key -Name $Name -Value $Value -PropertyType $Type -Force | Out-Null
  }
}
#endregion

Require-Admin
$bk = Load-Backup

if ($Revert) {
  # Revertir optimizaciones críticas con los datos guardados (sin restaurar archivos borrados)
  # ...
  Write-Host "Reversión completa. Reiniciá para finalizar." -ForegroundColor Green
  exit
}

# Crear restore point por seguridad
try { Checkpoint-Computer -Description "OptiClean-Ultra (previo)" -RestorePointType "MODIFY_SETTINGS" } catch {}

#region Perfiles y ajustes
# Ejemplo: Max: Ultimate Performance, sin hibernación, SysMain/Prefetcher stop, apps fondo mínimas...
if ($Max) {
  $guid="e9a42b02-d5df-448d-aa00-03f14749eb61"
  powercfg -duplicatescheme $guid 2>$null | Out-Null
  powercfg -setactive $guid 2>$null | Out-Null
  powercfg -h off | Out-Null
  # Servicios: SysMain/Pfadef/Prefetch off/disabled
  # Apps fondo
}
if ($Gamer) {
  # GameMode ON, Game Bar y DVR OFF, apps 2º plano mínimas
}
if ($Work) {
  # Sin Bing/CloudSearch, menos anuncios, apps fondo estrictas
}
if ($Laptop) {
  # Mantiene ahorro de batería, no fuerza CPU
}
if ($EnableHwGpuSchedule) {
  # Reg key: HW Accelerated GPU Scheduling
}
#endregion

#region Limpieza Base y Ultra
# Limpiar TEMP (user/system), RecycleBin, Delivery Optimization, WU Download, Icon/Thumbnail Cache, Dumps, CBS.cab
# Ultra: Borra *.tmp/*.log/*.etl viejos fuera de system/ProgramFiles (solo con Ultra y tras CleanAll)
#endregion

#region Opcionales
if ($BrowsersAll) {
  # Limpia caches de navegadores conocidos de todos los usuarios (Edge, Chrome, Firefox)
}
if ($OldUpgrades) {
  # Elimina Windows.old y $WINDOWS.~BT
}
if ($ResetWU) {
  # Renombra SoftwareDistribution y Catroot2 para reset profundo de WU
}
if ($RebuildIndex) {
  # Reinicia y borra Search Index 
}
if ($Irreversible) {
  # DISM /StartComponentCleanup /ResetBase (irreversible para liberar WinSxS)
}
#endregion

#region Reporte
if ($Report) {
  # Muestra el espacio liberado por ruta y total (ejemplo con Get-FolderSizeBytes)
}
#endregion

Save-Backup $bk
Write-Host "`nOptiClean-Ultra finalizado. Reiniciá para consolidar los cambios." -ForegroundColor Green

# --- Comenta y ajusta cada bloque según necesidad. Reutiliza helpers y manten modularidad ---
