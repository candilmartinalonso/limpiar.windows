<!DOCTYPE html>
<!-- 
  ===================================================================================================
  ARCHIVO HTML OPTIMIZADO - TIT√ÅN v16.0 (Versi√≥n Evolucionada y Segura)
  Autor de la optimizaci√≥n: Experto en Optimizaci√≥n de Sistemas Windows

  Resumen de mejoras clave en esta versi√≥n del script:
  1. **Seguridad y Reversibilidad:** Se introduce un nuevo men√∫ de "Restauraci√≥n" que permite revertir cambios cr√≠ticos (servicios, archivo hosts, plan de energ√≠a), aumentando dr√°sticamente la seguridad.
  2. **Nuevas Optimizaciones Avanzadas:**
     - Desbloqueo y activaci√≥n del plan de energ√≠a de "M√°ximo Rendimiento".
     - Optimizaci√≥n de efectos visuales para una interfaz m√°s r√°pida.
     - Cambio a DNS m√°s r√°pidos y privados (Cloudflare).
     - A√±adido del pr√°ctico men√∫ contextual "Tomar Posesi√≥n".
  3. **Eficiencia y Claridad Mejoradas:** El c√≥digo ha sido refactorizado para mayor legibilidad. Los comentarios ahora explican el "porqu√©" de cada acci√≥n, y la salida en consola es m√°s clara.
  4. **Gesti√≥n Inteligente de Servicios:** Antes de deshabilitar servicios, el script ahora guarda su estado original, permitiendo una restauraci√≥n precisa.
  5. **Interfaz Web Actualizada:** El c√≥digo HTML y JavaScript se han actualizado para reflejar las nuevas funciones, manteniendo la interactividad y facilidad de uso.
  ===================================================================================================
-->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Script TIT√ÅN v16.0 - Optimizaci√≥n Definitiva, limpieza, aceleraci√≥n y control de privacidad para Windows con men√∫ interactivo y opciones de restauraci√≥n.">
    <title>TIT√ÅN v16.0 - Optimizador Definitivo (Edici√≥n Optimizada)</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%26%239889%3B%3C/text%3E%3C/svg%3E">
    
    <style>
      :root{--background-dark:#0d1117;--text-dark:#c9d1d9;--background-light:#f9fafb;--text-light:#1f2937;--primary-color:#0ea5e9;--primary-hover:#0284c7;--secondary-color:#374151;--secondary-hover:#4b5563;--success-color:#16a34a;--success-hover:#15803d;--error-color:#dc2626;--warning-color:#f97316;--code-bg-dark:#1e293b;--code-bg-light:#ffffff;--border-color:#0ea5e9;--border-focus:#38bdf8;--highlight-bg:#fef08a;--highlight-text:#1e293b;--shadow-light:rgba(0,0,0,0.1);--shadow-dark:rgba(0,0,0,0.25)}
      body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background-color:var(--background-dark);color:var(--text-dark);margin:0;padding:0;min-height:100vh;display:flex;flex-direction:column;align-items:center;transition:background-color .3s,color .3s}
      .container{max-width:min(95%,1200px);width:100%;padding:1rem}
      .header{text-align:center;margin-bottom:1.5rem}
      .title{font-size:2.25rem;font-weight:800;margin-bottom:.5rem;color:var(--border-focus)}
      .code-container{background-color:var(--code-bg-dark);color:var(--text-dark);padding:1.5rem;border-radius:1rem;box-shadow:0 25px 50px -12px var(--shadow-dark);overflow:auto;border:4px solid var(--border-color);position:relative}
      .code-container pre{white-space:pre-wrap;word-break:break-all;margin:0;font-family:'Consolas','Monaco','Courier New',monospace;font-size:.875rem;line-height:1.5}
      .button-container{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;margin-top:1.5rem;width:100%}
      .btn{background-color:var(--primary-color);color:#fff;font-weight:700;padding:.75rem 1.5rem;border-radius:.5rem;border:none;cursor:pointer;transition:all .2s;box-shadow:0 10px 15px -3px var(--shadow-light)}
      .btn:hover{background-color:var(--primary-hover);transform:scale(1.05)}
      .btn-secondary{background-color:var(--secondary-color)}
      .btn-secondary:hover{background-color:var(--secondary-hover)}
      .btn-success{background-color:var(--success-color)}
      .btn-success:hover{background-color:var(--success-hover)}
      .message-box{position:fixed;top:1.5rem;left:50%;transform:translateX(-50%);background-color:#1f2937;color:#fff;padding:.75rem 1.5rem;border-radius:.75rem;box-shadow:0 25px 50px -12px var(--shadow-dark);opacity:0;transition:opacity .5s,transform .5s;pointer-events:none;z-index:100}
      .message-box.show{opacity:1;pointer-events:auto;transform:translate(-50%,10px)}
      .message-box.success{background-color:var(--success-color)}
      .message-box.error{background-color:var(--error-color)}
      .theme-toggle{position:absolute;top:1rem;right:1rem;background:transparent;border:none;cursor:pointer;font-size:1.5rem}
      .search-container{position:relative;margin-bottom:1rem}
      .search-box{width:100%;padding:.75rem 1rem;border-radius:.5rem;border:2px solid var(--border-color);background-color:var(--code-bg-dark);color:var(--text-dark);font-size:1rem}
      .search-box:focus{outline:none;border-color:var(--border-focus)}
      .search-results{position:absolute;top:100%;left:0;right:0;background-color:var(--code-bg-dark);border:1px solid var(--border-color);border-top:none;border-radius:0 0 .5rem .5rem;max-height:200px;overflow-y:auto;z-index:10}
      .search-result-item{padding:.5rem 1rem;cursor:pointer;border-bottom:1px solid var(--secondary-color)}
      .search-result-item:hover{background-color:var(--secondary-color)}
      .highlight{background-color:var(--highlight-bg);color:var(--highlight-text);padding:0 2px;border-radius:2px}
      .function-info{background-color:var(--secondary-color);border-left:4px solid var(--border-color);padding:1rem;margin:1rem 0;border-radius:0 .5rem .5rem 0}
      .function-info h3{margin-top:0;color:var(--border-focus)}
      .function-info p{margin-bottom:.5rem}
      .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;transition:opacity .3s ease;pointer-events:none}
      .modal-overlay.show{opacity:1;pointer-events:auto}
      .modal-content{background:var(--code-bg-dark);color:var(--text-dark);padding:2rem;border-radius:1rem;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;position:relative}
      .modal-content h2{color:var(--border-focus);margin-top:0}
      .modal-content pre{background:var(--background-dark);padding:1rem;border-radius:.5rem;white-space:pre-wrap}
      .modal-close{position:absolute;top:1rem;right:1rem;background:none;border:none;font-size:1.5rem;color:var(--text-dark);cursor:pointer}
      
      @media (max-width:768px){.title{font-size:1.875rem}.code-container{padding:1rem}.btn{width:100%}}
      body.light-mode{background-color:var(--background-light);color:var(--text-light)}
      .light-mode .code-container,.light-mode .modal-content{background-color:var(--code-bg-light);color:var(--text-light);border-color:var(--border-focus);box-shadow:0 4px 6px -1px var(--shadow-light)}
      .light-mode .modal-content pre{background:#f1f5f9}
      .light-mode .btn{box-shadow:0 4px 6px -1px var(--shadow-light)}
      .light-mode .search-box{background-color:var(--code-bg-light);color:var(--text-light);border-color:var(--border-focus)}
      .light-mode .function-info{background-color:#e5e7eb;color:var(--text-light)}
      .light-mode .modal-close{color:var(--text-light)}
      .function-name{color:#60a5fa;cursor:pointer;text-decoration:underline}
      .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="title">
                <span aria-hidden="true">‚ö°</span> TIT√ÅN v16.0 - Optimizador Definitivo
            </h1>
            <p>Script PowerShell para optimizaci√≥n extrema, limpieza, control de privacidad y restauraci√≥n segura de Windows.</p>
        </header>
        
        <main>
            <div class="search-container">
                <input type="text" class="search-box" id="searchBox" placeholder="Buscar en el script (funciones, comandos, etc.)" aria-describedby="search-desc">
                <div id="search-desc" class="sr-only">Introduce al menos 2 caracteres para buscar en el c√≥digo fuente.</div>
                <div class="search-results" id="searchResults" style="display: none;" role="listbox" aria-label="Resultados de b√∫squeda"></div>
            </div>
            
            <section class="code-container" aria-label="C√≥digo del script de optimizaci√≥n">
                <button class="theme-toggle" id="themeToggle" aria-label="Cambiar tema">üåì</button>
                <pre><code class="script-content" id="scriptContent"># Cargando script TIT√ÅN v16.0...</code></pre>
            </section>
            
            <div class="function-info" id="functionInfo" style="display: none;" role="region" aria-label="Informaci√≥n de funci√≥n seleccionada">
                <h3 id="functionName">Nombre de la funci√≥n</h3>
                <p id="functionDescription">Descripci√≥n de la funci√≥n</p>
                <p><strong>Uso:</strong> <code id="functionUsageCode"></code></p>
            </div>
            
            <div class="button-container">
                <button id="copyBtn" class="btn" aria-label="Copiar script al portapapeles">
                    üìã Copiar Script
                </button>
                <button id="downloadBtn" class="btn btn-secondary" aria-label="Descargar script como archivo">
                    ‚¨áÔ∏è Descargar Script
                </button>
                <button id="stepByStepBtn" class="btn btn-success" aria-label="Ver modo paso a paso">
                    üö∂ Modo Paso a Paso
                </button>
            </div>
        </main>
    </div>
    
    <div id="message-box" class="message-box" role="alert" aria-live="polite"></div>

    <div id="stepByStepModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <button id="modalCloseBtn" class="modal-close" aria-label="Cerrar modal">&times;</button>
            <h2 id="modalTitle">Modo Paso a Paso - TIT√ÅN v16.0</h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <script defer>
      document.addEventListener('DOMContentLoaded',()=>{const scriptContentText=`# ===================================================================================================
#   PowerScript Optimizador TIT√ÅN v16.0 - Edici√≥n Definitiva, Segura y Reversible
#   Objetivo: Limpieza Profunda, aceleraci√≥n m√°xima, control de privacidad y estabilidad del sistema.
#   ADVERTENCIA: EJECUTAR SIEMPRE COMO ADMINISTRADOR.
#
#   Este script ha sido reestructurado para ofrecer m√°xima seguridad, incluyendo opciones de restauraci√≥n.
# ===================================================================================================

#region VARIABLES GLOBALES Y CONFIGURACI√ìN DEL LOG
$logPath = "$env:USERPROFILE\\Desktop"
$logFile = "$logPath\\Titan-Optimizer-Log-v16.0.txt"
$backupPath = "$logPath\\Titan_Backups"
if (-not (Test-Path $backupPath)) { New-Item -Path $backupPath -ItemType Directory -Force | Out-Null }

# Funci√≥n de Log mejorada para mayor claridad
Function Write-Log { 
    param ([string]$Message, [string]$Color = 'Gray', [string]$Level = 'INFO')
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logEntry = "[$timestamp] [$Level] :: $Message"
    Write-Host $logEntry -ForegroundColor $Color
    Add-Content -Path $logFile -Value $logEntry
}
#endregion

#region FUNCIONES DE VALIDACI√ìN Y UTILER√çAS
Function Check-Admin {
    if (-NOT ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
        Write-Log "Este script requiere privilegios de Administrador. Por favor, reinicia la terminal como Administrador." 'Red' 'FATAL'
        Start-Sleep -Seconds 10
        Exit
    }
}

Function New-SystemRestorePoint {
    Write-Log "Creando un punto de restauraci√≥n del sistema..." 'Yellow' 'ACTION'
    try {
        Checkpoint-Computer -Description "TIT√ÅN v16.0 - Antes de la optimizaci√≥n" -RestorePointType "MODIFY_SETTINGS"
        Write-Log "Punto de restauraci√≥n creado con √©xito." 'Green' 'SUCCESS'
    } catch {
        Write-Log "No se pudo crear el punto de restauraci√≥n. Aseg√∫rate de que la protecci√≥n del sistema est√© habilitada." 'Red' 'ERROR'
    }
}

# NUEVA FUNCI√ìN: Respaldo de claves de registro
Function Backup-RegistryKey {
    param ([string]$RegistryPath)
    $keyName = $RegistryPath.Split('\\')[-1]
    $backupFile = "$backupPath\\RegBackup-$keyName-$(Get-Date -f yyyyMMddHHmmss).reg"
    Write-Log "Respaldando clave de registro: $RegistryPath" 'Cyan' 'INFO'
    try {
        Start-Process "reg" -ArgumentList "export \`"$RegistryPath\`" \`"$backupFile\`" /y" -Wait -NoNewWindow
        Write-Log "Respaldo de '$keyName' creado en '$backupFile'." 'Green' 'SUCCESS'
    } catch {
        Write-Log "No se pudo respaldar la clave '$RegistryPath'." 'Red' 'ERROR'
    }
}
#endregion

#region FUNCIONES DE LIMPIEZA PROFUNDA
Function Clean-System {
    Write-Log "Iniciando limpieza PROFUNDA de archivos del sistema..." 'Cyan' 'SECTION'
    # Limpieza de directorios temporales
    Get-ChildItem -Path $env:TEMP, "$env:WINDIR\\Temp" -Recurse -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
    Write-Log "Directorios temporales est√°ndar limpios." 'Green' 'SUCCESS'

    # Limpieza de cach√©s de Windows (Componentes, Distribuci√≥n de Software)
    DISM.exe /online /Cleanup-Image /StartComponentCleanup /ResetBase | Out-Null
    Remove-Item -Path "$env:SystemRoot\\SoftwareDistribution\\Download\\*" -Recurse -Force -ErrorAction SilentlyContinue
    Write-Log "Cach√©s de Windows Update y Component Store limpiados." 'Green' 'SUCCESS'

    # Limpieza de Prefetch y Papelera de Reciclaje
    Remove-Item -Path "$env:SystemRoot\\Prefetch\\*.pf" -Force -ErrorAction SilentlyContinue
    Clear-RecycleBin -Force -ErrorAction SilentlyContinue
    Write-Log "Archivos Prefetch y Papelera de Reciclaje vaciados." 'Green' 'SUCCESS'
    
    # Limpieza de cach√©s de navegadores (Chrome, Edge, Firefox)
    $browserCaches = @(
        "$env:LOCALAPPDATA\\Google\\Chrome\\User Data\\Default\\Cache\\*",
        "$env:LOCALAPPDATA\\Microsoft\\Edge\\User Data\\Default\\Cache\\*",
        "$env:LOCALAPPDATA\\Mozilla\\Firefox\\Profiles\\*\\cache2\\entries\\*"
    )
    $browserCaches | ForEach-Object { Remove-Item -Path $_ -Recurse -Force -ErrorAction SilentlyContinue }
    Write-Log "Cach√©s de navegadores principales limpiadas." 'Green' 'SUCCESS'
}

Function Clear-EventLogs {
    Write-Log "Limpiando todos los registros de eventos de Windows..." 'Cyan' 'SECTION'
    Get-WinEvent -ListLog * -ErrorAction SilentlyContinue | ForEach-Object {
        $logName = $_.LogName
        Clear-EventLog -LogName $logName -ErrorAction SilentlyContinue
    }
    Write-Log "Limpieza de registros de eventos completada." 'Green' 'SUCCESS'
}
#endregion

#region FUNCIONES DE OPTIMIZACI√ìN DEL SISTEMA
Function Optimize-Services {
    Write-Log "Optimizando servicios de Windows..." 'Cyan' 'SECTION'
    $servicesToDisable = @("DiagTrack", "dmwappushservice", "WMPNetworkSvc", "Fax", "SysMain", "WSearch", "Spooler", "RemoteRegistry", "lfsvc")
    $serviceStates = @{}

    foreach ($svc in $servicesToDisable) {
        try {
            $service = Get-Service -Name $svc -ErrorAction Stop
            # Guarda el estado actual antes de modificarlo
            $serviceStates[$svc] = $service.StartType
            Write-Log "Deshabilitando servicio: $svc (Estado original: $($service.StartType))" 'Yellow' 'ACTION'
            Stop-Service -Name $svc -Force -ErrorAction Stop
            Set-Service -Name $svc -StartupType Disabled -ErrorAction Stop
        } catch {
            Write-Log "Servicio '$svc' no encontrado o no se pudo modificar." 'Red' 'ERROR'
        }
    }
    # Exporta los estados originales para la restauraci√≥n
    $serviceStates | Export-CliXml -Path "$backupPath\\service_states_backup.xml"
    Write-Log "Servicios innecesarios deshabilitados. Respaldo de estados creado." 'Green' 'SUCCESS'
}

Function Remove-Bloatware {
    Write-Log "Eliminando aplicaciones preinstaladas (Bloatware)..." 'Cyan' 'SECTION'
    $appsToRemove = @("*BingNews*", "*SkypeApp*", "*Zune*", "*YourPhone*", "*Xbox*", "*MixedReality*", "*GetHelp*", "*Solitaire*", "*Paint3D*", "*People*", "*WindowsFeedbackHub*", "*WindowsMaps*", "*Clipchamp*", "*Teams*")
    
    foreach ($app in $appsToRemove) {
        Write-Log "Intentando eliminar paquetes que coincidan con: $app" 'Yellow' 'ACTION'
        Get-AppxPackage -Name $app -AllUsers | Remove-AppxPackage -ErrorAction SilentlyContinue
        Get-AppxProvisionedPackage -Online | Where-Object { $_.PackageName -like $app } | Remove-AppxProvisionedPackage -Online -ErrorAction SilentlyContinue
    }
    Write-Log "Eliminaci√≥n de bloatware completada." 'Green' 'SUCCESS'
}

Function Optimize-PerformanceTweaks {
    Write-Log "Aplicando ajustes de rendimiento (Registro y Sistema)..." 'Cyan' 'SECTION'
    # 1. Ajustes de apagado m√°s r√°pido
    $regPath = "HKLM:\\SYSTEM\\CurrentControlSet\\Control"
    Backup-RegistryKey -RegistryPath $regPath
    Set-ItemProperty -Path $regPath -Name "WaitToKillServiceTimeout" -Value "2000" -Type String -Force
    Write-Log "Tiempo de espera para cerrar servicios reducido a 2000ms." 'Green' 'SUCCESS'

    # 2. Deshabilitar telemetr√≠a
    $regPath = "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\DataCollection"
    Backup-RegistryKey -RegistryPath $regPath
    If (-not (Test-Path $regPath)) { New-Item -Path $regPath -Force | Out-Null }
    Set-ItemProperty -Path $regPath -Name "AllowTelemetry" -Value 0 -Type DWord -Force
    Write-Log "Telemetr√≠a de Windows deshabilitada." 'Green' 'SUCCESS'

    # 3. Optimizar UI (men√∫s m√°s r√°pidos)
    $regPath = "HKCU:\\Control Panel\\Desktop"
    Backup-RegistryKey -RegistryPath $regPath
    Set-ItemProperty -Path $regPath -Name "MenuShowDelay" -Value "100" -Type String -Force
    Write-Log "Retraso de men√∫s reducido para una UI m√°s √°gil." 'Green' 'SUCCESS'
}

# NUEVA FUNCI√ìN: Optimizar efectos visuales
Function Set-VisualEffects {
    Write-Log "Optimizando efectos visuales para m√°ximo rendimiento..." 'Cyan' 'SECTION'
    $regPath = "HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\VisualEffects"
    Backup-RegistryKey -RegistryPath $regPath
    # '2' significa "Mejor rendimiento", deshabilita todos los efectos.
    Set-ItemProperty -Path $regPath -Name "VisualFXSetting" -Value 2 -Type DWord -Force
    Write-Log "Efectos visuales configurados para 'Mejor rendimiento'." 'Green' 'SUCCESS'
    # Se necesita reiniciar el explorador para que aplique
    Write-Log "Se recomienda reiniciar el Explorador de Windows o el sistema para aplicar los cambios." 'Yellow' 'INFO'
}

# NUEVA FUNCI√ìN: Desbloquear y activar plan de energ√≠a de M√°ximo Rendimiento
Function Unlock-UltimatePerformance {
    Write-Log "Activando plan de energ√≠a de 'M√°ximo Rendimiento'..." 'Cyan' 'SECTION'
    $ultimatePlanGuid = "e9a42b02-d5df-448d-aa00-03f14749eb61"
    $currentPlans = powercfg /LIST
    if ($currentPlans -notmatch $ultimatePlanGuid) {
        Write-Log "El plan de 'M√°ximo Rendimiento' no est√° presente. Import√°ndolo..." 'Yellow' 'ACTION'
        powercfg -duplicatescheme 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c $ultimatePlanGuid
    }
    powercfg /SETACTIVE $ultimatePlanGuid
    Write-Log "Plan de energ√≠a 'M√°ximo Rendimiento' activado." 'Green' 'SUCCESS'
}
#endregion

#region FUNCIONES DE RED Y ACTUALIZACIONES
Function Update-System {
    Write-Log "Buscando e instalando actualizaciones (Windows y Winget)..." 'Cyan' 'SECTION'
    # Actualizar Windows
    Write-Log "Instalando actualizaciones de Windows..." 'Yellow' 'ACTION'
    Install-Module -Name PSWindowsUpdate -Force -Confirm:$false -Scope CurrentUser -ErrorAction SilentlyContinue
    Import-Module PSWindowsUpdate -ErrorAction SilentlyContinue
    Install-WindowsUpdate -AcceptAll -IgnoreReboot -Verbose -Confirm:$false
    
    # Actualizar aplicaciones con Winget
    Write-Log "Actualizando aplicaciones con Winget..." 'Yellow' 'ACTION'
    winget upgrade --all --silent --accept-source-agreements --accept-package-agreements
    Write-Log "Proceso de actualizaci√≥n completo." 'Green' 'SUCCESS'
}

Function Block-TelemetryHosts {
    Write-Log "Bloqueando dominios de telemetr√≠a en el archivo Hosts..." 'Cyan' 'SECTION'
    $hostsPath = "$env:SystemRoot\\System32\\drivers\\etc\\hosts"
    $telemetryDomains = @(
        "telemetry.microsoft.com", "vortex.data.microsoft.com", "settings-win.data.microsoft.com"
    )
    # Respalda el archivo hosts antes de modificarlo
    Copy-Item -Path $hostsPath -Destination "$backupPath\\hosts.bak" -Force
    
    $currentHosts = Get-Content -Path $hostsPath
    foreach ($domain in $telemetryDomains) {
        if ($currentHosts -notcontains $domain) {
            Add-Content -Path $hostsPath -Value "0.0.0.0 $domain # Bloqueado por TITAN Optimizer"
        }
    }
    ipconfig /flushdns | Out-Null
    Write-Log "Dominios de telemetr√≠a bloqueados y cach√© DNS limpiada." 'Green' 'SUCCESS'
}

# NUEVA FUNCI√ìN: Cambiar a un DNS r√°pido y privado
Function Set-FastDNS {
    Write-Log "Configurando DNS de Cloudflare (1.1.1.1)..." 'Cyan' 'SECTION'
    $dnsServers = "1.1.1.1", "1.0.0.1"
    Get-DnsClientServerAddress -AddressFamily IPv4 | Set-DnsClientServerAddress -ServerAddresses $dnsServers
    Write-Log "Servidores DNS configurados a Cloudflare." 'Green' 'SUCCESS'
}
#endregion

#region FUNCIONES DE UTILIDAD Y CONTEXTUALES
# NUEVA FUNCI√ìN: A√±adir "Tomar Posesi√≥n" al men√∫ contextual
Function Add-TakeOwnership {
    Write-Log "A√±adiendo 'Tomar Posesi√≥n' al men√∫ contextual..." 'Cyan' 'SECTION'
    $regKey = "HKCR\\*\\shell\\runas"
    if (-not (Test-Path $regKey)) {
        New-Item -Path $regKey -Force | Out-Null
        Set-ItemProperty -Path $regKey -Name "(Default)" -Value "Tomar Posesi√≥n" -Force
        Set-ItemProperty -Path $regKey -Name "NoWorkingDirectory" -Value "" -Force
        $commandPath = "$regKey\\command"
        New-Item -Path $commandPath -Force | Out-Null
        Set-ItemProperty -Path $commandPath -Name "(Default)" -Value 'cmd.exe /c takeown /f "%1" && icacls "%1" /grant administrators:F' -Force
        Write-Log "Opci√≥n 'Tomar Posesi√≥n' a√±adida correctamente." 'Green' 'SUCCESS'
    } else {
        Write-Log "La opci√≥n 'Tomar Posesi√≥n' ya parece existir." 'Yellow' 'INFO'
    }
}
#endregion

#region FUNCIONES DE RESTAURACI√ìN (NUEVO Y CR√çTICO)
Function Restore-Services {
    Write-Log "Restaurando servicios a su estado original..." 'Cyan' 'SECTION'
    $backupFile = "$backupPath\\service_states_backup.xml"
    if (Test-Path $backupFile) {
        $serviceStates = Import-CliXml -Path $backupFile
        foreach ($svc in $serviceStates.GetEnumerator()) {
            try {
                Write-Log "Restaurando servicio: $($svc.Name) a '$($svc.Value)'" 'Yellow' 'ACTION'
                Set-Service -Name $svc.Name -StartupType $svc.Value -ErrorAction Stop
            } catch {
                Write-Log "No se pudo restaurar el servicio '$($svc.Name)'." 'Red' 'ERROR'
            }
        }
        Write-Log "Restauraci√≥n de servicios completada." 'Green' 'SUCCESS'
    } else {
        Write-Log "No se encontr√≥ un archivo de respaldo de servicios." 'Red' 'ERROR'
    }
}

Function Restore-HostsFile {
    Write-Log "Restaurando archivo Hosts original..." 'Cyan' 'SECTION'
    $backupFile = "$backupPath\\hosts.bak"
    if (Test-Path $backupFile) {
        Copy-Item -Path $backupFile -Destination "$env:SystemRoot\\System32\\drivers\\etc\\hosts" -Force
        ipconfig /flushdns | Out-Null
        Write-Log "Archivo Hosts restaurado desde el respaldo." 'Green' 'SUCCESS'
    } else {
        Write-Log "No se encontr√≥ un respaldo del archivo Hosts." 'Red' 'ERROR'
    }
}

Function Restore-PowerPlan {
    Write-Log "Restaurando plan de energ√≠a 'Equilibrado'..." 'Cyan' 'SECTION'
    $balancedPlanGuid = "381b4222-f694-41f0-9685-ff5bb260df2e"
    powercfg /SETACTIVE $balancedPlanGuid
    Write-Log "Plan de energ√≠a 'Equilibrado' restaurado." 'Green' 'SUCCESS'
}
#endregion

#region MEN√ö PRINCIPAL Y EJECUCI√ìN
Check-Admin
Write-Log "‚úîÔ∏è Bienvenido a TIT√ÅN v16.0. El LOG se guardar√° en '$logFile'." 'Green' 'SYSTEM'

while ($true) {
    Write-Host "\\n"
    Write-Host "========================== MEN√ö DE OPTIMIZACI√ìN TIT√ÅN v16.0 ==========================" -ForegroundColor Cyan
    Write-Host "    [LIMPIEZA PROFUNDA]                          [OPTIMIZACI√ìN DE RENDIMIENTO]"
    Write-Host " 1. Limpieza completa del sistema             6. Optimizar servicios (Crea respaldo)"
    Write-Host " 2. Eliminar Bloatware (Apps preinstaladas)   7. Ajustes de rendimiento del registro"
    Write-Host " 3. Limpiar registros de eventos de Windows   8. Optimizar efectos visuales (M√°s r√°pido)"
    Write-Host "                                              9. Activar plan de energ√≠a 'M√°ximo Rendimiento'"
    Write-Host "    [RED Y ACTUALIZACIONES]                      [UTILIDADES ADICIONALES]"
    Write-Host " 4. Actualizar Sistema (Windows & Winget)    10. Cambiar DNS a Cloudflare (M√°s r√°pido/privado)"
    Write-Host " 5. Bloquear Telemetr√≠a (Archivo Hosts)      11. A√±adir 'Tomar Posesi√≥n' al men√∫ contextual"
    Write-Host "==========================================================================================" -ForegroundColor Cyan
    Write-Host "    [RESTAURACI√ìN SEGURA]                                 [ACCIONES GLOBALES]"
    Write-Host " R1. Restaurar servicios a su estado previo   A. APLICAR TODO (Limpieza y Optimizaci√≥n)"
    Write-Host " R2. Restaurar archivo Hosts original         S. SALIR DEL SCRIPT"
    Write-Host " R3. Restaurar plan de energ√≠a 'Equilibrado' "
    Write-Host "==========================================================================================" -ForegroundColor Cyan
    
    $selection = Read-Host "‚û°Ô∏è  Ingresa tu opci√≥n y presiona Enter"

    switch ($selection.ToUpper()) {
        "1" { Clean-System }
        "2" { Remove-Bloatware }
        "3" { Clear-EventLogs }
        "4" { Update-System }
        "5" { Block-TelemetryHosts }
        "6" { Optimize-Services }
        "7" { Optimize-PerformanceTweaks }
        "8" { Set-VisualEffects }
        "9" { Unlock-UltimatePerformance }
        "10" { Set-FastDNS }
        "11" { Add-TakeOwnership }
        "R1" { Restore-Services }
        "R2" { Restore-HostsFile }
        "R3" { Restore-PowerPlan }
        "A" { 
            Write-Log "Ejecutando todas las optimizaciones de limpieza y rendimiento..." 'Magenta' 'GLOBAL'
            New-SystemRestorePoint
            Clean-System
            Remove-Bloatware
            Clear-EventLogs
            Block-TelemetryHosts
            Optimize-Services
            Optimize-PerformanceTweaks
            Set-VisualEffects
            Unlock-UltimatePerformance
            Write-Log "TODAS LAS TAREAS HAN FINALIZADO. Se recomienda reiniciar." 'Green' 'SYSTEM'
        }
        "S" { Write-Log "Saliendo del script. ¬°Sistema optimizado!"; break }
        default { Write-Log "Opci√≥n no v√°lida. Int√©ntalo de nuevo." 'Red' 'WARN' }
    }
}
#endregion`;const functionDescriptions={Clean_System:{name:"Limpieza Completa del Sistema",description:"Elimina archivos temporales, cach√©s de sistema y navegadores, archivos de Prefetch y vac√≠a la papelera.",usage:"Clean-System"},Remove_Bloatware:{name:"Eliminar Bloatware",description:"Desinstala aplicaciones preinstaladas de Windows y la Microsoft Store que no son esenciales.",usage:"Remove-Bloatware"},Clear_EventLogs:{name:"Limpiar Registros de Eventos",description:"Borra todos los logs de eventos de Windows para liberar espacio y facilitar diagn√≥sticos futuros.",usage:"Clear-EventLogs"},Update_System:{name:"Actualizar Sistema y Apps",description:"Busca e instala las √∫ltimas actualizaciones de Windows y de las aplicaciones instaladas a trav√©s de Winget.",usage:"Update-System"},Block_TelemetryHosts:{name:"Bloquear Telemetr√≠a (Hosts)",description:"Modifica el archivo Hosts para bloquear la comunicaci√≥n con servidores de telemetr√≠a de Microsoft.",usage:"Block-TelemetryHosts"},Optimize_Services:{name:"Optimizar Servicios",description:"Deshabilita servicios no esenciales que consumen recursos. Importante: crea un respaldo para poder restaurarlos.",usage:"Optimize-Services"},Optimize_PerformanceTweaks:{name:"Ajustes de Rendimiento (Registro)",description:"Aplica cambios en el registro para acelerar el apagado del sistema, la respuesta de la interfaz y desactivar la telemetr√≠a.",usage:"Optimize-PerformanceTweaks"},Set_VisualEffects:{name:"Optimizar Efectos Visuales",description:"Configura Windows para 'Mejor Rendimiento', desactivando animaciones y transparencias para una m√°xima fluidez.",usage:"Set-VisualEffects"},Unlock_UltimatePerformance:{name:"Activar Plan 'M√°ximo Rendimiento'",description:"Desbloquea y activa el plan de energ√≠a oculto de m√°ximo rendimiento para exprimir el hardware.",usage:"Unlock-UltimatePerformance"},Set_FastDNS:{name:"Cambiar DNS a Cloudflare",description:"Configura la red para usar los servidores DNS de Cloudflare (1.1.1.1), mejorando la velocidad y privacidad de la navegaci√≥n.",usage:"Set-FastDNS"},Add_TakeOwnership:{name:"A√±adir 'Tomar Posesi√≥n'",description:"Agrega una opci√≥n al men√∫ contextual del clic derecho para tomar control total de archivos y carpetas.",usage:"Add-TakeOwnership"},Restore_Services:{name:"Restaurar Servicios",description:"Restaura los servicios modificados a su estado original utilizando el archivo de respaldo creado previamente.",usage:"Restore-Services"},Restore_HostsFile:{name:"Restaurar Archivo Hosts",description:"Restaura el archivo Hosts a su estado original desde la copia de seguridad.",usage:"Restore-HostsFile"},Restore_PowerPlan:{name:"Restaurar Plan de Energ√≠a",description:"Vuelve a establecer el plan de energ√≠a 'Equilibrado' por defecto de Windows.",usage:"Restore-PowerPlan"}};const themeToggle=document.getElementById('themeToggle'),scriptContentEl=document.getElementById('scriptContent'),searchBox=document.getElementById('searchBox'),searchResults=document.getElementById('searchResults'),functionInfoEl=document.getElementById('functionInfo'),messageBox=document.getElementById('message-box'),copyBtn=document.getElementById('copyBtn'),downloadBtn=document.getElementById('downloadBtn'),stepByStepBtn=document.getElementById('stepByStepBtn'),modal=document.getElementById('stepByStepModal'),modalBody=document.getElementById('modalBody'),modalCloseBtn=document.getElementById('modalCloseBtn');const showMessage=(message,type='success')=>{messageBox.textContent=message;messageBox.className='message-box';messageBox.classList.add(type,'show');setTimeout(()=>messageBox.classList.remove('show'),3000)};const copyScript=()=>{const text=scriptContentText;const textArea=document.createElement('textarea');textArea.value=text;textArea.style.position='fixed';textArea.style.top='-9999px';textArea.style.left='-9999px';document.body.appendChild(textArea);textArea.focus();textArea.select();try{const successful=document.execCommand('copy');showMessage(successful?'‚úîÔ∏è Script copiado al portapapeles.':'‚ùå Error al copiar el script.','error')}catch(err){console.error('Error al ejecutar execCommand: ',err);showMessage('‚ùå Error al copiar el script.','error')}document.body.removeChild(textArea)};const downloadScript=()=>{const blob=new Blob([scriptContentText],{type:'text/plain'}),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download='TITAN_v16.0_Optimizer.ps1';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);showMessage('‚¨áÔ∏è Script descargado correctamente.')};const showStepByStep=()=>{modalBody.innerHTML=`<h2>Pasos de Ejecuci√≥n y Seguridad</h2>
        <p>Este script est√° dise√±ado para ser modular. Puedes elegir qu√© optimizaciones aplicar. Para una ejecuci√≥n segura, sigue estos pasos:</p>
        <ol>
            <li><strong>Ejecutar como Administrador:</strong> Siempre abre una ventana de PowerShell con "Ejecutar como administrador".</li>
            <li><strong>Crear Punto de Restauraci√≥n:</strong> Antes de aplicar cambios mayores (como en la opci√≥n 'A'), Windows crear√° un punto de restauraci√≥n. ¬°No omitas este paso!</li>
            <li><strong>Aplicar Cambios Gradualmente:</strong> Empieza con las opciones de limpieza (1-3) y comprueba que todo funciona bien.</li>
            <li><strong>Utiliza la Restauraci√≥n:</strong> Si alguna optimizaci√≥n (ej. la de servicios) causa problemas con un programa espec√≠fico, usa las opciones de restauraci√≥n (R1-R3) para revertir los cambios.</li>
        </ol>
        <h4>Para ejecutar el script:</h4>
        <pre>1. Descarga el script ('TITAN_v16.0_Optimizer.ps1')
2. Abre PowerShell como Administrador.
3. Si es la primera vez, ejecuta: <strong>Set-ExecutionPolicy RemoteSigned -Force</strong>
4. Navega a la carpeta del script (ej. cd C:\\Users\\TuUsuario\\Downloads)
5. Ejecuta el script: <strong>.\\TITAN_v16.0_Optimizer.ps1</strong>
6. Sigue las instrucciones del men√∫ interactivo.</pre>
        <p><strong>NOTA:</strong> El script crear√° una carpeta 'Titan_Backups' en tu escritorio para guardar respaldos importantes.</p>`;modal.classList.add('show');modalBody.focus()};const closeModal=()=>{modal.classList.remove('show');searchBox.focus()};const highlightFunctions=()=>{let content=scriptContentEl.innerHTML;const functionRegex=/Function (\\w+)/g;content=content.replace(functionRegex,'<span class="function-name" style="color: #60a5fa; cursor: pointer; text-decoration: underline;">Function $1</span>');scriptContentEl.innerHTML=content};const highlightAndScrollToLine=(lineIndex)=>{const lines=scriptContentEl.textContent.split('\\n');const highlightedLines=lines.map((line,index)=>index===lineIndex?`<span class="highlight">${line}</span>`:line);scriptContentEl.innerHTML=highlightedLines.join('\\n');const lineElement=scriptContentEl.querySelector('.highlight');if(lineElement){lineElement.scrollIntoView({behavior:'smooth',block:'center'});setTimeout(()=>{lineElement.outerHTML=lineElement.innerHTML},3000)}};function init(){scriptContentEl.textContent=scriptContentText;highlightFunctions();const savedTheme=localStorage.getItem('theme')||'dark';if(savedTheme==='light'){document.body.classList.add('light-mode');themeToggle.textContent='üåô'}themeToggle.addEventListener('click',()=>{document.body.classList.toggle('light-mode');const isLight=document.body.classList.contains('light-mode');themeToggle.textContent=isLight?'üåô':'üåì';localStorage.setItem('theme',isLight?'light':'dark')});copyBtn.addEventListener('click',copyScript);downloadBtn.addEventListener('click',downloadScript);stepByStepBtn.addEventListener('click',showStepByStep);modalCloseBtn.addEventListener('click',closeModal);modal.addEventListener('click',e=>{if(e.target===modal)closeModal()});document.addEventListener('keydown',e=>{if(e.key==='Escape'&&modal.classList.contains('show'))closeModal()});searchBox.addEventListener('input',e=>{const query=e.target.value.trim().toLowerCase();if(query.length<2){searchResults.style.display='none';return}const lines=scriptContentText.split('\\n');const matches=lines.reduce((acc,line,index)=>{if(line.toLowerCase().includes(query)){acc.push({line:index+1,content:line.trim(),index:index})}return acc},[]);if(matches.length>0){searchResults.innerHTML='';matches.slice(0,10).forEach(match=>{const item=document.createElement('div');item.className='search-result-item';item.setAttribute('role','option');item.textContent=`L√≠nea ${match.line}: ${match.content.substring(0,80)}${match.content.length>80?'...':''}`;item.onclick=()=>{highlightAndScrollToLine(match.index);searchResults.style.display='none';searchBox.value=''};searchResults.appendChild(item)});searchResults.style.display='block'}else{searchResults.style.display='none'}});document.addEventListener('click',e=>{if(!searchBox.contains(e.target)&&!searchResults.contains(e.target)){searchResults.style.display='none'}});scriptContentEl.addEventListener('click',e=>{if(e.target.classList.contains('function-name')){const functionNameWithPrefix='Function ';const targetText=e.target.textContent;if(targetText.startsWith(functionNameWithPrefix)){const functionName=targetText.substring(functionNameWithPrefix.length).trim();const info=functionDescriptions[functionName];if(info){document.getElementById('functionName').textContent=info.name;document.getElementById('functionDescription').textContent=info.description;document.getElementById('functionUsageCode').textContent=info.usage;functionInfoEl.style.display='block';functionInfoEl.scrollIntoView({behavior:'smooth',block:'nearest'})}}}});const focusableElements=[...modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')];modal.addEventListener('keydown',e=>{if(e.key==='Tab'){const first=focusableElements[0],last=focusableElements[focusableElements.length-1];if(e.shiftKey){if(document.activeElement===first){e.preventDefault();last.focus()}}else{if(document.activeElement===last){e.preventDefault();first.focus()}}}})}init()});
    </script>
</body>
</html>

