<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="TITAN v19 APEX - El script de optimización más seguro y potente para Windows">
    <title>TITAN v19 [APEX] - System Optimizer</title>
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Custom Icons (Phosphor Icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        apex: {
                            50: '#f0fdf4',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            900: '#14532d',
                            accent: '#00ff9d',
                            dark: '#0a0a0a',
                            panel: '#121212',
                        }
                    },
                    animation: {
                        'pulse-glow': 'pulse-glow 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        'pulse-glow': {
                            '0%, 100%': { opacity: '0.1' },
                            '50%': { opacity: '0.3' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 5px; border: 2px solid #0a0a0a; }
        ::-webkit-scrollbar-thumb:hover { background: #22c55e; }

        /* Syntax Highlighting */
        pre { counter-reset: line; }
        code { counter-increment: line; }
        
        .glass {
            background: rgba(18, 18, 18, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .line-number::before {
            content: counter(line);
            display: inline-block;
            width: 3.5em;
            margin-right: 1.5em;
            text-align: right;
            color: #4b5563;
            user-select: none;
            font-size: 0.85em;
        }

        /* Syntax Colors (Matrix/Cyberpunk Theme) */
        .syntax-comment { color: #6b7280; font-style: italic; }
        .syntax-string { color: #4ade80; } /* Green */
        .syntax-keyword { color: #c084fc; font-weight: 600; } /* Purple */
        .syntax-function { color: #60a5fa; } /* Blue */
        .syntax-variable { color: #f472b6; } /* Pink */
        .syntax-number { color: #fbbf24; } /* Amber */
        
        ::selection { background: #166534; color: white; }
    </style>
</head>
<body class="bg-[#050505] text-gray-300 antialiased min-h-screen flex flex-col overflow-hidden">

    <!-- Background Decoration -->
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute top-[-10%] left-[20%] w-[500px] h-[500px] bg-apex-600/10 rounded-full blur-[100px] animate-pulse-glow"></div>
        <div class="absolute bottom-[-10%] right-[20%] w-[600px] h-[600px] bg-purple-900/10 rounded-full blur-[120px] animate-pulse-glow" style="animation-delay: 2s;"></div>
        <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wMykiLz48L3N2Zz4=')] opacity-20"></div>
    </div>

    <div class="relative z-10 flex flex-col h-screen max-w-7xl mx-auto p-4 lg:p-6 w-full">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div class="flex items-center gap-4">
                <div class="relative group">
                    <div class="absolute -inset-1 bg-gradient-to-r from-apex-500 to-emerald-600 rounded-xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
                    <div class="relative w-14 h-14 rounded-xl bg-[#111] border border-apex-500/30 flex items-center justify-center">
                        <i class="ph-fill ph-rocket-launch text-apex-400 text-2xl"></i>
                    </div>
                </div>
                <div>
                    <h1 class="text-3xl font-extrabold tracking-tight text-white">TITAN <span class="text-transparent bg-clip-text bg-gradient-to-r from-apex-400 to-emerald-500">v19</span></h1>
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold bg-apex-900/50 text-apex-400 px-2 py-0.5 rounded border border-apex-500/20">APEX EDITION</span>
                        <p class="text-xs text-gray-500 font-mono">SAFE & POWERFUL</p>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3 glass p-1.5 rounded-lg border-gray-800">
                <button id="copyCmdBtn" class="flex items-center gap-2 px-4 py-2 text-xs font-semibold bg-white/5 hover:bg-white/10 text-white rounded transition-all border border-white/5 group">
                    <i class="ph-bold ph-terminal-window group-hover:text-apex-400 transition-colors"></i> 
                    <span>PowerShell Command</span>
                </button>
                <div class="h-6 w-px bg-gray-800"></div>
                <div class="flex gap-1 text-gray-500">
                    <i class="ph-fill ph-windows-logo hover:text-blue-400 transition-colors cursor-help" title="Windows 10/11 Compatible"></i>
                    <i class="ph-fill ph-shield-check hover:text-green-400 transition-colors cursor-help" title="Safe Mode Check included"></i>
                </div>
            </div>
        </header>

        <!-- Main Toolbar -->
        <div class="glass rounded-t-xl p-4 border-b border-gray-800 flex flex-col sm:flex-row gap-4 items-center justify-between bg-[#0f0f0f]">
            <!-- Search -->
            <div class="relative w-full sm:w-96 group">
                <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-600 group-focus-within:text-apex-400 transition-colors"></i>
                <input type="text" id="searchInput" placeholder="Buscar función (ej: 'Network', 'Gaming')..." 
                    class="w-full bg-[#0a0a0a] border border-gray-800 text-sm rounded-lg pl-10 pr-12 py-2.5 focus:ring-1 focus:ring-apex-500 focus:border-apex-500/50 outline-none text-gray-300 placeholder-gray-600 transition-all shadow-inner">
                <span id="matchCount" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs font-mono text-apex-500 hidden bg-apex-900/30 px-1.5 rounded">0</span>
            </div>

            <!-- Actions -->
            <div class="flex gap-3 w-full sm:w-auto">
                <button onclick="copyToClipboard()" class="flex-1 sm:flex-none flex items-center justify-center gap-2 px-5 py-2.5 bg-apex-600 hover:bg-apex-500 text-white rounded-lg font-bold text-sm transition-all shadow-lg shadow-apex-900/50 active:scale-95 border border-apex-400/20">
                    <i class="ph-bold ph-copy"></i> Copiar Script
                </button>
                <button onclick="downloadScript()" class="flex-1 sm:flex-none flex items-center justify-center gap-2 px-5 py-2.5 bg-[#1a1a1a] hover:bg-[#252525] text-gray-300 rounded-lg font-medium text-sm transition-all border border-gray-700 active:scale-95 hover:border-gray-600">
                    <i class="ph-bold ph-download-simple"></i> Descargar .ps1
                </button>
            </div>
        </div>

        <!-- Code Editor Area -->
        <div class="flex-grow relative group rounded-b-xl overflow-hidden glass border-t-0 border-gray-800 shadow-2xl bg-[#0a0a0a]">
            <!-- File Info Badge -->
            <div class="absolute top-0 right-0 z-20 flex text-xs font-mono border-l border-b border-gray-800 rounded-bl-lg overflow-hidden">
                 <div class="bg-[#111] text-gray-400 px-3 py-1.5 border-r border-gray-800">
                    UTF-8
                 </div>
                 <div class="bg-[#111] text-apex-400 px-3 py-1.5 font-bold">
                    TITAN_v19_Apex.ps1
                 </div>
            </div>

            <div class="absolute inset-0 overflow-auto custom-scrollbar" id="codeContainer">
                <pre class="p-6 font-mono text-[14px] leading-6 tab-4 outline-none text-[#d4d4d4]"><code id="codeBlock" class="block min-w-max"></code></pre>
            </div>
        </div>

        <footer class="mt-4 flex justify-between items-center text-xs text-gray-600 font-mono">
            <div>
                <span class="text-apex-500 font-bold">RECOMENDADO:</span> Ejecutar como Administrador.
            </div>
            <div class="flex gap-4">
                <span>Lines: <span id="loc" class="text-gray-400">0</span></span>
                <span>Version: <span class="text-gray-400">19.0.4 (Stable)</span></span>
            </div>
        </footer>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-8 right-8 translate-y-24 opacity-0 transition-all duration-300 z-50">
        <div class="glass bg-[#1a1a1a] border border-gray-700/50 text-white px-5 py-4 rounded-xl shadow-2xl flex items-center gap-4 relative overflow-hidden group">
            <div class="absolute inset-0 bg-gradient-to-r from-apex-600/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
            <div class="w-10 h-10 rounded-full bg-apex-900/30 flex items-center justify-center border border-apex-500/20 text-apex-400">
                <i id="toastIcon" class="ph-fill ph-check-circle text-xl"></i>
            </div>
            <div>
                <h4 id="toastTitle" class="font-bold text-sm text-gray-100">Success</h4>
                <p id="toastMessage" class="text-xs text-gray-400 font-medium">Action completed.</p>
            </div>
        </div>
    </div>

    <script>
        // --- TITAN v19 APEX SCRIPT CONTENT ---
        // Enhanced safety checks, broader browser support, safer debloating.
        // FIX APPLIED: Escaped backticks inside JS template string to prevent syntax errors.
        // FIX APPLIED: Corrected Variable parsing issue with Drive Letters (changed $driveLetter: to ${driveLetter}:)
        const psScript = `# ===================================================================================================
#   TITAN v19 [APEX] - Optimizador de Sistema Seguro
#   Arquitectura: PowerShell 5.1 / 7+ | Objetivo: Windows 10 / 11
#   Seguridad: Alta (System Restore + Safe Mode Checks)
#   
#   CHANGELOG v19:
#   [+] Safety-First: Verificación de Punto de Restauración antes de ejecutar.
#   [+] Clean-Image: Integración segura con DISM para limpiar WinSxS.
#   [+] Browser-Sweep: Soporte añadido para Brave, Firefox y Opera GX.
#   [+] Smart-Debloat: Lista blanca de apps críticas para evitar roturas.
#   [+] Telemetry-Kill: Desactivación segura de telemetría sin romper actualizaciones.
# ===================================================================================================

#region [0] INICIALIZACIÓN Y SEGURIDAD
$ErrorActionPreference = "SilentlyContinue"
$host.UI.RawUI.WindowTitle = "TITAN v19 [APEX] - Optimizando..."
$script:logPath = "$env:USERPROFILE\\Desktop\\Titan_Logs"
$script:logFile = "$script:logPath\\Titan_v19_Run_$(Get-Date -f 'yyyyMMdd_HHmm').log"

# Crear directorios
if (!(Test-Path $script:logPath)) { New-Item -Path $script:logPath -ItemType Directory -Force | Out-Null }

function Write-Log {
    param([string]$Msg, [string]$Type="INFO", [string]$Color="Gray")
    $timestamp = Get-Date -Format "HH:mm:ss"
    Write-Host " [$timestamp] [$Type] $Msg" -ForegroundColor $Color
    Add-Content -Path $script:logFile -Value "[$timestamp] [$Type] $Msg"
}

function Check-Admin {
    $currentPrincipal = New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())
    if (-not $currentPrincipal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
        Write-Host "\`n [!] ERROR CRITICO: TITAN requiere permisos de Administrador." -ForegroundColor Red
        Write-Host " Por favor, clic derecho > Ejecutar como Administrador.\`n" -ForegroundColor Gray
        Start-Sleep -Seconds 5
        exit
    }
}
#endregion

#region [1] UTILIDADES DE SEGURIDAD (SAFETY NET)
function Ensure-SystemRestore {
    Write-Log "Verificando estado de Restaurar Sistema..." "SEC" "Cyan"
    try {
        Enable-ComputerRestore -Drive "C:\" -ErrorAction SilentlyContinue
        Checkpoint-Computer -Description "TITAN v19 - Pre-Optimization" -RestorePointType "MODIFY_SETTINGS" -ErrorAction Stop
        Write-Log "Punto de Restauración creado con éxito." "OK" "Green"
    } catch {
        Write-Log "ADVERTENCIA: No se pudo crear Punto de Restauración." "WARN" "Yellow"
        Write-Log "Continuando bajo su propia responsabilidad..." "WARN" "DarkYellow"
        Start-Sleep -Seconds 2
    }
}
#endregion

#region [2] OPTIMIZACIÓN DE RED (SAFE STACK)
function Optimize-Network {
    Write-Log "Optimizando Pila de Red (TCP/IP)..." "NET" "Magenta"
    
    # Resets seguros
    netsh winsock reset | Out-Null
    netsh int ip reset | Out-Null
    
    # Optimizaciones TCP modernas (compatibles con juegos)
    netsh int tcp set global autotuninglevel=normal | Out-Null
    netsh int tcp set global rss=enabled | Out-Null
    netsh int tcp set global rsc=enabled | Out-Null
    netsh int tcp set global ecncapability=disabled | Out-Null # Disabled evita packet loss en algunos routers
    
    # DNS Flush y renovación
    ipconfig /flushdns | Out-Null
    
    Write-Log "Red optimizada. Winsock reseteado." "OK" "Green"
}
#endregion

#region [3] DISCO Y LIMPIEZA PROFUNDA (SMART CLEAN)
function Optimize-Disks {
    Write-Log "Analizando Unidades de Almacenamiento..." "DSK" "Magenta"
    
    $drives = Get-Volume | Where-Object { $_.DriveType -eq 'Fixed' -and $_.DriveLetter -ne $null }
    
    foreach ($vol in $drives) {
        $driveLetter = $vol.DriveLetter
        # Detección segura de SSD vs HDD
        $physDisk = Get-Partition -DriveLetter $driveLetter | Get-Disk | Select-Object -First 1
        
        if ($physDisk.MediaType -eq 'SSD' -or $physDisk.Model -match 'NVMe|SSD') {
            # FIX: Use braces {} to delimited variable name from colon
            Write-Log "[\${driveLetter}:] SSD/NVMe Detectado -> Ejecutando TRIM" "DSK" "Cyan"
            Optimize-Volume -DriveLetter $driveLetter -ReTrim -Verbose | Out-Null
        } else {
            Write-Log "[\${driveLetter}:] HDD Detectado -> Ejecutando Desfragmentación Inteligente" "DSK" "Yellow"
            Optimize-Volume -DriveLetter $driveLetter -Defrag -Verbose | Out-Null
        }
    }
}

function Deep-Clean {
    Write-Log "Iniciando Limpieza Profunda de Archivos..." "CLN" "Magenta"
    
    # 1. Limpieza de Temporales del Sistema
    $sysFolders = @(
        "$env:TEMP",
        "$env:WINDIR\\Temp",
        "$env:WINDIR\\Prefetch"
    )
    
    # 2. Limpieza de Navegadores (Caché solamente, no cookies/passwords)
    $browserPaths = @(
        "$env:LOCALAPPDATA\\Google\\Chrome\\User Data\\Default\\Cache",
        "$env:LOCALAPPDATA\\Microsoft\\Edge\\User Data\\Default\\Cache",
        "$env:LOCALAPPDATA\\BraveSoftware\\Brave-Browser\\User Data\\Default\\Cache",
        "$env:APPDATA\\Mozilla\\Firefox\\Profiles\\*\\cache2",
        "$env:ROAMING\\Opera Software\\Opera GX Stable\\Cache"
    )

    $allFolders = $sysFolders + $browserPaths

    foreach ($path in $allFolders) {
        if ($path.Contains("*")) {
            # Manejo de wildcards para Firefox
            $expanded = Get-ChildItem -Path $(Split-Path $path -Parent) -ErrorAction SilentlyContinue
            foreach ($sub in $expanded) {
                $target = Join-Path $sub.FullName "cache2"
                if (Test-Path $target) { 
                    Get-ChildItem -Path $target -Recurse -Force | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue 
                }
            }
        } elseif (Test-Path $path) {
            Write-Log "Limpiando: $path" "CLN" "DarkGray"
            Get-ChildItem -Path $path -Recurse -Force | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        }
    }
    
    # 3. Limpieza de Imagen de Windows (WinSxS seguro)
    Write-Log "Limpiando Componentes Antiguos de Windows (DISM)..." "SYS" "Cyan"
    Dism.exe /online /Cleanup-Image /StartComponentCleanup /ResetBase | Out-Null
    
    # 4. Papelera
    Clear-RecycleBin -Force -ErrorAction SilentlyContinue
    
    Write-Log "Limpieza finalizada. Espacio recuperado." "OK" "Green"
}
#endregion

#region [4] GAMING Y RENDIMIENTO (NO-BREAK)
function Optimize-Gaming {
    Write-Log "Aplicando Ajustes de Gaming (Modo Seguro)..." "FPS" "Magenta"
    
    # 1. Plan de Energía 'Alto Rendimiento' (Más seguro que Ultimate)
    # Ultimate a veces causa consumo excesivo en laptops. High Perf es el sweet spot.
    powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c | Out-Null
    
    # 2. Desactivar GameBar (Solo la superposición, no la grabación de fondo si se usa)
    $reg = "HKCU:\\System\\GameConfigStore"
    Set-ItemProperty -Path $reg -Name "GameDVR_Enabled" -Value 0 -Force
    Set-ItemProperty -Path $reg -Name "GameDVR_FSEBehaviorMode" -Value 2 -Force
    
    $reg2 = "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\GameDVR"
    if (!(Test-Path $reg2)) { New-Item $reg2 -Force | Out-Null }
    Set-ItemProperty -Path $reg2 -Name "AllowGameDVR" -Value 0 -Force
    
    # 3. Prioridad GPU
    $gamesKey = "HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Multimedia\\SystemProfile\\Tasks\\Games"
    if (Test-Path $gamesKey) {
        Set-ItemProperty -Path $gamesKey -Name "GPU Priority" -Value 8 -Force
        Set-ItemProperty -Path $gamesKey -Name "Priority" -Value 6 -Force
        Set-ItemProperty -Path $gamesKey -Name "Scheduling Category" -Value "High" -Force
        Set-ItemProperty -Path $gamesKey -Name "SFIO Priority" -Value "High" -Force
    }
    
    Write-Log "Ajustes de Gaming aplicados." "OK" "Green"
}

function Disable-Telemetry {
    Write-Log "Desactivando Telemetría Innecesaria..." "PRIV" "Magenta"
    
    # Solo desactivamos DiagTrack (Experiencias de usuario conectado).
    # NO tocamos servicios críticos de actualización.
    Stop-Service "DiagTrack" -WarningAction SilentlyContinue
    Set-Service "DiagTrack" -StartupType Disabled -ErrorAction SilentlyContinue
    
    # Claves de registro seguras
    $telemetry = "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\DataCollection"
    if (!(Test-Path $telemetry)) { New-Item $telemetry -Force | Out-Null }
    Set-ItemProperty -Path $telemetry -Name "AllowTelemetry" -Value 0 -Force
    
    Write-Log "Telemetría reducida al mínimo seguro." "OK" "Green"
}

function Debloat-Windows-Safe {
    Write-Log "Eliminando Bloatware (Lista Segura)..." "APP" "Magenta"
    # Solo eliminamos apps que NO rompen el sistema.
    # Se mantienen: Calculadora, Fotos, Tienda, Xbox (necesario para algunos juegos).
    $safeBloat = @(
        "*BingWeather*", "*GetHelp*", "*GetStarted*", "*Microsoft3DViewer*", 
        "*MicrosoftSolitaireCollection*", "*OneConnect*", "*People*", 
        "*SkypeApp*", "*WindowsFeedbackHub*", "*ZuneMusic*", "*ZuneVideo*",
        "*Microsoft.News*", "*Microsoft.ToDo*", "*CandyCrush*"
    )
    
    foreach ($app in $safeBloat) {
        Write-Log "Eliminando: $app" "APP" "DarkGray"
        Get-AppxPackage -AllUsers $app | Remove-AppxPackage -ErrorAction SilentlyContinue
    }
    Write-Log "Debloat completado." "OK" "Green"
}
#endregion

#region [MAIN] MENU
Check-Admin
Clear-Host
# Arte ASCII simple para compatibilidad
Write-Host "
  TITAN v19 [APEX] - SAFE OPTIMIZER
  =================================
" -ForegroundColor Green

Write-Log "TITAN v19 inicializado." "SYS" "Cyan"

function Show-Menu {
    Write-Host "----------------------------------------------------" -ForegroundColor DarkGray
    Write-Host " 1. [LIMPIEZA]     Archivos Temp, WinSxS, Caché Navegadores" -ForegroundColor White
    Write-Host " 2. [DEBLOAT]      Eliminar Apps Basura (Modo Seguro)" -ForegroundColor White
    Write-Host " 3. [RED]          Resetear TCP/IP y Flush DNS" -ForegroundColor White
    Write-Host " 4. [GAMING]       FPS Boost, GPU Priority, Power Plan" -ForegroundColor White
    Write-Host " 5. [DISCO]        TRIM (SSD) / Defrag (HDD)" -ForegroundColor White
    Write-Host " 6. [TELEMETRÍA]   Privacidad Básica (Sin romper Updates)" -ForegroundColor White
    Write-Host " --------------------------------------------------" -ForegroundColor DarkGray
    Write-Host " 9. [GOD MODE]     EJECUTAR TODO (Recomendado)" -ForegroundColor Cyan
    Write-Host " Q. [SALIR]        Cerrar TITAN" -ForegroundColor Gray
    Write-Host "----------------------------------------------------" -ForegroundColor DarkGray
}

while ($true) {
    Show-Menu
    $choice = Read-Host " >> Selecciona una opción"
    
    switch ($choice) {
        "1" { Ensure-SystemRestore; Deep-Clean }
        "2" { Ensure-SystemRestore; Debloat-Windows-Safe }
        "3" { Optimize-Network }
        "4" { Ensure-SystemRestore; Optimize-Gaming }
        "5" { Optimize-Disks }
        "6" { Ensure-SystemRestore; Disable-Telemetry }
        "9" { 
            Ensure-SystemRestore
            Deep-Clean
            Debloat-Windows-Safe
            Optimize-Network
            Optimize-Gaming
            Disable-Telemetry
            Optimize-Disks
            Write-Log "OPTIMIZACIÓN COMPLETA. REINICIA TU PC." "FIN" "Green"
        }
        "Q" { exit }
        default { Write-Host "Opción inválida." -ForegroundColor Red }
    }
    Write-Host ""
    Write-Host "Listo. Presiona una tecla para continuar..." -NoNewline
    $null = $host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
    Clear-Host
}
#endregion
`;

        // --- ENGINE DE RESALTADO DE SINTAXIS (MEJORADO) ---
        const syntaxRules = [
            { regex: /#.*/g, class: 'syntax-comment' }, 
            { regex: /"(?:[^"\\]|\\.)*"/g, class: 'syntax-string' },
            { regex: /\b(function|param|if|else|elseif|switch|while|foreach|try|catch|return|exit|process|begin|end)\b/gi, class: 'syntax-keyword' },
            { regex: /\b(Write-Host|Write-Log|Get-Date|New-Item|Test-Path|Out-Null|Get-Volume|Where-Object|Select-Object|Optimize-Volume|Get-ChildItem|Remove-Item|Stop-Service|Set-Service|Start-Service|Clear-RecycleBin|Set-ItemProperty|Get-AppxPackage|Remove-AppxPackage|Read-Host|Clear-Host|Enable-ComputerRestore|Checkpoint-Computer|Split-Path|Join-Path)\b/gi, class: 'syntax-function' },
            { regex: /\$[a-zA-Z0-9_:]+/g, class: 'syntax-variable' },
            { regex: /\b\d+\b/g, class: 'syntax-number' },
            { regex: /\[.*?\]/g, class: 'syntax-keyword' } // Brackets for attributes/sections
        ];

        function highlightCode(code) {
            let highlighted = code
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");

            const placeholders = [];
            const save = (match, cls) => {
                placeholders.push(`<span class="${cls}">${match}</span>`);
                return `%%%${placeholders.length - 1}%%%`;
            };

            syntaxRules.forEach(rule => {
                highlighted = highlighted.replace(rule.regex, (match) => save(match, rule.class));
            });

            highlighted = highlighted.replace(/%%%(\d+)%%%/g, (_, index) => placeholders[index]);

            const lines = highlighted.split('\n');
            document.getElementById('loc').textContent = lines.length;
            
            return lines.map(line => `<span class="line-number opacity-50 select-none border-r border-gray-800 pr-4 mr-4 bg-[#0a0a0a]"></span>${line}`).join('\n');
        }

        // --- INIT ---
        const codeBlock = document.getElementById('codeBlock');
        codeBlock.innerHTML = highlightCode(psScript);

        // --- UTILS ---
        async function copyTextToClipboard(text, successTitle, successMsg, iconClass) {
            try {
                await navigator.clipboard.writeText(text);
                showToast(successTitle, successMsg, iconClass);
            } catch (err) {
                // Fallback for strict context
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.focus();
                ta.select();
                try {
                    document.execCommand('copy');
                    showToast(successTitle, successMsg, iconClass);
                } catch (e) {
                    showToast('Error', 'Manual copy needed', 'ph-warning');
                }
                document.body.removeChild(ta);
            }
        }

        function copyToClipboard() {
            copyTextToClipboard(psScript, 'Copiado', 'Script listo para pegar en PowerShell.', 'ph-check-circle');
        }

        function downloadScript() {
            const blob = new Blob([psScript], { type: 'text/powershell' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'TITAN_v19_Apex.ps1';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast('Descargando', 'TITAN_v19_Apex.ps1', 'ph-download-simple');
        }

        // Search
        const searchInput = document.getElementById('searchInput');
        const matchCount = document.getElementById('matchCount');

        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            if (term.length < 2) {
                codeBlock.innerHTML = highlightCode(psScript);
                matchCount.classList.add('hidden');
                return;
            }

            const lines = psScript.split('\n');
            let matches = 0;
            
            const processedLines = lines.map(line => {
                let htmlLine = line
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
                
                if (line.toLowerCase().includes(term)) {
                    matches++;
                    const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    htmlLine = htmlLine.replace(regex, '<span class="bg-apex-500 text-black font-bold rounded px-1">$1</span>');
                    return `<span class="line-number opacity-50 border-r border-gray-800 pr-4 mr-4"></span><span class="bg-apex-900/30 block w-full border-l-2 border-apex-500 pl-2">${htmlLine}</span>`;
                }
                return `<span class="line-number opacity-20 border-r border-gray-800 pr-4 mr-4"></span><span class="opacity-20 blur-[1px] transition-all hover:blur-0 hover:opacity-100 duration-300">${htmlLine}</span>`;
            }).join('\n');

            codeBlock.innerHTML = processedLines;
            matchCount.textContent = matches;
            matchCount.classList.remove('hidden');
        });

        // Copy CMD Helper
        document.getElementById('copyCmdBtn').addEventListener('click', () => {
             copyTextToClipboard(psScript, 'Comando Copiado', 'Pega en PowerShell como Admin.', 'ph-terminal');
        });

        // Toast
        let toastTimeout;
        function showToast(title, msg, iconClass) {
            const toast = document.getElementById('toast');
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMessage').textContent = msg;
            document.getElementById('toastIcon').className = `ph-fill ${iconClass} text-xl`;

            toast.classList.remove('translate-y-24', 'opacity-0');
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.add('translate-y-24', 'opacity-0');
            }, 3000);
        }
    </script>
</body>
</html>
